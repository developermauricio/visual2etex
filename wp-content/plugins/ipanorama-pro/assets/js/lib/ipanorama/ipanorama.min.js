!function(e,t){(function(F){"use strict";var o="1.6.14",ee=jQuery,te=1e-7,ne=Math.PI/180,ie=180/Math.PI,N=function(){var e=function(){this.init()};e.prototype={init:function(){var e=this||E;return e._counter=1e3,e._html5AudioPool=[],e.html5PoolSize=10,e._codecs={},e._howls=[],e._muted=!1,e._volume=1,e._canPlayEvent="canplaythrough",e._navigator="undefined"!=typeof window&&window.navigator?window.navigator:null,e.masterGain=null,e.noAudio=!1,e.usingWebAudio=!0,e.autoSuspend=!0,e.ctx=null,e.autoUnlock=!0,e._setup(),e},volume:function(e){var t=this||E;if(e=parseFloat(e),t.ctx||d(),void 0!==e&&0<=e&&e<=1){if(t._volume=e,t._muted)return t;t.usingWebAudio&&t.masterGain.gain.setValueAtTime(e,E.ctx.currentTime);for(var n=0;n<t._howls.length;n++)if(!t._howls[n]._webAudio)for(var i=t._howls[n]._getSoundIds(),o=0;o<i.length;o++){var a=t._howls[n]._soundById(i[o]);a&&a._node&&(a._node.volume=a._volume*e)}return t}return t._volume},mute:function(e){var t=this||E;t.ctx||d(),t._muted=e,t.usingWebAudio&&t.masterGain.gain.setValueAtTime(e?0:t._volume,E.ctx.currentTime);for(var n=0;n<t._howls.length;n++)if(!t._howls[n]._webAudio)for(var i=t._howls[n]._getSoundIds(),o=0;o<i.length;o++){var a=t._howls[n]._soundById(i[o]);a&&a._node&&(a._node.muted=!!e||a._muted)}return t},stop:function(){for(var e=this||E,t=0;t<e._howls.length;t++)e._howls[t].stop();return e},unload:function(){for(var e=this||E,t=e._howls.length-1;0<=t;t--)e._howls[t].unload();return e.usingWebAudio&&e.ctx&&void 0!==e.ctx.close&&(e.ctx.close(),e.ctx=null,d()),e},codecs:function(e){return(this||E)._codecs[e.replace(/^x-/,"")]},_setup:function(){var t=this||E;if(t.state=t.ctx&&t.ctx.state||"suspended",t._autoSuspend(),!t.usingWebAudio)if("undefined"!=typeof Audio)try{var e=new Audio;void 0===e.oncanplaythrough&&(t._canPlayEvent="canplay")}catch(e){t.noAudio=!0}else t.noAudio=!0;try{var e=new Audio;e.muted&&(t.noAudio=!0)}catch(e){}return t.noAudio||t._setupCodecs(),t},_setupCodecs:function(){var t=this||E,e=null;try{e="undefined"!=typeof Audio?new Audio:null}catch(e){return t}if(!e||"function"!=typeof e.canPlayType)return t;var n=e.canPlayType("audio/mpeg;").replace(/^no$/,""),i=t._navigator&&t._navigator.userAgent.match(/OPR\/([0-6].)/g),o=i&&parseInt(i[0].split("/")[1],10)<33;return t._codecs={mp3:!(o||!n&&!e.canPlayType("audio/mp3;").replace(/^no$/,"")),mpeg:!!n,opus:!!e.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!e.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!e.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(e.canPlayType('audio/wav; codecs="1"')||e.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!e.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!e.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(e.canPlayType("audio/x-m4a;")||e.canPlayType("audio/m4a;")||e.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(e.canPlayType("audio/x-m4b;")||e.canPlayType("audio/m4b;")||e.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(e.canPlayType("audio/x-mp4;")||e.canPlayType("audio/mp4;")||e.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!e.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,""),webm:!!e.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,""),dolby:!!e.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(e.canPlayType("audio/x-flac;")||e.canPlayType("audio/flac;")).replace(/^no$/,"")},t},_unlockAudio:function(){var s=this||E;if(!s._audioUnlocked&&s.ctx){s._audioUnlocked=!1,s.autoUnlock=!1,s._mobileUnloaded||44100===s.ctx.sampleRate||(s._mobileUnloaded=!0,s.unload()),s._scratchBuffer=s.ctx.createBuffer(1,1,22050);var c=function(e){for(;s._html5AudioPool.length<s.html5PoolSize;)try{var t=new Audio;t._unlocked=!0,s._releaseHtml5Audio(t)}catch(e){s.noAudio=!0;break}for(var n=0;n<s._howls.length;n++)if(!s._howls[n]._webAudio)for(var i=s._howls[n]._getSoundIds(),o=0;o<i.length;o++){var a=s._howls[n]._soundById(i[o]);a&&a._node&&!a._node._unlocked&&(a._node._unlocked=!0,a._node.load())}s._autoResume();var r=s.ctx.createBufferSource();r.buffer=s._scratchBuffer,r.connect(s.ctx.destination),void 0===r.start?r.noteOn(0):r.start(0),"function"==typeof s.ctx.resume&&s.ctx.resume(),r.onended=function(){r.disconnect(0),s._audioUnlocked=!0,document.removeEventListener("touchstart",c,!0),document.removeEventListener("touchend",c,!0),document.removeEventListener("click",c,!0);for(var e=0;e<s._howls.length;e++)s._howls[e]._emit("unlock")}};return document.addEventListener("touchstart",c,!0),document.addEventListener("touchend",c,!0),document.addEventListener("click",c,!0),s}},_obtainHtml5Audio:function(){var e=this||E;if(e._html5AudioPool.length)return e._html5AudioPool.pop();var t=(new Audio).play();return t&&"undefined"!=typeof Promise&&(t instanceof Promise||"function"==typeof t.then)&&t.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(e){var t=this||E;return e._unlocked&&t._html5AudioPool.push(e),t},_autoSuspend:function(){var t=this;if(t.autoSuspend&&t.ctx&&void 0!==t.ctx.suspend&&E.usingWebAudio){for(var e=0;e<t._howls.length;e++)if(t._howls[e]._webAudio)for(var n=0;n<t._howls[e]._sounds.length;n++)if(!t._howls[e]._sounds[n]._paused)return t;return t._suspendTimer&&clearTimeout(t._suspendTimer),t._suspendTimer=setTimeout(function(){if(t.autoSuspend){t._suspendTimer=null,t.state="suspending";var e=function(){t.state="suspended",t._resumeAfterSuspend&&(delete t._resumeAfterSuspend,t._autoResume())};t.ctx.suspend().then(e,e)}},3e4),t}},_autoResume:function(){var t=this;if(t.ctx&&void 0!==t.ctx.resume&&E.usingWebAudio)return"running"===t.state&&"interrupted"!==t.ctx.state&&t._suspendTimer?(clearTimeout(t._suspendTimer),t._suspendTimer=null):"suspended"===t.state||"running"===t.state&&"interrupted"===t.ctx.state?(t.ctx.resume().then(function(){t.state="running";for(var e=0;e<t._howls.length;e++)t._howls[e]._emit("resume")}),t._suspendTimer&&(clearTimeout(t._suspendTimer),t._suspendTimer=null)):"suspending"===t.state&&(t._resumeAfterSuspend=!0),t}};var E=new e,t=function(e){e.src&&0!==e.src.length?this.init(e):console.error("An array of source files must be passed with any new Howl.")};t.prototype={init:function(e){var t=this;return E.ctx||d(),t._autoplay=e.autoplay||!1,t._format="string"!=typeof e.format?e.format:[e.format],t._html5=e.html5||!1,t._muted=e.mute||!1,t._loop=e.loop||!1,t._pool=e.pool||5,t._preload="boolean"!=typeof e.preload&&"metadata"!==e.preload||e.preload,t._rate=e.rate||1,t._sprite=e.sprite||{},t._src="string"!=typeof e.src?e.src:[e.src],t._volume=void 0!==e.volume?e.volume:1,t._xhr={method:e.xhr&&e.xhr.method?e.xhr.method:"GET",headers:e.xhr&&e.xhr.headers?e.xhr.headers:null,withCredentials:!(!e.xhr||!e.xhr.withCredentials)&&e.xhr.withCredentials},t._duration=0,t._state="unloaded",t._sounds=[],t._endTimers={},t._queue=[],t._playLock=!1,t._onend=e.onend?[{fn:e.onend}]:[],t._onfade=e.onfade?[{fn:e.onfade}]:[],t._onload=e.onload?[{fn:e.onload}]:[],t._onloaderror=e.onloaderror?[{fn:e.onloaderror}]:[],t._onplayerror=e.onplayerror?[{fn:e.onplayerror}]:[],t._onpause=e.onpause?[{fn:e.onpause}]:[],t._onplay=e.onplay?[{fn:e.onplay}]:[],t._onstop=e.onstop?[{fn:e.onstop}]:[],t._onmute=e.onmute?[{fn:e.onmute}]:[],t._onvolume=e.onvolume?[{fn:e.onvolume}]:[],t._onrate=e.onrate?[{fn:e.onrate}]:[],t._onseek=e.onseek?[{fn:e.onseek}]:[],t._onunlock=e.onunlock?[{fn:e.onunlock}]:[],t._onresume=[],t._webAudio=E.usingWebAudio&&!t._html5,void 0!==E.ctx&&E.ctx&&E.autoUnlock&&E._unlockAudio(),E._howls.push(t),t._autoplay&&t._queue.push({event:"play",action:function(){t.play()}}),t._preload&&"none"!==t._preload&&t.load(),t},load:function(){var e=this,t=null;if(E.noAudio)e._emit("loaderror",null,"No audio support.");else{"string"==typeof e._src&&(e._src=[e._src]);for(var n=0;n<e._src.length;n++){var i,o;if(e._format&&e._format[n])i=e._format[n];else{if("string"!=typeof(o=e._src[n])){e._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}(i=/^data:audio\/([^;,]+);/i.exec(o))||(i=/\.([^.]+)$/.exec(o.split("?",1)[0])),i&&(i=i[1].toLowerCase())}if(i||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),i&&E.codecs(i)){t=e._src[n];break}}if(t)return e._src=t,e._state="loading","https:"===window.location.protocol&&"http:"===t.slice(0,5)&&(e._html5=!0,e._webAudio=!1),new a(e),e._webAudio&&s(e),e;e._emit("loaderror",null,"No codec support for selected audio sources.")}},play:function(t,n){var i=this,e=null;if("number"==typeof t)e=t,t=null;else{if("string"==typeof t&&"loaded"===i._state&&!i._sprite[t])return null;if(void 0===t&&(t="__default",!i._playLock)){for(var o=0,a=0;a<i._sounds.length;a++)i._sounds[a]._paused&&!i._sounds[a]._ended&&(o++,e=i._sounds[a]._id);1===o?t=null:e=null}}var r=e?i._soundById(e):i._inactiveSound();if(!r)return null;if(e&&!t&&(t=r._sprite||"__default"),"loaded"!==i._state){r._sprite=t,r._ended=!1;var s=r._id;return i._queue.push({event:"play",action:function(){i.play(s)}}),s}if(e&&!r._paused)return n||i._loadQueue("play"),r._id;i._webAudio&&E._autoResume();var c=Math.max(0,0<r._seek?r._seek:i._sprite[t][0]/1e3),l=Math.max(0,(i._sprite[t][0]+i._sprite[t][1])/1e3-c),u=1e3*l/Math.abs(r._rate),d=i._sprite[t][0]/1e3,h=(i._sprite[t][0]+i._sprite[t][1])/1e3;r._sprite=t,r._ended=!1;var m=function(){r._paused=!1,r._seek=c,r._start=d,r._stop=h,r._loop=!(!r._loop&&!i._sprite[t][2])};if(!(h<=c)){var p=r._node;if(i._webAudio){var f=function(){i._playLock=!1,m(),i._refreshBuffer(r);var e=r._muted||i._muted?0:r._volume;p.gain.setValueAtTime(e,E.ctx.currentTime),r._playStart=E.ctx.currentTime,void 0===p.bufferSource.start?r._loop?p.bufferSource.noteGrainOn(0,c,86400):p.bufferSource.noteGrainOn(0,c,l):r._loop?p.bufferSource.start(0,c,86400):p.bufferSource.start(0,c,l),u!==1/0&&(i._endTimers[r._id]=setTimeout(i._ended.bind(i,r),u)),n||setTimeout(function(){i._emit("play",r._id),i._loadQueue()},0)};"running"===E.state&&"interrupted"!==E.ctx.state?f():(i._playLock=!0,i.once("resume",f),i._clearTimer(r._id))}else{var v=function(){p.currentTime=c,p.muted=r._muted||i._muted||E._muted||p.muted,p.volume=r._volume*E.volume(),p.playbackRate=r._rate;try{var e=p.play();if(e&&"undefined"!=typeof Promise&&(e instanceof Promise||"function"==typeof e.then)?(i._playLock=!0,m(),e.then(function(){i._playLock=!1,p._unlocked=!0,n||(i._emit("play",r._id),i._loadQueue())}).catch(function(){i._playLock=!1,i._emit("playerror",r._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),r._ended=!0,r._paused=!0})):n||(i._playLock=!1,m(),i._emit("play",r._id),i._loadQueue()),p.playbackRate=r._rate,p.paused)return void i._emit("playerror",r._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");"__default"!==t||r._loop?i._endTimers[r._id]=setTimeout(i._ended.bind(i,r),u):(i._endTimers[r._id]=function(){i._ended(r),p.removeEventListener("ended",i._endTimers[r._id],!1)},p.addEventListener("ended",i._endTimers[r._id],!1))}catch(e){i._emit("playerror",r._id,e)}};"data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"===p.src&&(p.src=i._src,p.load());var g=window&&window.ejecta||!p.readyState&&E._navigator.isCocoonJS;if(3<=p.readyState||g)v();else{i._playLock=!0;var w=function(){v(),p.removeEventListener(E._canPlayEvent,w,!1)};p.addEventListener(E._canPlayEvent,w,!1),i._clearTimer(r._id)}}return r._id}i._ended(r)},pause:function(e){var t=this;if("loaded"!==t._state||t._playLock)return t._queue.push({event:"pause",action:function(){t.pause(e)}}),t;for(var n=t._getSoundIds(e),i=0;i<n.length;i++){t._clearTimer(n[i]);var o=t._soundById(n[i]);if(o&&!o._paused&&(o._seek=t.seek(n[i]),o._rateSeek=0,o._paused=!0,t._stopFade(n[i]),o._node))if(t._webAudio){if(!o._node.bufferSource)continue;void 0===o._node.bufferSource.stop?o._node.bufferSource.noteOff(0):o._node.bufferSource.stop(0),t._cleanBuffer(o._node)}else isNaN(o._node.duration)&&o._node.duration!==1/0||o._node.pause();arguments[1]||t._emit("pause",o?o._id:null)}return t},stop:function(e,t){var n=this;if("loaded"!==n._state||n._playLock)return n._queue.push({event:"stop",action:function(){n.stop(e)}}),n;for(var i=n._getSoundIds(e),o=0;o<i.length;o++){n._clearTimer(i[o]);var a=n._soundById(i[o]);a&&(a._seek=a._start||0,a._rateSeek=0,a._paused=!0,a._ended=!0,n._stopFade(i[o]),a._node&&(n._webAudio?a._node.bufferSource&&(void 0===a._node.bufferSource.stop?a._node.bufferSource.noteOff(0):a._node.bufferSource.stop(0),n._cleanBuffer(a._node)):isNaN(a._node.duration)&&a._node.duration!==1/0||(a._node.currentTime=a._start||0,a._node.pause(),a._node.duration===1/0&&n._clearSound(a._node))),t||n._emit("stop",a._id))}return n},mute:function(e,t){var n=this;if("loaded"!==n._state||n._playLock)return n._queue.push({event:"mute",action:function(){n.mute(e,t)}}),n;if(void 0===t){if("boolean"!=typeof e)return n._muted;n._muted=e}for(var i=n._getSoundIds(t),o=0;o<i.length;o++){var a=n._soundById(i[o]);a&&(a._muted=e,a._interval&&n._stopFade(a._id),n._webAudio&&a._node?a._node.gain.setValueAtTime(e?0:a._volume,E.ctx.currentTime):a._node&&(a._node.muted=!!E._muted||e),n._emit("mute",a._id))}return n},volume:function(){var e,t,n,i=this,o=arguments;if(0===o.length)return i._volume;if(1===o.length||2===o.length&&void 0===o[1]){var a=i._getSoundIds(),r=a.indexOf(o[0]);0<=r?t=parseInt(o[0],10):e=parseFloat(o[0])}else 2<=o.length&&(e=parseFloat(o[0]),t=parseInt(o[1],10));if(!(void 0!==e&&0<=e&&e<=1))return(n=t?i._soundById(t):i._sounds[0])?n._volume:0;if("loaded"!==i._state||i._playLock)return i._queue.push({event:"volume",action:function(){i.volume.apply(i,o)}}),i;void 0===t&&(i._volume=e),t=i._getSoundIds(t);for(var s=0;s<t.length;s++)(n=i._soundById(t[s]))&&(n._volume=e,o[2]||i._stopFade(t[s]),i._webAudio&&n._node&&!n._muted?n._node.gain.setValueAtTime(e,E.ctx.currentTime):n._node&&!n._muted&&(n._node.volume=e*E.volume()),i._emit("volume",n._id));return i},fade:function(e,t,n,i){var o=this;if("loaded"!==o._state||o._playLock)return o._queue.push({event:"fade",action:function(){o.fade(e,t,n,i)}}),o;e=Math.min(Math.max(0,parseFloat(e)),1),t=Math.min(Math.max(0,parseFloat(t)),1),n=parseFloat(n),o.volume(e,i);for(var a=o._getSoundIds(i),r=0;r<a.length;r++){var s=o._soundById(a[r]);if(s){if(i||o._stopFade(a[r]),o._webAudio&&!s._muted){var c=E.ctx.currentTime,l=c+n/1e3;s._volume=e,s._node.gain.setValueAtTime(e,c),s._node.gain.linearRampToValueAtTime(t,l)}o._startFadeInterval(s,e,t,n,a[r],void 0===i)}}return o},_startFadeInterval:function(t,n,i,o,e,a){var r=this,s=n,c=i-n,l=Math.abs(c/.01),u=Math.max(4,0<l?o/l:o),d=Date.now();t._fadeTo=i,t._interval=setInterval(function(){var e=(Date.now()-d)/o;d=Date.now(),s+=c*e,s=Math.round(100*s)/100,s=c<0?Math.max(i,s):Math.min(i,s),r._webAudio?t._volume=s:r.volume(s,t._id,!0),a&&(r._volume=s),(i<n&&s<=i||n<i&&i<=s)&&(clearInterval(t._interval),t._interval=null,t._fadeTo=null,r.volume(i,t._id),r._emit("fade",t._id))},u)},_stopFade:function(e){var t=this,n=t._soundById(e);return n&&n._interval&&(t._webAudio&&n._node.gain.cancelScheduledValues(E.ctx.currentTime),clearInterval(n._interval),n._interval=null,t.volume(n._fadeTo,e),n._fadeTo=null,t._emit("fade",e)),t},loop:function(){var e,t,n,i=this,o=arguments;if(0===o.length)return i._loop;if(1===o.length){if("boolean"!=typeof o[0])return!!(n=i._soundById(parseInt(o[0],10)))&&n._loop;e=o[0],i._loop=e}else 2===o.length&&(e=o[0],t=parseInt(o[1],10));for(var a=i._getSoundIds(t),r=0;r<a.length;r++)(n=i._soundById(a[r]))&&(n._loop=e,i._webAudio&&n._node&&n._node.bufferSource&&(n._node.bufferSource.loop=e)&&(n._node.bufferSource.loopStart=n._start||0,n._node.bufferSource.loopEnd=n._stop));return i},rate:function(){var e,t,n,i=this,o=arguments;if(0===o.length)t=i._sounds[0]._id;else if(1===o.length){var a=i._getSoundIds(),r=a.indexOf(o[0]);0<=r?t=parseInt(o[0],10):e=parseFloat(o[0])}else 2===o.length&&(e=parseFloat(o[0]),t=parseInt(o[1],10));if("number"!=typeof e)return(n=i._soundById(t))?n._rate:i._rate;if("loaded"!==i._state||i._playLock)return i._queue.push({event:"rate",action:function(){i.rate.apply(i,o)}}),i;void 0===t&&(i._rate=e),t=i._getSoundIds(t);for(var s=0;s<t.length;s++)if(n=i._soundById(t[s])){i.playing(t[s])&&(n._rateSeek=i.seek(t[s]),n._playStart=i._webAudio?E.ctx.currentTime:n._playStart),n._rate=e,i._webAudio&&n._node&&n._node.bufferSource?n._node.bufferSource.playbackRate.setValueAtTime(e,E.ctx.currentTime):n._node&&(n._node.playbackRate=e);var c=i.seek(t[s]),l=(i._sprite[n._sprite][0]+i._sprite[n._sprite][1])/1e3-c,u=1e3*l/Math.abs(n._rate);!i._endTimers[t[s]]&&n._paused||(i._clearTimer(t[s]),i._endTimers[t[s]]=setTimeout(i._ended.bind(i,n),u)),i._emit("rate",n._id)}return i},seek:function(){var e,t,n=this,i=arguments;if(0===i.length)t=n._sounds[0]._id;else if(1===i.length){var o=n._getSoundIds(),a=o.indexOf(i[0]);0<=a?t=parseInt(i[0],10):n._sounds.length&&(t=n._sounds[0]._id,e=parseFloat(i[0]))}else 2===i.length&&(e=parseFloat(i[0]),t=parseInt(i[1],10));if(void 0===t)return n;if("number"==typeof e&&("loaded"!==n._state||n._playLock))return n._queue.push({event:"seek",action:function(){n.seek.apply(n,i)}}),n;var r=n._soundById(t);if(r){if(!("number"==typeof e&&0<=e)){if(n._webAudio){var s=n.playing(t)?E.ctx.currentTime-r._playStart:0,c=r._rateSeek?r._rateSeek-r._seek:0;return r._seek+(c+s*Math.abs(r._rate))}return r._node.currentTime}var l=n.playing(t);l&&n.pause(t,!0),r._seek=e,r._ended=!1,n._clearTimer(t),n._webAudio||!r._node||isNaN(r._node.duration)||(r._node.currentTime=e);var u=function(){n._emit("seek",t),l&&n.play(t,!0)};if(l&&!n._webAudio){var d=function(){n._playLock?setTimeout(d,0):u()};setTimeout(d,0)}else u()}return n},playing:function(e){if("number"==typeof e){var t=this._soundById(e);return!!t&&!t._paused}for(var n=0;n<this._sounds.length;n++)if(!this._sounds[n]._paused)return!0;return!1},duration:function(e){var t=this._duration,n=this._soundById(e);return n&&(t=this._sprite[n._sprite][1]/1e3),t},state:function(){return this._state},unload:function(){for(var e=this,t=e._sounds,n=0;n<t.length;n++)t[n]._paused||e.stop(t[n]._id),e._webAudio||(e._clearSound(t[n]._node),t[n]._node.removeEventListener("error",t[n]._errorFn,!1),t[n]._node.removeEventListener(E._canPlayEvent,t[n]._loadFn,!1),t[n]._node.removeEventListener("ended",t[n]._endFn,!1),E._releaseHtml5Audio(t[n]._node)),delete t[n]._node,e._clearTimer(t[n]._id);var i=E._howls.indexOf(e);0<=i&&E._howls.splice(i,1);var o=!0;for(n=0;n<E._howls.length;n++)if(E._howls[n]._src===e._src||0<=e._src.indexOf(E._howls[n]._src)){o=!1;break}return r&&o&&delete r[e._src],E.noAudio=!1,e._state="unloaded",e._sounds=[],e=null},on:function(e,t,n,i){var o=this["_on"+e];return"function"==typeof t&&o.push(i?{id:n,fn:t,once:i}:{id:n,fn:t}),this},off:function(e,t,n){var i=this,o=i["_on"+e],a=0;if("number"==typeof t&&(n=t,t=null),t||n)for(a=0;a<o.length;a++){var r=n===o[a].id;if(t===o[a].fn&&r||!t&&r){o.splice(a,1);break}}else if(e)i["_on"+e]=[];else{var s=Object.keys(i);for(a=0;a<s.length;a++)0===s[a].indexOf("_on")&&Array.isArray(i[s[a]])&&(i[s[a]]=[])}return i},once:function(e,t,n){return this.on(e,t,n,1),this},_emit:function(e,t,n){for(var i=this,o=i["_on"+e],a=o.length-1;0<=a;a--)o[a].id&&o[a].id!==t&&"load"!==e||(setTimeout(function(e){e.call(this,t,n)}.bind(i,o[a].fn),0),o[a].once&&i.off(e,o[a].fn,o[a].id));return i._loadQueue(e),i},_loadQueue:function(e){var t=this;if(0<t._queue.length){var n=t._queue[0];n.event===e&&(t._queue.shift(),t._loadQueue()),e||n.action()}return t},_ended:function(e){var t=this,n=e._sprite;if(!t._webAudio&&e._node&&!e._node.paused&&!e._node.ended&&e._node.currentTime<e._stop)return setTimeout(t._ended.bind(t,e),100),t;var i=!(!e._loop&&!t._sprite[n][2]);if(t._emit("end",e._id),!t._webAudio&&i&&t.stop(e._id,!0).play(e._id),t._webAudio&&i){t._emit("play",e._id),e._seek=e._start||0,e._rateSeek=0,e._playStart=E.ctx.currentTime;var o=1e3*(e._stop-e._start)/Math.abs(e._rate);t._endTimers[e._id]=setTimeout(t._ended.bind(t,e),o)}return t._webAudio&&!i&&(e._paused=!0,e._ended=!0,e._seek=e._start||0,e._rateSeek=0,t._clearTimer(e._id),t._cleanBuffer(e._node),E._autoSuspend()),t._webAudio||i||t.stop(e._id,!0),t},_clearTimer:function(e){var t=this;if(t._endTimers[e]){if("function"!=typeof t._endTimers[e])clearTimeout(t._endTimers[e]);else{var n=t._soundById(e);n&&n._node&&n._node.removeEventListener("ended",t._endTimers[e],!1)}delete t._endTimers[e]}return t},_soundById:function(e){for(var t=0;t<this._sounds.length;t++)if(e===this._sounds[t]._id)return this._sounds[t];return null},_inactiveSound:function(){var e=this;e._drain();for(var t=0;t<e._sounds.length;t++)if(e._sounds[t]._ended)return e._sounds[t].reset();return new a(e)},_drain:function(){var e=this,t=e._pool,n=0,i=0;if(!(e._sounds.length<t)){for(i=0;i<e._sounds.length;i++)e._sounds[i]._ended&&n++;for(i=e._sounds.length-1;0<=i;i--){if(n<=t)return;e._sounds[i]._ended&&(e._webAudio&&e._sounds[i]._node&&e._sounds[i]._node.disconnect(0),e._sounds.splice(i,1),n--)}}},_getSoundIds:function(e){if(void 0!==e)return[e];for(var t=[],n=0;n<this._sounds.length;n++)t.push(this._sounds[n]._id);return t},_refreshBuffer:function(e){return e._node.bufferSource=E.ctx.createBufferSource(),e._node.bufferSource.buffer=r[this._src],e._panner?e._node.bufferSource.connect(e._panner):e._node.bufferSource.connect(e._node),e._node.bufferSource.loop=e._loop,e._loop&&(e._node.bufferSource.loopStart=e._start||0,e._node.bufferSource.loopEnd=e._stop||0),e._node.bufferSource.playbackRate.setValueAtTime(e._rate,E.ctx.currentTime),this},_cleanBuffer:function(e){var t=E._navigator&&0<=E._navigator.vendor.indexOf("Apple");if(E._scratchBuffer&&e.bufferSource&&(e.bufferSource.onended=null,e.bufferSource.disconnect(0),t))try{e.bufferSource.buffer=E._scratchBuffer}catch(e){}return e.bufferSource=null,this},_clearSound:function(e){var t=/MSIE |Trident\//.test(E._navigator&&E._navigator.userAgent);t||(e.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var a=function(e){this._parent=e,this.init()};a.prototype={init:function(){var e=this,t=e._parent;return e._muted=t._muted,e._loop=t._loop,e._volume=t._volume,e._rate=t._rate,e._seek=0,e._paused=!0,e._ended=!0,e._sprite="__default",e._id=++E._counter,t._sounds.push(e),e.create(),e},create:function(){var e=this,t=e._parent,n=E._muted||e._muted||e._parent._muted?0:e._volume;return t._webAudio?(e._node=void 0===E.ctx.createGain?E.ctx.createGainNode():E.ctx.createGain(),e._node.gain.setValueAtTime(n,E.ctx.currentTime),e._node.paused=!0,e._node.connect(E.masterGain)):E.noAudio||(e._node=E._obtainHtml5Audio(),e._errorFn=e._errorListener.bind(e),e._node.addEventListener("error",e._errorFn,!1),e._loadFn=e._loadListener.bind(e),e._node.addEventListener(E._canPlayEvent,e._loadFn,!1),e._endFn=e._endListener.bind(e),e._node.addEventListener("ended",e._endFn,!1),e._node.src=t._src,e._node.preload=!0===t._preload?"auto":t._preload,e._node.volume=n*E.volume(),e._node.load()),e},reset:function(){var e=this,t=e._parent;return e._muted=t._muted,e._loop=t._loop,e._volume=t._volume,e._rate=t._rate,e._seek=0,e._rateSeek=0,e._paused=!0,e._ended=!0,e._sprite="__default",e._id=++E._counter,e},_errorListener:function(){var e=this;e._parent._emit("loaderror",e._id,e._node.error?e._node.error.code:0),e._node.removeEventListener("error",e._errorFn,!1)},_loadListener:function(){var e=this._parent;e._duration=this._node.duration,0===Object.keys(e._sprite).length&&(e._sprite={__default:[0,1e3*e._duration]}),"loaded"!==e._state&&(e._state="loaded",e._emit("load"),e._loadQueue()),this._node.removeEventListener(E._canPlayEvent,this._loadFn,!1)},_endListener:function(){var e=this,t=e._parent;t._duration===1/0&&(t._duration=e._node.duration,t._sprite.__default[1]===1/0&&(t._sprite.__default[1]=1e3*t._duration),t._ended(e)),e._node.removeEventListener("ended",e._endFn,!1)}};var r={},s=function(t){var e=t._src;if(r[e])return t._duration=r[e].duration,void u(t);if(/^data:[^;]+;base64,/.test(e)){for(var n=atob(e.split(",")[1]),i=new Uint8Array(n.length),o=0;o<n.length;++o)i[o]=n.charCodeAt(o);l(i.buffer,t)}else{var a=new XMLHttpRequest;a.open(t._xhr.method,e,!0),a.withCredentials=t._xhr.withCredentials,a.responseType="arraybuffer",t._xhr.headers&&Object.keys(t._xhr.headers).forEach(function(e){a.setRequestHeader(e,t._xhr.headers[e])}),a.onload=function(){var e=(a.status+"")[0];"0"===e||"2"===e||"3"===e?l(a.response,t):t._emit("loaderror",null,"Failed loading audio file with status: "+a.status+".")},a.onerror=function(){t._webAudio&&(t._html5=!0,t._webAudio=!1,t._sounds=[],delete r[e],t.load())},c(a)}},c=function(t){try{t.send()}catch(e){t.onerror()}},l=function(e,t){var n=function(){t._emit("loaderror",null,"Decoding audio data failed.")},i=function(e){e&&0<t._sounds.length?(r[t._src]=e,u(t,e)):n()};"undefined"!=typeof Promise&&1===E.ctx.decodeAudioData.length?E.ctx.decodeAudioData(e).then(i).catch(n):E.ctx.decodeAudioData(e,i,n)},u=function(e,t){t&&!e._duration&&(e._duration=t.duration),0===Object.keys(e._sprite).length&&(e._sprite={__default:[0,1e3*e._duration]}),"loaded"!==e._state&&(e._state="loaded",e._emit("load"),e._loadQueue())},d=function(){if(E.usingWebAudio){try{"undefined"!=typeof AudioContext?E.ctx=new AudioContext:"undefined"!=typeof webkitAudioContext?E.ctx=new webkitAudioContext:E.usingWebAudio=!1}catch(e){E.usingWebAudio=!1}E.ctx||(E.usingWebAudio=!1);var e=/iP(hone|od|ad)/.test(E._navigator&&E._navigator.platform),t=E._navigator&&E._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),n=t?parseInt(t[1],10):null;if(e&&n&&n<9){var i=/safari/.test(E._navigator&&E._navigator.userAgent.toLowerCase());E._navigator&&!i&&(E.usingWebAudio=!1)}E.usingWebAudio&&(E.masterGain=void 0===E.ctx.createGain?E.ctx.createGainNode():E.ctx.createGain(),E.masterGain.gain.setValueAtTime(E._muted?0:E._volume,E.ctx.currentTime),E.masterGain.connect(E.ctx.destination)),E._setup()}};return{Howler:E,Howl:t}}(),oe=(i=[],{getAll:function(){return i},removeAll:function(){i=[]},add:function(e){i.push(e)},remove:function(e){var t=i.indexOf(e);-1!==t&&i.splice(t,1)},update:function(e,t){if(0===i.length)return!1;var n=0;for(e=void 0!==e?e:oe.now();n<i.length;)i[n].update(e)||t?n++:i.splice(n,1);return!0}});var i;"undefined"==typeof window&&"undefined"!=typeof process?oe.now=function(){var e=process.hrtime();return 1e3*e[0]+e[1]/1e6}:"undefined"!=typeof window&&void 0!==window.performance&&void 0!==window.performance.now?oe.now=window.performance.now.bind(window.performance):void 0!==Date.now?oe.now=Date.now:oe.now=function(){return(new Date).getTime()};oe.Tween=function(e){var l,u=e,d={},h={},m={},p=1e3,f=0,v=!1,n=!1,g=!1,w=0,E=null,i=!1,t=null,y=oe.Easing.Linear.None,b=oe.Interpolation.Linear,_=[],T=null,x=!1,R=null,M=null,o=null;this.isPlaying=function(){return n},this.isPaused=function(){return i},this.to=function(e,t){return h=e,void 0!==t&&(p=t),this},this.start=function(e){for(var t in oe.add(this),x=i=!(n=!0),E=void 0!==e?e:oe.now(),E+=w,h){if(h[t]instanceof Array){if(0===h[t].length)continue;h[t]=[u[t]].concat(h[t])}void 0!==u[t]&&(d[t]=u[t],d[t]instanceof Array==!1&&(d[t]*=1),m[t]=d[t]||0)}return this},this.stop=function(){return n&&(oe.remove(this),i=n=!1,null!==o&&o.call(u,u),this.stopChainedTweens()),this},this.end=function(){return this.update(E+p),this},this.stopChainedTweens=function(){for(var e=0,t=_.length;e<t;e++)_[e].stop()},this.delay=function(e){return w=e,this},this.pause=function(){i||(i=!0,t=(new Date).getTime(),oe.remove(this))},this.play=function(){if(i){i=!1;var e=(new Date).getTime();E+=e-t,oe.add(this)}},this.repeat=function(e){return f=e,this},this.repeatDelay=function(e){return l=e,this},this.yoyo=function(e){return v=e,this},this.easing=function(e){return y=e,this},this.interpolation=function(e){return b=e,this},this.chain=function(){return _=arguments,this},this.onStart=function(e){return T=e,this},this.onUpdate=function(e){return R=e,this},this.onComplete=function(e){return M=e,this},this.onStop=function(e){return o=e,this},this.update=function(e){var t,n,i;if(e<E)return!0;for(t in!1===x&&(null!==T&&T.call(u,u),x=!0),i=y(n=1<(n=(e-E)/p)?1:n),h)if(void 0!==d[t]){var o=d[t]||0,a=h[t];a instanceof Array?u[t]=b(a,i):("string"==typeof a&&(a="+"===a.charAt(0)||"-"===a.charAt(0)?o+parseFloat(a):parseFloat(a)),"number"==typeof a&&(u[t]=o+(a-o)*i))}if(null!==R&&R.call(u,i),1!==n)return!0;if(0<f){for(t in isFinite(f)&&f--,m){if("string"==typeof h[t]&&(m[t]=m[t]+parseFloat(h[t])),v){var r=m[t];m[t]=h[t],h[t]=r}d[t]=m[t]}return v&&(g=!g),E=void 0!==l?e+l:e+w,!0}null!==M&&M.call(u,u);for(var s=0,c=_.length;s<c;s++)_[s].start(E+p);return!1}},oe.Easing={Linear:{None:function(e){return e}},Quadratic:{In:function(e){return e*e},Out:function(e){return e*(2-e)},InOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}},Cubic:{In:function(e){return e*e*e},Out:function(e){return--e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}},Quartic:{In:function(e){return e*e*e*e},Out:function(e){return 1- --e*e*e*e},InOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}},Quintic:{In:function(e){return e*e*e*e*e},Out:function(e){return--e*e*e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}},Sinusoidal:{In:function(e){return 1-Math.cos(e*Math.PI/2)},Out:function(e){return Math.sin(e*Math.PI/2)},InOut:function(e){return.5*(1-Math.cos(Math.PI*e))}},Exponential:{In:function(e){return 0===e?0:Math.pow(1024,e-1)},Out:function(e){return 1===e?1:1-Math.pow(2,-10*e)},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}},Circular:{In:function(e){return 1-Math.sqrt(1-e*e)},Out:function(e){return Math.sqrt(1- --e*e)},InOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}},Elastic:{In:function(e){return 0===e?0:1===e?1:-Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)},Out:function(e){return 0===e?0:1===e?1:Math.pow(2,-10*e)*Math.sin(5*(e-.1)*Math.PI)+1},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?-.5*Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI):.5*Math.pow(2,-10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)+1}},Back:{In:function(e){return e*e*(2.70158*e-1.70158)},Out:function(e){return--e*e*(2.70158*e+1.70158)+1},InOut:function(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}},Bounce:{In:function(e){return 1-oe.Easing.Bounce.Out(1-e)},Out:function(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},InOut:function(e){return e<.5?.5*oe.Easing.Bounce.In(2*e):.5*oe.Easing.Bounce.Out(2*e-1)+.5}}},oe.Interpolation={Linear:function(e,t){var n=e.length-1,i=n*t,o=Math.floor(i),a=oe.Interpolation.Utils.Linear;return t<0?a(e[0],e[1],i):1<t?a(e[n],e[n-1],n-i):a(e[o],e[n<o+1?n:o+1],i-o)},Bezier:function(e,t){for(var n=0,i=e.length-1,o=Math.pow,a=oe.Interpolation.Utils.Bernstein,r=0;r<=i;r++)n+=o(1-t,i-r)*o(t,r)*e[r]*a(i,r);return n},CatmullRom:function(e,t){var n=e.length-1,i=n*t,o=Math.floor(i),a=oe.Interpolation.Utils.CatmullRom;return e[0]===e[n]?(t<0&&(o=Math.floor(i=n*(1+t))),a(e[(o-1+n)%n],e[o],e[(o+1)%n],e[(o+2)%n],i-o)):t<0?e[0]-(a(e[0],e[0],e[1],e[1],-i)-e[0]):1<t?e[n]-(a(e[n],e[n],e[n-1],e[n-1],i-n)-e[n]):a(e[o?o-1:0],e[o],e[n<o+1?n:o+1],e[n<o+2?n:o+2],i-o)},Utils:{Linear:function(e,t,n){return(t-e)*n+e},Bernstein:function(e,t){var n=oe.Interpolation.Utils.Factorial;return n(e)/n(t)/n(e-t)},Factorial:(a=[1],function(e){var t=1;if(a[e])return a[e];for(var n=e;1<n;n--)t*=n;return a[e]=t}),CatmullRom:function(e,t,n,i,o){var a=.5*(n-e),r=.5*(i-t),s=o*o,c=o*s;return(2*t-2*n+a+r)*c+(-3*t+3*n-2*a-r)*s+a*o+t}}};var a;var B={checkTouch:function(){return!!window&&("ontouchstart"in window||window.navigator.msMaxTouchPoints)},checkMobile:function(){return/Mobi|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},checkWebgl:function(){try{var e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(e){return!1}},extend:function(e,t){for(var n in t||(t={}),e)e.hasOwnProperty(n)&&!t.hasOwnProperty(n)&&(t[n]=e[n]);return t},changeProtocol:function(e){try{if(e&&"function"==typeof URL){var t=new URL(window.location.href);if("https:"==t.protocol)return(t=new URL(e)).protocol="https:",t.href}}catch(e){}return e},ImageLoader:{load:function(t,e,n,i,o,a){if(!t)return console.warn("IPANORAMA.Utils.ImageLoader: image source undefined"),void(i&&i());var r,s,c,l,u,d;if(t=B.changeProtocol(t),void 0===(r=THREE.Cache.get(t))){if(u=window.URL||window.webkitURL,d=document.createElementNS("http://www.w3.org/1999/xhtml","img"),0===t.indexOf("data:"))return d.addEventListener("load",h,!1),d.src=t,d;d.crossOrigin=void 0!==a?a:"anonymous",s=new XMLHttpRequest,o&&o.push(s);try{s.open("GET",t,!0),s.responseType="arraybuffer",s.onprogress=function(e){e.lengthComputable&&n&&n({loaded:e.loaded,total:e.total})},s.onload=function(e){200==this.status?(THREE.Cache.add(t,d),c=new Uint8Array(this.response),l=new Blob([c]),d.addEventListener("load",h,!1),d.src=u.createObjectURL(l)):i&&i()},s.onloadend=function(e){200!=this.status&&0!==this.status&&i&&i()},s.send(null)}catch(e){console.warn("IPANORAMA.Utils.ImageLoader: image loading error"),i&&i()}}else e&&setTimeout(function(){n&&n({loaded:1,total:1}),e(r,t)},0);function h(){u.revokeObjectURL(d.src),e&&e(d,t)}}},TextureLoader:{load:function(e,s,t,n,i,c){B.ImageLoader.load(e,function(e,t){var n=new THREE.Texture;if(n.imageOriginalSize={width:e.width,height:e.height},c&&(!THREE.Math.isPowerOfTwo(e.width)||!THREE.Math.isPowerOfTwo(e.height))){var i=THREE.Math.ceilPowerOfTwo(e.width),o=THREE.Math.ceilPowerOfTwo(e.height),a=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");a.width=i,a.height=o;var r=a.getContext("2d");r.drawImage(e,0,0,e.width,e.height),r.drawImage(e,e.width-1,0,1,e.height,e.width,0,i-e.width,e.height),e=a}n.image=e,n.needsUpdate=!0,s&&s(n,t)},t,n,i)}},CubeOneTextureLoader:{load:function(s,c,e,t,n){B.ImageLoader.load(s,function(e){var t=new THREE.CubeTexture([]);t.images=new Array(6);for(var n=0;n<6;n++){var i=document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),o=i.getContext("2d"),a=e.width/6,r=e.height;switch(i.width=a,i.height=r,4!=n&&5!=n||(o.translate(a/2,r/2),o.rotate(180*Math.PI/180),o.translate(-a/2,-r/2)),o.drawImage(e,a*n,0,a,r,0,0,a,r),n){case 0:t.images[0]=i;break;case 1:t.images[5]=i;break;case 2:t.images[1]=i;break;case 3:t.images[4]=i;break;case 4:t.images[2]=i;break;case 5:t.images[3]=i}}t.needsUpdate=!0,c&&c(t,s)},e,t,n)}},CubeSixTextureLoader:{load:function(e,r,n,t,i){var s,c,o,l,u,d;function a(e,a){B.ImageLoader.load(e,function(e){var t,n;if(4==a||5==a){t=document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),n=t.getContext("2d");var i=e.width,o=e.height;t.width=i,t.height=o,n.translate(i/2,o/2),n.rotate(180*Math.PI/180),n.translate(-i/2,-o/2),n.drawImage(e,0,0,i,o,0,0,i,o)}switch(a){case 0:s.images[5]=e;break;case 1:s.images[4]=e;break;case 2:s.images[0]=e;break;case 3:s.images[1]=e;break;case 4:s.images[2]=t;break;case 5:s.images[3]=t}6===++c&&(s.needsUpdate=!0,r&&r(s))},function(e){for(var t in l[a]={loaded:e.loaded,total:e.total},u.loaded=0,u.total=0,d=0,l)d++,u.loaded+=l[t].loaded,u.total+=l[t].total;d<6&&(u.total=u.total/d*6),n&&n(u)},function(){o=!0,t&&t()},i)}if(s=new THREE.CubeTexture([]),c=0,o=!1,l={},u={},ee.isArray(e)){for(var h=0;h<e.length;h++)if(a(e[h],h),o)return void(s&&s.dispose())}else!o&&a(e.front,0),!o&&a(e.back,1),!o&&a(e.left,2),!o&&a(e.right,3),!o&&a(e.top,4),!o&&a(e.bottom,5),o&&s&&s.dispose()}},Matrix:function(){this.reset()}};B.Matrix.prototype={reset:function(){return this.m=[1,0,0,1,0,0],this},multiply:function(e){var t=this.m[0]*e.m[0]+this.m[2]*e.m[1],n=this.m[1]*e.m[0]+this.m[3]*e.m[1],i=this.m[0]*e.m[2]+this.m[2]*e.m[3],o=this.m[1]*e.m[2]+this.m[3]*e.m[3],a=this.m[0]*e.m[4]+this.m[2]*e.m[5]+this.m[4],r=this.m[1]*e.m[4]+this.m[3]*e.m[5]+this.m[5];return this.m[0]=t,this.m[1]=n,this.m[2]=i,this.m[3]=o,this.m[4]=a,this.m[5]=r,this},inverse:function(){var e=new B.Matrix;e.m=this.m.slice(0);var t=1/(e.m[0]*e.m[3]-e.m[1]*e.m[2]),n=e.m[3]*t,i=-e.m[1]*t,o=-e.m[2]*t,a=e.m[0]*t,r=t*(e.m[2]*e.m[5]-e.m[3]*e.m[4]),s=t*(e.m[1]*e.m[4]-e.m[0]*e.m[5]);return e.m[0]=n,e.m[1]=i,e.m[2]=o,e.m[3]=a,e.m[4]=r,e.m[5]=s,e},rotate:function(e){var t=Math.cos(e),n=Math.sin(e),i=this.m[0]*t+this.m[2]*n,o=this.m[1]*t+this.m[3]*n,a=this.m[0]*-n+this.m[2]*t,r=this.m[1]*-n+this.m[3]*t;return this.m[0]=i,this.m[1]=o,this.m[2]=a,this.m[3]=r,this},translate:function(e,t){return this.m[4]+=this.m[0]*e+this.m[2]*t,this.m[5]+=this.m[1]*e+this.m[3]*t,this},scale:function(e,t){return this.m[0]*=e,this.m[1]*=e,this.m[2]*=t,this.m[3]*=t,this},transformPoint:function(e,t){var n=e,i=t;return e=n*this.m[0]+i*this.m[2]+this.m[4],t=n*this.m[1]+i*this.m[3]+this.m[5],[e,t]},transformVector:function(e,t){var n=e,i=t;return e=n*this.m[0]+i*this.m[2],t=n*this.m[1]+i*this.m[3],[e,t]},copy:function(){var e=new Matrix;e.m=this.m.slice(0)}};var r=r||{};r.PanoLoader=function(e){var r,s,c=e||{},t=new google.maps.StreetViewService,l=0,u=0,a=[],d=[],h=0,m=0,p=[1,2,4,7,13,26],f=[1,1,2,4,7,13],v=[416,832,1664,3328,6656,13312],g=[416,416,832,1664,3328,6656],n=null;try{var i=document.createElement("canvas");null==(n=i.getContext("experimental-webgl"))&&(n=i.getContext("webgl"))}catch(e){}var w=1024,E=1024;if(n){var o=Math.max(n.getParameter(n.MAX_TEXTURE_SIZE),6656);w=E=o}this.setProgress=function(e,t){this.onProgress&&this.onProgress({loaded:e,total:t})},this.throwError=function(e){this.onError?this.onError(e):console.error(e)},this.adaptTextureToZoom=function(){var e=416*p[r],t=416*f[r];e=v[r],t=g[r],h=Math.ceil(e/w),m=Math.ceil(t/E),a=[],d=[];for(var n=0;n<m;n++)for(var i=0;i<h;i++){var o=document.createElement("canvas");o.width=i<h-1?w:e-w*i,o.height=n<m-1?E:t-E*n,a.push(o),d.push(o.getContext("2d")),0}},this.composeFromTile=function(e,t,n){e*=512,t*=512;var i=Math.floor(e/w),o=Math.floor(t/E);e-=i*w,t-=o*E,d[o*h+i].drawImage(n,0,0,n.width,n.height,e,t,512,512),this.progress()},this.progress=function(){l++;Math.round(100*l/u);this.setProgress(l,u),l===u&&(this.canvas=a,this.panoId=s,this.zoom=r,this.onPanoramaLoad&&this.onPanoramaLoad(a[0]))},this.composePanorama=function(){this.setProgress(0,1);var e=p[r],t=f[r],o=this;u=e*t;for(var o=this,n=l=0;n<t;n++)for(var i=0;i<e;i++){var a="https://geo0.ggpht.com/cbk?cb_client=maps_sv.tactile&authuser=0&hl=en&output=tile&zoom="+r+"&x="+i+"&y="+n+"&panoid="+s+"&nbt&fover=2";!function(e,t){if(c.useWebGL)var n=THREE.ImageUtils.loadTexture(a,null,function(){o.composeFromTile(e,t,n)});else{var i=new Image;i.addEventListener("load",function(){o.composeFromTile(e,t,this)}),i.crossOrigin="",i.src=a}}(i,n)}};var y=function(e,t){t===google.maps.StreetViewStatus.OK?(this.result=e,this.onPanoramaData&&this.onPanoramaData(e),e.copyright,this.copyright=e.copyright,s=e.location.pano,this.location=location,this.rotation=0,this.composePanorama()):(this.onNoPanoramaData&&this.onNoPanoramaData(t),this.throwError("Could not retrieve panorama for the following reason: "+t))};this.loadById=function(e){t.getPanoramaById(e,y.bind(this))},this.loadByLocation=function(e){t.getPanoramaByLocation(e,50,y.bind(this))},this.setZoom=function(e){r=e,this.adaptTextureToZoom()},this.setZoom(c.zoom||1)};var s=function(r){this.scene=r,(this.scene.control=this).canvas=r.viewer.$canvas.get(0),this.enabled=!0,this.target=new THREE.Vector3,this.noZoom=!1,this.zoomSpeed=1,this.minZoom=0,this.maxZoom=1/0,this.noDolly=!0,this.minDistance=1,this.maxDistance=1/0,this.noRotate=!1,this.rotateSpeed=-.15,this.noPan=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeedX=2,this.autoRotateSpeedY=0,this.autoRotateSpeedZ=0,this.momentumDampingFactor=.9,this.momentumScalingFactor=-.005,this.momentumKeydownFactor=20,this.minFov=10,this.maxFov=120,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.noKeys=!1,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,DOLLY:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT},this.noGyroscope=!1,this.gyroscopeSpeed=.02;var a,s,t,n,i,o,c=this,l=null,u=null,d=0,h=0,m=new THREE.Vector2,p=new THREE.Vector2,f=new THREE.Vector2,v=new THREE.Vector2,g=new THREE.Vector2,w=new THREE.Vector2,E=new THREE.Vector3,y=new THREE.Vector3,b=new THREE.Vector2,_=new THREE.Vector2,T=new THREE.Vector2,x=0,R=0,M=0,P=0,H=1,S=new THREE.Vector3,A=new THREE.Vector3,C=new THREE.Quaternion,L=!1,k=0,$=0,O=null,I={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM:4,TOUCH_PAN:5},D=I.NONE;this.target0=c.target.clone(),this.position0=c.scene.camera.position.clone(),this.zoom0=c.scene.camera.zoom;var F=(new THREE.Quaternion).setFromUnitVectors(c.scene.camera.up,new THREE.Vector3(0,1,0)),z=F.clone().inverse(),B={type:"change"},j={type:"start"},Y={type:"end"};function X(e){return 2*Math.PI/60/60*e}function V(){return Math.pow(.95,c.zoomSpeed)}function e(e){if(k=$=0,(L=!1)!==c.enabled){if(e.button===c.mouseButtons.ORBIT){if(!0===c.noRotate)return;D=I.ROTATE,m.set(e.clientX,e.clientY)}else if(e.button===c.mouseButtons.DOLLY){if(!0===c.noDolly)return;D=I.DOLLY,b.set(e.clientX,e.clientY)}else if(e.button===c.mouseButtons.PAN){if(!0===c.noPan)return;D=I.PAN,v.set(e.clientX,e.clientY)}D!==I.NONE&&(c.tweenAnimation&&c.tweenAnimation.stop(),document.addEventListener("mousemove",q,!1),document.addEventListener("mouseup",U,!1),c.dispatchEvent(j),c.scene&&c.scene.viewer.$listener.trigger("ipanorama:scene-camera-start",{scene:c.scene})),c.update()}}function q(e){if(!1!==c.enabled){e.preventDefault();var t=c.canvas===document?c.canvas.body:c.canvas;if(D===I.ROTATE){if(!0===c.noRotate)return;p.set(e.clientX,e.clientY),f.subVectors(p,m),c.rotateLeft(-2*Math.PI*f.x/t.clientWidth*c.rotateSpeed),c.rotateUp(-2*Math.PI*f.y/t.clientHeight*c.rotateSpeed),m.copy(p),O&&(k=e.clientX-O.clientX,$=e.clientY-O.clientY),O=e}else if(D===I.DOLLY){if(!0===c.noDolly)return;_.set(e.clientX,e.clientY),T.subVectors(_,b),0<T.y?c.dollyIn():T.y<0&&c.dollyOut(),b.copy(_)}else if(D===I.PAN){if(!0===c.noPan)return;g.set(e.clientX,e.clientY),w.subVectors(g,v),c.pan(w.x,w.y),v.copy(g)}D!==I.NONE&&c.update()}}function U(e){!(L=!(O=null))!==c.enabled&&(document.removeEventListener("mousemove",q,!1),document.removeEventListener("mouseup",U,!1),c.dispatchEvent(Y),c.scene&&c.scene.viewer.$listener.trigger("ipanorama:scene-camera-end",{scene:c.scene}),D=I.NONE)}function Z(e){if(!1!==c.enabled&&!0!==c.noZoom&&D===I.NONE){e.preventDefault(),e.stopPropagation();var t=0;void 0!==e.wheelDelta?t=e.wheelDelta:void 0!==e.detail&&(t=-e.detail),0<t?(c.scene.camera.fov=c.scene.camera.fov>c.minFov?c.scene.camera.fov-1:c.minFov,c.scene.camera.updateProjectionMatrix()):t<0&&(c.scene.camera.fov=c.scene.camera.fov<c.maxFov?c.scene.camera.fov+1:c.maxFov,c.scene.camera.updateProjectionMatrix()),c.update(),c.dispatchEvent(j),c.scene&&c.scene.viewer.$listener.trigger("ipanorama:scene-camera-start",{scene:c.scene}),c.dispatchEvent(B),c.scene&&c.scene.viewer.$listener.trigger("ipanorama:scene-camera-change",{scene:c.scene}),c.dispatchEvent(Y),c.scene&&c.scene.viewer.$listener.trigger("ipanorama:scene-camera-end",{scene:c.scene})}}function N(e){switch(e.keyCode){case c.keys.UP:t=!1;break;case c.keys.BOTTOM:n=!1;break;case c.keys.LEFT:i=!1;break;case c.keys.RIGHT:o=!1}}function G(e){if(!1!==c.enabled&&!0!==c.noKeys){switch(e.keyCode){case c.keys.UP:t=!0;break;case c.keys.BOTTOM:n=!0;break;case c.keys.LEFT:i=!0;break;case c.keys.RIGHT:o=!0}(t||n||i||o)&&(c.tweenAnimation&&c.tweenAnimation.stop(),L=!0,t&&($=-c.rotateSpeed*c.momentumKeydownFactor),n&&($=c.rotateSpeed*c.momentumKeydownFactor),i&&(k=-c.rotateSpeed*c.momentumKeydownFactor),o&&(k=c.rotateSpeed*c.momentumKeydownFactor))}}function W(e){if(L=!1,k=$=0,c.tweenAnimation&&c.tweenAnimation.stop(),!1!==c.enabled){switch(e.touches.length){case 1:if(!0===c.noRotate)return;D=I.TOUCH_ROTATE,m.set(e.touches[0].pageX,e.touches[0].pageY);break;case 2:if(!0===c.noZoom)return;D=I.TOUCH_ZOOM;var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,i=Math.sqrt(t*t+n*n);x=i,R=c.scene.camera.fov;break;case 3:if(!0===c.noPan)return;D=I.TOUCH_PAN,v.set(e.touches[0].pageX,e.touches[0].pageY);break;default:D=I.NONE}D!==I.NONE&&(c.tweenAnimation&&c.tweenAnimation.stop(),c.dispatchEvent(j),c.scene&&c.scene.viewer.$listener.trigger("ipanorama:scene-camera-start",{scene:c.scene}))}}function Q(e){if(!1!==c.enabled){e.preventDefault(),e.stopPropagation();var t=c.canvas===document?c.canvas.body:c.canvas;switch(e.touches.length){case 1:if(!0===c.noRotate)return;if(D!==I.TOUCH_ROTATE)return;p.set(e.touches[0].pageX,e.touches[0].pageY),f.subVectors(p,m),c.rotateLeft(-2*Math.PI*f.x/t.clientWidth*c.rotateSpeed),c.rotateUp(-2*Math.PI*f.y/t.clientHeight*c.rotateSpeed),m.copy(p),O&&(k=e.touches[0].pageX-O.pageX,$=e.touches[0].pageY-O.pageY),O={pageX:e.touches[0].pageX,pageY:e.touches[0].pageY},c.update();break;case 2:if(!0===c.noZoom)return;if(D!==I.TOUCH_ZOOM)return;var n=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY,o=Math.sqrt(n*n+i*i),a=x-o,r=Math.max(c.minFov,Math.min(c.maxFov,R+.1*a));c.scene.camera.fov=r,c.scene.camera.updateProjectionMatrix(),c.update(),c.dispatchEvent(B),c.scene&&c.scene.viewer.$listener.trigger("ipanorama:scene-camera-change",{scene:c.scene});break;case 3:if(!0===c.noPan)return;if(D!==I.TOUCH_PAN)return;g.set(e.touches[0].pageX,e.touches[0].pageY),w.subVectors(g,v),c.pan(w.x,w.y),v.copy(g),c.update();break;default:D=I.NONE}}}function K(e){!(L=!(O=null))!==c.enabled&&(c.dispatchEvent(Y),c.scene&&c.scene.viewer.$listener.trigger("ipanorama:scene-camera-end",{scene:c.scene}),D=I.NONE)}function J(e){if(!1!==c.enabled&&!0!==c.noGyroscope){var t,n=function(e){var t,n,i,o=Math.cos(e.yaw),a=Math.sin(e.yaw),r=Math.cos(e.pitch),s=Math.sin(e.pitch),c=Math.cos(e.roll),l=Math.sin(e.roll),u=new Array(a*l-o*s*c,-o*r,o*s*l+a*c,r*c,-s,-r*l,a*s*c+o*l,a*r,-a*s*l+o*c);.9999<u[3]?(t=Math.atan2(u[2],u[8]),i=Math.PI/2,n=0):u[3]<-.9999?(t=Math.atan2(u[2],u[8]),i=-Math.PI/2,n=0):(t=Math.atan2(-u[6],u[0]),n=Math.atan2(-u[5],u[4]),i=Math.asin(u[3]));return new Object({yaw:t,pitch:i,roll:n})}(new Object({yaw:e.alpha*ne,pitch:e.beta*ne,roll:e.gamma*ne})),i=n.yaw/ne,o=n.pitch/ne,a=i;if(70<Math.abs(o)){switch(a=e.alpha,window.orientation){case 0:0<o&&(a+=180);break;case 90:a+=90;break;case-90:a+=-90;break;case 180:o<0&&(a+=180)}a%=360,180<Math.abs(a-i)&&(a+=a<i?360:-360),t=Math.min(1,(Math.abs(o)-70)/10),i=i*(1-t)+a*t}null!==l&&null!==u&&((l<=0&&i<=0||0<=l&&0<=i)&&(d=l-i,c.rotateLeft(d*-c.gyroscopeSpeed)),h=u-o,c.rotateUp(h*c.gyroscopeSpeed)),l=i,u=o}}this.setLastQuaternion=function(e){C.copy(e),c.scene.camera.quaternion.copy(e)},this.getLastPosition=function(){return A},this.rotateLeft=function(e){e&&(P+=e)},this.rotateUp=function(e){e&&(M+=e)},this.panLeft=function(e){var t=c.scene.camera.matrix.elements;E.set(t[0],t[1],t[2]),E.multiplyScalar(-e),S.add(E)},this.panUp=function(e){var t=c.scene.camera.matrix.elements;E.set(t[4],t[5],t[6]),E.multiplyScalar(e),S.add(E)},this.pan=function(e,t){var n=c.canvas===document?c.canvas.body:c.canvas;if(c.scene.camera instanceof THREE.PerspectiveCamera){var i=c.scene.camera.position,o=i.clone().sub(c.target),a=o.length();a*=Math.tan(c.scene.camera.fov/2*Math.PI/180),c.panLeft(2*e*a/n.clientHeight),c.panUp(2*t*a/n.clientHeight)}else c.scene.camera instanceof THREE.OrthographicCamera?(c.panLeft(e*(c.scene.camera.right-c.scene.camera.left)/n.clientWidth),c.panUp(t*(c.scene.camera.top-c.scene.camera.bottom)/n.clientHeight)):console.warn("IPANORAMA.OrbitControls: encountered an unknown camera type - pan disabled.")},this.momentum=function(){L&&(Math.abs(k)<1e-4&&Math.abs($)<1e-4?L=!1:($*=c.momentumDampingFactor,k*=c.momentumDampingFactor,P-=c.momentumScalingFactor*k,M-=c.momentumScalingFactor*$))},this.dollyIn=function(e){void 0===e&&(e=V()),c.scene.camera instanceof THREE.PerspectiveCamera?H/=e:c.scene.camera instanceof THREE.OrthographicCamera?(c.scene.camera.zoom=Math.max(c.minZoom,Math.min(c.maxZoom,c.scene.camera.zoom*e)),c.scene.camera.updateProjectionMatrix(),c.dispatchEvent(B),c.scene&&c.scene.viewer.$listener.trigger("ipanorama:scene-camera-change",{scene:c.scene})):console.warn("IPANORAMA.OrbitControls: encountered an unknown camera type - dolly/zoom disabled.")},this.dollyOut=function(e){void 0===e&&(e=V()),c.scene.camera instanceof THREE.PerspectiveCamera?H*=e:c.scene.camera instanceof THREE.OrthographicCamera?(c.scene.camera.zoom=Math.max(c.minZoom,Math.min(c.maxZoom,c.scene.camera.zoom/e)),c.scene.camera.updateProjectionMatrix(),c.dispatchEvent(B),c.scene&&c.scene.viewer.$listener.trigger("ipanorama:scene-camera-change",{scene:c.scene})):console.warn("IPANORAMA.OrbitControls: encountered an unknown camera type - dolly/zoom disabled.")},this.update=function(e){var t=c.scene.camera.position;if(y.copy(t).sub(c.target),y.applyQuaternion(F),a=Math.atan2(y.x,y.z),s=Math.atan2(Math.sqrt(y.x*y.x+y.z*y.z),y.y),c.autoRotate&&D===I.NONE){var n=X(c.autoRotateSpeedX),i=X(c.autoRotateSpeedY);c.rotateLeft(n),s<=c.minPolarAngle+te||s>=c.maxPolarAngle-te?(c.rotateUp(-i),c.rotateLeft(Math.PI),c.autoRotateSpeedY=-c.autoRotateSpeedY):c.rotateUp(i)}c.momentum(),a+=P,s+=M,a=Math.max(c.minAzimuthAngle,Math.min(c.maxAzimuthAngle,a)),s=Math.max(c.minPolarAngle,Math.min(c.maxPolarAngle,s)),s=Math.max(te,Math.min(Math.PI-te,s));var o=y.length()*H;if(o=Math.max(c.minDistance,Math.min(c.maxDistance,o)),c.target.add(S),y.x=o*Math.sin(s)*Math.sin(a),y.y=o*Math.cos(s),y.z=o*Math.sin(s)*Math.cos(a),y.applyQuaternion(z),t.copy(c.target).add(y),c.scene.camera.lookAt(c.target),M=P=0,H=1,S.set(0,0,0),A.distanceToSquared(c.scene.camera.position)>te||8*(1-C.dot(c.scene.camera.quaternion))>te)return!0!==e&&(c.dispatchEvent(B),c.scene&&c.scene.viewer.$listener.trigger("ipanorama:scene-camera-change",{scene:c.scene})),A.copy(c.scene.camera.position),void C.copy(c.scene.camera.quaternion)},this.bind=function(){c.canvas.addEventListener("mousedown",e,!1),c.canvas.addEventListener("mousewheel",Z,!1),c.canvas.addEventListener("DOMMouseScroll",Z,!1),c.canvas.addEventListener("touchstart",W,!1),c.canvas.addEventListener("touchend",K,!1),c.canvas.addEventListener("touchmove",Q,!1),c.canvas.addEventListener("keyup",N,!1),c.canvas.addEventListener("keydown",G,!1),window.addEventListener("deviceorientation",J,!1)},this.unbind=function(){c.canvas.removeEventListener("mousedown",e,!1),c.canvas.removeEventListener("mousewheel",Z,!1),c.canvas.removeEventListener("DOMMouseScroll",Z,!1),c.canvas.removeEventListener("touchstart",W,!1),c.canvas.removeEventListener("touchend",K,!1),c.canvas.removeEventListener("touchmove",Q,!1),c.canvas.removeEventListener("keyup",N,!1),c.canvas.removeEventListener("keydown",G,!1),window.removeEventListener("deviceorientation",J,!1),document.removeEventListener("mousemove",q,!1),document.removeEventListener("mouseup",U,!1)},this.reset=function(){D=I.NONE,c.target.copy(c.target0),c.scene.camera.position.copy(c.position0),c.scene.camera.zoom=c.zoom0,c.scene.camera.updateProjectionMatrix(),c.dispatchEvent(B),c.scene&&c.scene.viewer.$listener.trigger("ipanorama:scene-camera-change",{scene:c.scene}),c.update()},this.yawPitchToCoord=function(e,t,n){var i=(180-e)*ne,o=t*ne;return{x:(n=0<n?n:1)*Math.cos(o)*Math.sin(i),y:n*Math.sin(o),z:n*Math.cos(o)*Math.cos(i)}},this.coordToYawPitch=function(e){var t=Math.atan2(e.x,-e.z),n=Math.sqrt(e.x*e.x+e.z*e.z),i=Math.atan2(e.y,n),o=Math.sqrt(n*n+e.y*e.y),a=t*ie,r=i*ie;return{yaw:a=(a%=360)<0?a+360:a,pitch:r,radius:o}},this.setYawPitch=function(e,t){c.tweenAnimation&&c.tweenAnimation.stop();var n=c.yawPitchToCoord(e,t),i=new THREE.Vector3(n.x,n.y,n.z);i.normalize(),c.scene.camera.position.copy(i),r.afterRender=!0},this.getYawPitch=function(){var e=c.coordToYawPitch(c.scene.camera.position),t=e.yaw,n=e.pitch;return{yaw:t=(t%=360)<0?t+360:t,pitch:n}},this.lookAt=function(e,t,n){var i=new ee.Deferred;if(e.hasOwnProperty("yaw")&&e.hasOwnProperty("pitch")&&(e=c.yawPitchToCoord(e.yaw,e.pitch)),t){n=n||oe.Easing.Exponential.Out;var o=new THREE.Vector3(0,0,1);o.applyQuaternion(c.scene.camera.quaternion);var a=new THREE.Vector3(e.x,e.y,e.z);a.normalize().negate(),o.distanceTo(a)<te?i.resolve():(c.tweenAnimation&&c.tweenAnimation.stop(),c.tweenAnimation=new oe.Tween(o).to(a,t).easing(n).onStart(function(){}).onUpdate(function(e){c.scene.camera.position.copy(o)}).onComplete(function(){i.resolve(),c.tweenAnimation.stop()}).onStop(function(){i.reject()}).start())}else{var a=new THREE.Vector3(e.x,e.y,e.z);a.normalize().negate(),c.scene.camera.position.copy(a),r.afterRender=!0,i.resolve()}return i.promise()},this.getLookAt=function(){var e=c.coordToYawPitch(c.scene.camera.position),t=e.yaw,n=e.pitch;return t-=180,{yaw:t=(t%=360)<0?t+360:t,pitch:n=0==n?n:-n}},this.getZoom=function(){return c.scene.camera.fov},this.setZoom=function(e){e&&(e=Math.max(c.minFov,Math.min(c.maxFov,e)),c.scene.camera.fov=e,c.scene.camera.updateProjectionMatrix(),c.dispatchEvent(B),c.scene&&c.scene.viewer.$listener.trigger("ipanorama:scene-camera-change",{scene:c.scene}))},this.destroy=function(){c.unbind(),c.tweenAnimation&&c.tweenAnimation.stop()},this.update()};(s.prototype=Object.create(THREE.EventDispatcher.prototype)).constructor=s;var m=function(i,e){THREE.Object3D.call(this),i=void 0!==i?i:document,this.visible=!1;var o=new V;this.add(o);var d=new q;this.add(d);var a=this;F("camera",e),F("object",void 0),F("enabled",!0),F("axis",null),F("mode","translate"),F("translationSnap",null),F("rotationSnap",null),F("space","world"),F("size",1),F("dragging",!1),F("showX",!0),F("showY",!0),F("showZ",!0);var h={type:"change"},r={type:"mouseDown"},t={type:"mouseUp",mode:a.mode},m={type:"objectChange"},p=new THREE.Raycaster,f=new THREE.Vector3,v=(new THREE.Vector3,new THREE.Quaternion),g={X:new THREE.Vector3(1,0,0),Y:new THREE.Vector3(0,1,0),Z:new THREE.Vector3(0,0,1)},w=(new THREE.Quaternion,new THREE.Vector3,new THREE.Vector3),E=new THREE.Vector3,y=new THREE.Vector3,b=new THREE.Vector3,_=new THREE.Vector3,T=new THREE.Vector3,x=0,n=new THREE.Vector3,s=new THREE.Quaternion,c=new THREE.Vector3,l=new THREE.Vector3,u=new THREE.Quaternion,R=new THREE.Quaternion,M=new THREE.Vector3,P=new THREE.Vector3,H=new THREE.Quaternion,S=new THREE.Vector3,A=new THREE.Vector3,C=new THREE.Quaternion,L=new THREE.Quaternion,k=new THREE.Vector3,$=new THREE.Vector3,O=new THREE.Vector3,I=new THREE.Quaternion,D=new THREE.Vector3;function F(t,e){var n=e;Object.defineProperty(a,t,{get:function(){return void 0!==n?n:e},set:function(e){n!==e&&(n=e,d[t]=e,o[t]=e,a.dispatchEvent({type:t+"-changed",value:e}),a.dispatchEvent(h))}}),a[t]=e,d[t]=e,o[t]=e}function z(e){var t=e.changedTouches?e.changedTouches[0]:e,n=i.getBoundingClientRect();return{x:(t.clientX-n.left)/n.width*2-1,y:-(t.clientY-n.top)/n.height*2+1,button:e.button}}function B(e){a.enabled&&a.pointerHover(z(e))}function j(e){a.enabled&&(document.addEventListener("mousemove",Y,!1),a.pointerHover(z(e)),a.pointerDown(z(e)))}function Y(e){a.enabled&&a.pointerMove(z(e))}function X(e){a.enabled&&(document.removeEventListener("mousemove",Y,!1),a.pointerUp(z(e)))}F("worldPosition",A),F("worldPositionStart",P),F("worldQuaternion",C),F("worldQuaternionStart",H),F("cameraPosition",n),F("cameraQuaternion",s),F("pointStart",w),F("pointEnd",E),F("rotationAxis",b),F("rotationAngle",x),F("eye",$),i.addEventListener("mousedown",j,!1),i.addEventListener("touchstart",j,!1),i.addEventListener("mousemove",B,!1),i.addEventListener("touchmove",B,!1),i.addEventListener("touchmove",Y,!1),document.addEventListener("mouseup",X,!1),i.addEventListener("touchend",X,!1),i.addEventListener("touchcancel",X,!1),i.addEventListener("touchleave",X,!1),this.dispose=function(){i.removeEventListener("mousedown",j),i.removeEventListener("touchstart",j),i.removeEventListener("mousemove",B),i.removeEventListener("touchmove",B),i.removeEventListener("touchmove",Y),document.removeEventListener("mouseup",X),i.removeEventListener("touchend",X),i.removeEventListener("touchcancel",X),i.removeEventListener("touchleave",X)},this.attach=function(e){this.object=e,this.visible=!0},this.detach=function(){this.object=void 0,this.visible=!1,this.axis=null},this.updateMatrixWorld=function(){void 0!==this.object&&(this.object.updateMatrixWorld(),this.object.parent.matrixWorld.decompose(l,u,M),this.object.matrixWorld.decompose(A,C,k),R.copy(u).inverse(),L.copy(C).inverse()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(n,s,c),this.camera instanceof THREE.PerspectiveCamera?$.copy(n).sub(A).normalize():this.camera instanceof THREE.OrthographicCamera&&$.copy(n).normalize(),THREE.Object3D.prototype.updateMatrixWorld.call(this)},this.pointerHover=function(e){if(void 0!==this.object&&!0!==this.dragging&&(void 0===e.button||0===e.button)){p.setFromCamera(e,this.camera);var t=p.intersectObjects(o.picker[this.mode].children,!0)[0]||!1;this.axis=t?t.object.name:null}},this.pointerDown=function(e){if(!(void 0===this.object||!0===this.dragging||void 0!==e.button&&0!==e.button||0!==e.button&&void 0!==e.button||null===this.axis)){p.setFromCamera(e,this.camera);var t=p.intersectObjects([d],!0)[0]||!1;if(t){var n=this.space;if("scale"===this.mode?n="local":"E"!==this.axis&&"XYZE"!==this.axis&&"XYZ"!==this.axis||(n="world"),"local"===n&&"rotate"===this.mode){var i=this.rotationSnap;"X"===this.axis&&i&&(this.object.rotation.x=Math.round(this.object.rotation.x/i)*i),"Y"===this.axis&&i&&(this.object.rotation.y=Math.round(this.object.rotation.y/i)*i),"Z"===this.axis&&i&&(this.object.rotation.z=Math.round(this.object.rotation.z/i)*i)}this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),O.copy(this.object.position),I.copy(this.object.quaternion),D.copy(this.object.scale),this.object.matrixWorld.decompose(P,H,S),w.copy(t.point).sub(P)}this.dragging=!0,r.mode=this.mode,this.dispatchEvent(r)}},this.pointerMove=function(e){var t=this.axis,n=this.mode,i=this.object,o=this.space;if("scale"===n?o="local":"E"!==t&&"XYZE"!==t&&"XYZ"!==t||(o="world"),void 0!==i&&null!==t&&!1!==this.dragging&&(void 0===e.button||0===e.button)){p.setFromCamera(e,this.camera);var a=p.intersectObjects([d],!0)[0]||!1;if(!1!==a){if(E.copy(a.point).sub(P),"translate"===n)y.copy(E).sub(w),"local"===o&&"XYZ"!==t&&y.applyQuaternion(L),-1===t.indexOf("X")&&(y.x=0),-1===t.indexOf("Y")&&(y.y=0),-1===t.indexOf("Z")&&(y.z=0),"local"===o&&"XYZ"!==t?y.applyQuaternion(I).divide(M):y.applyQuaternion(R).divide(M),i.position.copy(y).add(O),this.translationSnap&&("local"===o&&(i.position.applyQuaternion(v.copy(I).inverse()),-1!==t.search("X")&&(i.position.x=Math.round(i.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(i.position.y=Math.round(i.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(i.position.z=Math.round(i.position.z/this.translationSnap)*this.translationSnap),i.position.applyQuaternion(I)),"world"===o&&(i.parent&&i.position.add(f.setFromMatrixPosition(i.parent.matrixWorld)),-1!==t.search("X")&&(i.position.x=Math.round(i.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(i.position.y=Math.round(i.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(i.position.z=Math.round(i.position.z/this.translationSnap)*this.translationSnap),i.parent&&i.position.sub(f.setFromMatrixPosition(i.parent.matrixWorld))));else if("scale"===n){if(-1!==t.search("XYZ")){var r=E.length()/w.length();E.dot(w)<0&&(r*=-1),f.set(r,r,r)}else f.copy(E).divide(w),-1===t.search("X")&&(f.x=1),-1===t.search("Y")&&(f.y=1),-1===t.search("Z")&&(f.z=1);i.scale.copy(D).multiply(f)}else if("rotate"===n){y.copy(E).sub(w);var s=20/A.distanceTo(f.setFromMatrixPosition(this.camera.matrixWorld));"E"===t?(b.copy($),x=E.angleTo(w),_.copy(w).normalize(),T.copy(E).normalize(),x*=T.cross(_).dot($)<0?1:-1):"XYZE"===t?(b.copy(y).cross($).normalize(),x=y.dot(f.copy(b).cross(this.eye))*s):"X"!==t&&"Y"!==t&&"Z"!==t||(b.copy(g[t]),f.copy(g[t]),"local"===o&&f.applyQuaternion(C),x=y.dot(f.cross($).normalize())*s),this.rotationSnap&&(x=Math.round(x/this.rotationSnap)*this.rotationSnap),this.rotationAngle=x,"local"===o&&"E"!==t&&"XYZE"!==t?(i.quaternion.copy(I),i.quaternion.multiply(v.setFromAxisAngle(b,x)).normalize()):(b.applyQuaternion(R),i.quaternion.copy(v.setFromAxisAngle(b,x)),i.quaternion.multiply(I).normalize())}else if("orbit"===n){y.copy(E).sub(w),"local"===o&&"XYZ"!==t&&y.applyQuaternion(L),-1===t.indexOf("X")&&(y.x=0),-1===t.indexOf("Y")&&(y.y=0),-1===t.indexOf("Z")&&(y.z=0),"local"===o&&"XYZ"!==t?y.applyQuaternion(I).divide(M):y.applyQuaternion(R).divide(M),i.position.copy(y).add(O);var c=new THREE.Vector3,l=i.position.clone(),u=(c.distanceTo(l),new THREE.Vector3);u.addVectors(c,l.normalize().multiplyScalar(500)),i.position.copy(u),this.translationSnap&&("local"===o&&(i.position.applyQuaternion(v.copy(I).inverse()),-1!==t.search("X")&&(i.position.x=Math.round(i.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(i.position.y=Math.round(i.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(i.position.z=Math.round(i.position.z/this.translationSnap)*this.translationSnap),i.position.applyQuaternion(I)),"world"===o&&(i.parent&&i.position.add(f.setFromMatrixPosition(i.parent.matrixWorld)),-1!==t.search("X")&&(i.position.x=Math.round(i.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(i.position.y=Math.round(i.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(i.position.z=Math.round(i.position.z/this.translationSnap)*this.translationSnap),i.parent&&i.position.sub(f.setFromMatrixPosition(i.parent.matrixWorld))))}this.dispatchEvent(h),this.dispatchEvent(m)}}},this.pointerUp=function(e){void 0!==e.button&&0!==e.button||(this.dragging&&null!==this.axis&&(t.mode=this.mode,this.dispatchEvent(t)),this.dragging=!1,void 0===e.button&&(this.axis=null))}};m.prototype=Object.assign(Object.create(THREE.Object3D.prototype),{constructor:m,isTransformControls:!0});var V=function(){THREE.Object3D.call(this),this.type="TransformControlsGizmo";var e=new THREE.MeshBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,side:THREE.DoubleSide,fog:!1}),t=new THREE.LineBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,linewidth:1,fog:!1}),n=e.clone();n.opacity=.15;var i=e.clone();i.opacity=.33;var o=e.clone();o.color.set(16711680);var a=e.clone();a.color.set(65280);var r=e.clone();r.color.set(255);var s=e.clone();s.opacity=.25;var c=s.clone();c.color.set(16776960);var l=s.clone();l.color.set(65535);var u=s.clone();u.color.set(16711935);var d=e.clone();d.color.set(16776960);var h=t.clone();h.color.set(16711680);var m=t.clone();m.color.set(65280);var p=t.clone();p.color.set(255);var f=t.clone();f.color.set(65535);var v=t.clone();v.color.set(16711935);var g=t.clone();g.color.set(16776960);var w=t.clone();w.color.set(7895160);var E=g.clone();E.opacity=.25;var y=new THREE.CylinderBufferGeometry(0,.05,.2,12,1,!1),b=new THREE.BoxBufferGeometry(.125,.125,.125),_=new THREE.BufferGeometry;_.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,1,0,0],3));var T=function(e,t){for(var n=new THREE.BufferGeometry,i=[],o=0;o<=64*t;++o)i.push(0,Math.cos(o/32*Math.PI)*e,Math.sin(o/32*Math.PI)*e);return n.addAttribute("position",new THREE.Float32BufferAttribute(i,3)),n},x=function(e,t){var n=new THREE.BufferGeometry;return n.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,1,1,1],3)),n},R={X:[[new THREE.Mesh(y,o),[1,0,0],[0,0,-Math.PI/2],null,"fwd"],[new THREE.Mesh(y,o),[1,0,0],[0,0,Math.PI/2],null,"bwd"],[new THREE.Line(_,h)]],Y:[[new THREE.Mesh(y,a),[0,1,0],null,null,"fwd"],[new THREE.Mesh(y,a),[0,1,0],[Math.PI,0,0],null,"bwd"],[new THREE.Line(_,m),null,[0,0,Math.PI/2]]],Z:[[new THREE.Mesh(y,r),[0,0,1],[Math.PI/2,0,0],null,"fwd"],[new THREE.Mesh(y,r),[0,0,1],[-Math.PI/2,0,0],null,"bwd"],[new THREE.Line(_,p),null,[0,-Math.PI/2,0]]],XYZ:[[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.1,0),s),[0,0,0],[0,0,0]]],XY:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.295,.295),c),[.15,.15,0]],[new THREE.Line(_,g),[.18,.3,0],null,[.125,1,1]],[new THREE.Line(_,g),[.3,.18,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.295,.295),l),[0,.15,.15],[0,Math.PI/2,0]],[new THREE.Line(_,f),[0,.18,.3],[0,0,Math.PI/2],[.125,1,1]],[new THREE.Line(_,f),[0,.3,.18],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.295,.295),u),[.15,0,.15],[-Math.PI/2,0,0]],[new THREE.Line(_,v),[.18,0,.3],null,[.125,1,1]],[new THREE.Line(_,v),[.3,0,.18],[0,-Math.PI/2,0],[.125,1,1]]]},M={X:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.2,0),n)]],XY:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),n),[.2,.2,0]]],YZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),n),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),n),[.2,0,.2],[-Math.PI/2,0,0]]]},P={START:[[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.01,2),i),null,null,null,"helper"]],END:[[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.01,2),i),null,null,null,"helper"]],DELTA:[[new THREE.Line(x(),i),null,null,null,"helper"]],X:[[new THREE.Line(_,i.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new THREE.Line(_,i.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new THREE.Line(_,i.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},H={X:[[new THREE.Line(T(1,.5),h)],[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.04,0),o),[0,0,.99],null,[1,3,1]]],Y:[[new THREE.Line(T(1,.5),m),null,[0,0,-Math.PI/2]],[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.04,0),a),[0,0,.99],null,[3,1,1]]],Z:[[new THREE.Line(T(1,.5),p),null,[0,Math.PI/2,0]],[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.04,0),r),[.99,0,0],null,[1,3,1]]],E:[[new THREE.Line(T(1.25,1),E),null,[0,Math.PI/2,0]],[new THREE.Mesh(new THREE.CylinderBufferGeometry(.03,0,.15,4,1,!1),E),[1.17,0,0],[0,0,-Math.PI/2],[1,1,.001]],[new THREE.Mesh(new THREE.CylinderBufferGeometry(.03,0,.15,4,1,!1),E),[-1.17,0,0],[0,0,Math.PI/2],[1,1,.001]],[new THREE.Mesh(new THREE.CylinderBufferGeometry(.03,0,.15,4,1,!1),E),[0,-1.17,0],[Math.PI,0,0],[1,1,.001]],[new THREE.Mesh(new THREE.CylinderBufferGeometry(.03,0,.15,4,1,!1),E),[0,1.17,0],[0,0,0],[1,1,.001]]],XYZE:[[new THREE.Line(T(1,1),w),null,[0,Math.PI/2,0]]]},S={AXIS:[[new THREE.Line(_,i.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},A={X:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1,.1,4,24),n),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1,.1,4,24),n),[0,0,0],[Math.PI/2,0,0]]],Z:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1,.1,4,24),n),[0,0,0],[0,0,-Math.PI/2]]],E:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1.25,.1,2,24),n)]],XYZE:[[new THREE.Mesh(new THREE.SphereBufferGeometry(.7,10,8),n)]]},C={X:[[new THREE.Mesh(b,o),[.8,0,0],[0,0,-Math.PI/2]],[new THREE.Line(_,h),null,null,[.8,1,1]]],Y:[[new THREE.Mesh(b,a),[0,.8,0]],[new THREE.Line(_,m),null,[0,0,Math.PI/2],[.8,1,1]]],Z:[[new THREE.Mesh(b,r),[0,0,.8],[Math.PI/2,0,0]],[new THREE.Line(_,p),null,[0,-Math.PI/2,0],[.8,1,1]]],XY:[[new THREE.Mesh(b,c),[.85,.85,0],null,[2,2,.2]],[new THREE.Line(_,g),[.855,.98,0],null,[.125,1,1]],[new THREE.Line(_,g),[.98,.855,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new THREE.Mesh(b,l),[0,.85,.85],null,[.2,2,2]],[new THREE.Line(_,f),[0,.855,.98],[0,0,Math.PI/2],[.125,1,1]],[new THREE.Line(_,f),[0,.98,.855],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new THREE.Mesh(b,u),[.85,0,.85],null,[2,.2,2]],[new THREE.Line(_,v),[.855,0,.98],null,[.125,1,1]],[new THREE.Line(_,v),[.98,0,.855],[0,-Math.PI/2,0],[.125,1,1]]],XYZX:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.125,.125,.125),s),[1.1,0,0]]],XYZY:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.125,.125,.125),s),[0,1.1,0]]],XYZZ:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.125,.125,.125),s),[0,0,1.1]]]},L={X:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,.8,4,1,!1),n),[.5,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,.8,4,1,!1),n),[0,.5,0]]],Z:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,.8,4,1,!1),n),[0,0,.5],[Math.PI/2,0,0]]],XY:[[new THREE.Mesh(b,n),[.85,.85,0],null,[3,3,.2]]],YZ:[[new THREE.Mesh(b,n),[0,.85,.85],null,[.2,3,3]]],XZ:[[new THREE.Mesh(b,n),[.85,0,.85],null,[3,.2,3]]],XYZX:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.2,.2,.2),n),[1.1,0,0]]],XYZY:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.2,.2,.2),n),[0,1.1,0]]],XYZZ:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.2,.2,.2),n),[0,0,1.1]]]},k={X:[[new THREE.Line(_,i.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new THREE.Line(_,i.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new THREE.Line(_,i.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},$={X:[[new THREE.Mesh(y,o),[1,0,0],[0,0,-Math.PI/2],null,"fwd"],[new THREE.Mesh(y,o),[1,0,0],[0,0,Math.PI/2],null,"bwd"],[new THREE.Line(_,h)]],Y:[[new THREE.Mesh(y,a),[0,1,0],null,null,"fwd"],[new THREE.Mesh(y,a),[0,1,0],[Math.PI,0,0],null,"bwd"],[new THREE.Line(_,m),null,[0,0,Math.PI/2]]],Z:[[new THREE.Mesh(y,r),[0,0,1],[Math.PI/2,0,0],null,"fwd"],[new THREE.Mesh(y,r),[0,0,1],[-Math.PI/2,0,0],null,"bwd"],[new THREE.Line(_,p),null,[0,-Math.PI/2,0]]],XYZ:[[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.1,0),s),[0,0,0],[0,0,0]]]},O={X:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.2,0),n)]]},I={START:[[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.01,2),i),null,null,null,"helper"]],END:[[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.01,2),i),null,null,null,"helper"]],DELTA:[[new THREE.Line(x(),i),null,null,null,"helper"]]},D=function(e){var t=new THREE.Object3D;for(var n in e)for(var i=e[n].length;i--;){var o=e[n][i][0].clone(),a=e[n][i][1],r=e[n][i][2],s=e[n][i][3],c=e[n][i][4];o.name=n,o.tag=c,a&&o.position.set(a[0],a[1],a[2]),r&&o.rotation.set(r[0],r[1],r[2]),s&&o.scale.set(s[0],s[1],s[2]),o.updateMatrix();var l=o.geometry.clone();l.applyMatrix(o.matrix),o.geometry=l,o.position.set(0,0,0),o.rotation.set(0,0,0),o.scale.set(1,1,1),t.add(o)}return t},F=new THREE.Vector3(0,0,0),z=new THREE.Euler,B=new THREE.Vector3(0,1,0),j=new THREE.Vector3(0,0,0),Y=new THREE.Matrix4,X=new THREE.Quaternion,V=new THREE.Quaternion,q=new THREE.Quaternion,U=new THREE.Vector3(1,0,0),Z=new THREE.Vector3(0,1,0),N=new THREE.Vector3(0,0,1);this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=D(R)),this.add(this.gizmo.rotate=D(H)),this.add(this.gizmo.scale=D(C)),this.add(this.gizmo.orbit=D($)),this.add(this.picker.translate=D(M)),this.add(this.picker.rotate=D(A)),this.add(this.picker.scale=D(L)),this.add(this.picker.orbit=D(O)),this.add(this.helper.translate=D(P)),this.add(this.helper.rotate=D(S)),this.add(this.helper.scale=D(k)),this.add(this.helper.orbit=D(I)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1,this.picker.orbit.visible=!1,this.updateMatrixWorld=function(){var e=this.space;"scale"===this.mode&&(e="local");var t="local"===e?this.worldQuaternion:q;this.gizmo.translate.visible="translate"===this.mode,this.gizmo.rotate.visible="rotate"===this.mode,this.gizmo.scale.visible="scale"===this.mode,this.gizmo.orbit.visible="orbit"===this.mode,this.helper.translate.visible="translate"===this.mode,this.helper.rotate.visible="rotate"===this.mode,this.helper.scale.visible="scale"===this.mode,this.helper.orbit.visible="orbit"===this.mode;var n=[];n=(n=(n=n.concat(this.picker[this.mode].children)).concat(this.gizmo[this.mode].children)).concat(this.helper[this.mode].children);for(var i=0;i<n.length;i++){var o=n[i];o.visible=!0,o.rotation.set(0,0,0),o.position.copy(this.worldPosition);var a=this.worldPosition.distanceTo(this.cameraPosition);if(o.scale.set(1,1,1).multiplyScalar(a*this.size/7),"helper"!==o.tag){if(o.quaternion.copy(t),"translate"===this.mode||"scale"===this.mode||"orbit"===this.mode){"X"!==o.name&&"XYZX"!==o.name||.99<Math.abs(B.copy(U).applyQuaternion(t).dot(this.eye))&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),"Y"!==o.name&&"XYZY"!==o.name||.99<Math.abs(B.copy(Z).applyQuaternion(t).dot(this.eye))&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),"Z"!==o.name&&"XYZZ"!==o.name||.99<Math.abs(B.copy(N).applyQuaternion(t).dot(this.eye))&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),"XY"===o.name&&Math.abs(B.copy(N).applyQuaternion(t).dot(this.eye))<.2&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),"YZ"===o.name&&Math.abs(B.copy(U).applyQuaternion(t).dot(this.eye))<.2&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),"XZ"===o.name&&Math.abs(B.copy(Z).applyQuaternion(t).dot(this.eye))<.2&&(o.scale.set(1e-10,1e-10,1e-10),o.visible=!1),-1!==o.name.search("X")&&(B.copy(U).applyQuaternion(t).dot(this.eye)<-.4?"fwd"===o.tag?o.visible=!1:o.scale.x*=-1:"bwd"===o.tag&&(o.visible=!1)),-1!==o.name.search("Y")&&(B.copy(Z).applyQuaternion(t).dot(this.eye)<-.4?"fwd"===o.tag?o.visible=!1:o.scale.y*=-1:"bwd"===o.tag&&(o.visible=!1)),-1!==o.name.search("Z")&&(B.copy(N).applyQuaternion(t).dot(this.eye)<-.4?"fwd"===o.tag?o.visible=!1:o.scale.z*=-1:"bwd"===o.tag&&(o.visible=!1))}else"rotate"===this.mode&&(V.copy(t),B.copy(this.eye).applyQuaternion(X.copy(t).inverse()),-1!==o.name.search("E")&&o.quaternion.setFromRotationMatrix(Y.lookAt(this.eye,j,Z)),"X"===o.name&&(X.setFromAxisAngle(U,Math.atan2(-B.y,B.z)),X.multiplyQuaternions(V,X),o.quaternion.copy(X)),"Y"===o.name&&(X.setFromAxisAngle(Z,Math.atan2(B.x,B.z)),X.multiplyQuaternions(V,X),o.quaternion.copy(X)),"Z"===o.name&&(X.setFromAxisAngle(N,Math.atan2(B.y,B.x)),X.multiplyQuaternions(V,X),o.quaternion.copy(X)));o.visible=o.visible&&(-1===o.name.indexOf("X")||this.showX),o.visible=o.visible&&(-1===o.name.indexOf("Y")||this.showY),o.visible=o.visible&&(-1===o.name.indexOf("Z")||this.showZ),o.visible=o.visible&&(-1===o.name.indexOf("E")||this.showX&&this.showY&&this.showZ),o.material._opacity=o.material._opacity||o.material.opacity,o.material._color=o.material._color||o.material.color.clone(),o.material.color.copy(o.material._color),o.material.opacity=o.material._opacity,this.enabled?this.axis&&(o.name===this.axis?o.material.opacity=1:this.axis.split("").some(function(e){return o.name===e})?o.material.opacity=1:o.material.opacity*=.25,o.material.color.lerp(new THREE.Color(1,1,1),.5)):(o.material.opacity*=.5,o.material.color.lerp(new THREE.Color(1,1,1),.5))}else o.visible=!1,"AXIS"===o.name?(o.position.copy(this.worldPositionStart),o.visible=!!this.axis,"X"===this.axis&&(X.setFromEuler(z.set(0,0,0)),o.quaternion.copy(t).multiply(X),.9<Math.abs(B.copy(U).applyQuaternion(t).dot(this.eye))&&(o.visible=!1)),"Y"===this.axis&&(X.setFromEuler(z.set(0,0,Math.PI/2)),o.quaternion.copy(t).multiply(X),.9<Math.abs(B.copy(Z).applyQuaternion(t).dot(this.eye))&&(o.visible=!1)),"Z"===this.axis&&(X.setFromEuler(z.set(0,Math.PI/2,0)),o.quaternion.copy(t).multiply(X),.9<Math.abs(B.copy(N).applyQuaternion(t).dot(this.eye))&&(o.visible=!1)),"XYZE"===this.axis&&(X.setFromEuler(z.set(0,Math.PI/2,0)),B.copy(this.rotationAxis),o.quaternion.setFromRotationMatrix(Y.lookAt(j,B,Z)),o.quaternion.multiply(X),o.visible=this.dragging),"E"===this.axis&&(o.visible=!1)):"START"===o.name?(o.position.copy(this.worldPositionStart),o.visible=this.dragging):"END"===o.name?(o.position.copy(this.worldPosition),o.visible=this.dragging):"DELTA"===o.name?(o.position.copy(this.worldPositionStart),o.quaternion.copy(this.worldQuaternionStart),F.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),F.applyQuaternion(this.worldQuaternionStart.clone().inverse()),o.scale.copy(F),o.visible=this.dragging):(o.quaternion.copy(t),this.dragging?o.position.copy(this.worldPositionStart):o.position.copy(this.worldPosition),this.axis&&(o.visible=-1!==this.axis.search(o.name)))}THREE.Object3D.prototype.updateMatrixWorld.call(this)}};V.prototype=Object.assign(Object.create(THREE.Object3D.prototype),{constructor:V,isTransformControlsGizmo:!0});var q=function(){THREE.Mesh.call(this,new THREE.PlaneBufferGeometry(1e5,1e5,2,2),new THREE.MeshBasicMaterial({visible:!0,wireframe:!0,side:THREE.DoubleSide,transparent:!0,opacity:.1})),this.type="TransformControlsPlane";var t=new THREE.Vector3(1,0,0),n=new THREE.Vector3(0,1,0),i=new THREE.Vector3(0,0,1),o=new THREE.Vector3,a=new THREE.Vector3,r=new THREE.Vector3,s=new THREE.Matrix4,c=new THREE.Quaternion;this.updateMatrixWorld=function(){var e=this.space;switch(this.position.copy(this.worldPosition),"scale"===this.mode&&(e="local"),t.set(1,0,0).applyQuaternion("local"===e?this.worldQuaternion:c),n.set(0,1,0).applyQuaternion("local"===e?this.worldQuaternion:c),i.set(0,0,1).applyQuaternion("local"===e?this.worldQuaternion:c),r.copy(n),this.mode){case"translate":case"scale":switch(this.axis){case"X":r.copy(this.eye).cross(t),a.copy(t).cross(r);break;case"Y":r.copy(this.eye).cross(n),a.copy(n).cross(r);break;case"Z":r.copy(this.eye).cross(i),a.copy(i).cross(r);break;case"XY":a.copy(i);break;case"YZ":a.copy(t);break;case"XZ":r.copy(i),a.copy(n);break;case"XYZ":case"E":a.set(0,0,0)}break;case"rotate":case"orbit":default:a.set(0,0,0)}0===a.length()?this.quaternion.copy(this.cameraQuaternion):(s.lookAt(o.set(0,0,0),a,r),this.quaternion.setFromRotationMatrix(s)),THREE.Object3D.prototype.updateMatrixWorld.call(this)}};q.prototype=Object.assign(Object.create(THREE.Mesh.prototype),{constructor:q,isTransformControlsPlane:!0});var c=function(s,e){this.cfg=e,this.enabled=e.enabled,this.defaultPoint={image:e.image,width:e.width,height:e.height,opacity:e.opacity},this.transformControl=new m(s.viewer.$canvas.get(0),s.camera),this.transformControl.mode="orbit",s.scene.add(this.transformControl);var c=this,n={ESCAPE:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46},l=new THREE.Raycaster,o=this.transformControl;this.bind=function(){s.viewer.$canvas.on("keydown",t),s.viewer.$canvas.on("keyup",i),s.viewer.$canvas.on("click",a),s.viewer.$canvas.on("dblclick",r),o.addEventListener("dragging-changed",u),o.addEventListener("mode-changed",d)},this.unbind=function(){s.viewer.$canvas.off("keydown",t),s.viewer.$canvas.off("keyup",i),s.viewer.$canvas.off("click",a),s.viewer.$canvas.off("dblclick",r),o.removeEventListener("dragging-changed",u),o.removeEventListener("mode-changed",d)},this.detach=function(){o.detach()},this.attach=function(e){e&&o.attach(e.mesh)},this.getSceneIntersectPoint=function(e,t){var n=s.viewer.$canvas.get(0).getBoundingClientRect(),i=new THREE.Vector2;i.x=(e-n.left)/n.width*2-1,i.y=-(t-n.top)/n.height*2+1,l.setFromCamera(i,s.camera);var o=l.intersectObjects([s.mesh],!1);if(o.length){var a=o[0].point,r=new THREE.Vector3;return s.mesh.getWorldPosition(r),new THREE.Vector3(parseFloat((a.x-r.x).toFixed(2)),parseFloat((a.y-r.y).toFixed(2)),parseFloat((a.z-r.z).toFixed(2)))}return null},this.addPointToCenter=function(e){var t=s.viewer.$canvas.get(0).getBoundingClientRect(),n=t.left+t.width/2,i=t.top+t.height/2,o=s.scene.position.clone(),a=c.getSceneIntersectPoint(n,i),r=(o.distanceTo(a),new THREE.Vector3);return r.addVectors(o,a.normalize().multiplyScalar(500)),s.addPoint(c.createPoint(r),e)},this.createPoint=function(e){var t=new h({pos:e,image:c.defaultPoint.image,width:c.defaultPoint.width,height:c.defaultPoint.height,opacity:c.defaultPoint.opacity});return t};var t=function(e){c.enabled},i=function(e){if(!1!==c.enabled&&o.object)switch(e.keyCode){case n.DELETE:if("point"==o.object.userData.type){var t=s.findPointByMesh(o.object);o.detach(),s.removePoint(t)}break;case n.ESCAPE:o.object&&s.deselectPoint(o.object.userData.point),o.detach()}},a=function(e){if(!1!==c.enabled){var t=s.viewer.$canvas.get(0).getBoundingClientRect(),n=new THREE.Vector2;n.x=(e.clientX-t.left)/t.width*2-1,n.y=-(e.clientY-t.top)/t.height*2+1,l.setFromCamera(n,s.camera);var i=l.intersectObjects(s.scene.children);i.length&&"point"===i[0].object.userData.type?o.object!==i[0].object&&(o.attach(i[0].object),s.selectPoint(o.object.userData.point)):(o.object&&s.deselectPoint(o.object.userData.point),o.detach())}},r=function(e){if(!1!==c.enabled){var t=s.scene.position.clone(),n=c.getSceneIntersectPoint(e.clientX,e.clientY),i=(t.distanceTo(n),new THREE.Vector3);i.addVectors(t,n.normalize().multiplyScalar(500)),s.addPoint(c.createPoint(i))}},u=function(e){e.value?s.dragstartPoint(e.target.object.userData.point):s.dragendPoint(e.target.object.userData.point),s.control.enabled=!e.value},d=function(e){s.transformModeChanged(e.value)}},l=function(a){var r=this,n=new THREE.Frustum,s=null;this.bind=function(){a.control.addEventListener("change",e),a.control.addEventListener("start",t),a.control.addEventListener("end",l)},this.unbind=function(){a.control.removeEventListener("change",e),a.control.removeEventListener("start",t),a.control.removeEventListener("end",l)},this.update=function(){n.setFromMatrix((new THREE.Matrix4).multiplyMatrices(a.camera.projectionMatrix,a.camera.matrixWorldInverse));for(var e=null,t=0;t<a.points.length;t++)e=a.points[t],o(n,e,!0)},this.show=function(){n.setFromMatrix((new THREE.Matrix4).multiplyMatrices(a.camera.projectionMatrix,a.camera.matrixWorldInverse));for(var e=null,t=0;t<a.points.length;t++){var e=a.points[t];e.mesh.visible=!0,o(n,e,!1)}},this.hide=function(){for(var e=0;e<a.points.length;e++){var t=a.points[e];i(t)}},this.getScreenCoord=function(e){return e.project(a.camera),e.x=Math.round((.5+e.x/2)*(a.viewer.$canvas.get(0).width/window.devicePixelRatio)),e.y=Math.round((.5-e.y/2)*(a.viewer.$canvas.get(0).height/window.devicePixelRatio)),{x:e.x,y:e.y}};var i=function(e){e.mesh.visible=!1,e.visible&&(e.visible=!1,a.viewer.$listener.trigger("ipanorama:scene-point-hide",{scene:a,point:e}))},o=function(e,t,n){e.containsPoint(t.mesh.position)?(c(t),t.visible||(t.visible=!0,a.viewer.$listener.trigger("ipanorama:scene-point-show",{scene:a,point:t})),n&&a.viewer.$listener.trigger("ipanorama:scene-point-change",{scene:a,point:t})):t.visible&&(t.visible=!1,a.viewer.$listener.trigger("ipanorama:scene-point-hide",{scene:a,point:t}))},c=function(e){e.mesh.quaternion.copy(a.camera.quaternion);var t=e.mesh.position.clone();if(e.screenPos=r.getScreenCoord(t),s!=a.camera.fov){e.mesh.updateMatrixWorld();var n=e.mesh.geometry.vertices[0].clone(),i=e.mesh.geometry.vertices[1].clone(),o=e.mesh.geometry.vertices[2].clone();n.applyMatrix4(e.mesh.matrixWorld),i.applyMatrix4(e.mesh.matrixWorld),o.applyMatrix4(e.mesh.matrixWorld),n=r.getScreenCoord(n),i=r.getScreenCoord(i),o=r.getScreenCoord(o),e.screenWidth=i.x-n.x,e.screenHeight=o.y-n.y,s=a.camera.fov}},e=function(){r.update()},t=function(){},l=function(){}},h=function(t){this.cfg=t,this.loaded=!1,this.yaw=null,this.pitch=null,this.radius=null,this.texture=null,this.geometry=new THREE.PlaneGeometry(t.width,t.height),this.material=new THREE.ShaderMaterial({uniforms:{texture:{value:null},opacity:{value:t.opacity}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * (modelViewMatrix * vec4(0.0, 0.0, 0.0, 1.0) + vec4(position.x, position.y, 0.0, 0.0));","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D texture;","uniform float opacity;","void main() {","vec2 uv = vUv;","vec4 fragColor = texture2D(texture, uv);","fragColor.a *= opacity;","if (fragColor.a < 0.3 ) discard;","gl_FragColor = fragColor;","}"].join("\n"),side:THREE.DoubleSide,transparent:!0,depthTest:!1,depthWrite:!1}),this.mesh=new THREE.Mesh(this.geometry,this.material),(this.mesh.userData.point=this).mesh.userData.type="point",this.mesh.visible=!1;var s=this;this.load=function(e){(e=e||t.image)?"string"==typeof e?B.TextureLoader.load(e,n,i,o,!1):e instanceof HTMLImageElement&&n(new THREE.Texture(e)):console.warn("IPANORAMA.Point: image source undefined")},this.setYawPitch=function(e,t,n){n=0<n?n:1,s.yaw=e,s.pitch=t,s.radius=n;var i,o,a,r=(o=(180-e)*ne,a=t*ne,{x:(i=0<(i=n)?i:1)*Math.cos(a)*Math.sin(o),y:i*Math.sin(a),z:i*Math.cos(a)*Math.cos(o)});s.mesh.position.set(r.x,r.y,r.z)},this.getYawPitch=function(){return e=s.mesh.position,t=Math.atan2(e.x,-e.z),n=Math.sqrt(e.x*e.x+e.z*e.z),i=Math.atan2(e.y,n),o=Math.sqrt(n*n+e.y*e.y),a=t*ie,{yaw:a=(a%=360)<0?a+360:a,pitch:i*ie,radius:o};var e,t,n,i,o,a},this.setTexture=function(e){s.texture&&s.texture.dispose(),s.texture=e,s.material.uniforms.texture.value=s.texture,s.material.needsUpdate=!0},this.setOpacity=function(e){s.material.uniforms.opacity.value=e,s.material.needsUpdate=!0},this.destroy=function(){s.geometry&&s.geometry.dispose(),s.material&&s.material.dispose(),s.texture&&s.texture.dispose()};var n=function(e){s.loaded=!0,s.setTexture(e)},i=function(e){},o=function(){console.warn("IPANORAMA.Point: undefined error while loading")},e=t.pos;e?s.mesh.position.set(e.x,e.y,e.z):t.hasOwnProperty("yaw")&&t.hasOwnProperty("pitch")&&s.setYawPitch(t.yaw,t.pitch,t.radius)},u=function(c,e){this.cfg=e,this.enabled=e.enabled,this.defaultPlane={image:e.image,width:e.width,height:e.height,opacity:e.opacity,billboard:e.billboard},this.transformControl=new m(c.viewer.$canvas.get(0),c.camera),this.transformControl.mode="translate",c.scene.add(this.transformControl);var l=this,i={ESCAPE:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46,TAB:9},o=["translate","rotate"],s=new THREE.Raycaster,a=this.transformControl;this.bind=function(){c.viewer.$canvas.on("keydown",t),c.viewer.$canvas.on("keyup",n),c.viewer.$canvas.on("click",r),c.viewer.$canvas.on("dblclick",u),a.addEventListener("dragging-changed",d),a.addEventListener("mode-changed",h)},this.unbind=function(){c.viewer.$canvas.off("keydown",t),c.viewer.$canvas.off("keyup",n),c.viewer.$canvas.off("click",r),c.viewer.$canvas.off("dblclick",u),a.removeEventListener("dragging-changed",d),a.removeEventListener("mode-changed",h)},this.detach=function(){a.detach()},this.attach=function(e){e&&a.attach(e.mesh)},this.getSceneIntersectPoint=function(e,t){var n=c.viewer.$canvas.get(0).getBoundingClientRect(),i=new THREE.Vector2;i.x=(e-n.left)/n.width*2-1,i.y=-(t-n.top)/n.height*2+1,s.setFromCamera(i,c.camera);var o=s.intersectObjects([c.mesh],!1);if(o.length){var a=o[0].point,r=new THREE.Vector3;return c.mesh.getWorldPosition(r),new THREE.Vector3(parseFloat((a.x-r.x).toFixed(2)),parseFloat((a.y-r.y).toFixed(2)),parseFloat((a.z-r.z).toFixed(2)))}return null},this.addPlaneToCenter=function(e){var t=c.viewer.$canvas.get(0).getBoundingClientRect(),n=t.left+t.width/2,i=t.top+t.height/2,o=c.scene.position.clone(),a=l.getSceneIntersectPoint(n,i),r=(o.distanceTo(a),new THREE.Vector3),s={x:THREE.Math.radToDeg(c.camera.rotation.x),y:THREE.Math.radToDeg(c.camera.rotation.y),z:THREE.Math.radToDeg(c.camera.rotation.z)};return r.addVectors(o,a.normalize().multiplyScalar(500)),c.addPlane(l.createPlane(r,s),e)},this.createPlane=function(e,t){var n=new p({pos:e,rotate:t,image:l.defaultPlane.image,width:l.defaultPlane.width,height:l.defaultPlane.height,opacity:l.defaultPlane.opacity,billboard:l.defaultPlane.billboard});return n};var t=function(e){if(!1!==l.enabled)return!a.object&&void 0},n=function(e){if(!1!==l.enabled&&a.object)switch(e.keyCode){case i.DELETE:if("plane"==a.object.userData.type){var t=c.findPlaneByMesh(a.object);a.detach(),c.removePlane(t)}break;case i.ESCAPE:a.object&&c.deselectPlane(a.object.userData.plane),a.detach();break;case i.TAB:for(var n=0;n<o.length&&o[n]!=a.mode;n++);a.mode=o[n<o.length-1?n+1:0]}},r=function(e){if(!1!==l.enabled){var t=c.viewer.$canvas.get(0).getBoundingClientRect(),n=new THREE.Vector2;n.x=(e.clientX-t.left)/t.width*2-1,n.y=-(e.clientY-t.top)/t.height*2+1,s.setFromCamera(n,c.camera);var i=s.intersectObjects(c.scene.children);i.length&&"plane"===i[0].object.userData.type?a.object!==i[0].object&&(a.attach(i[0].object),c.selectPlane(a.object.userData.plane)):(a.object&&c.deselectPlane(a.object.userData.plane),a.detach())}},u=function(e){if(!1!==l.enabled){var t=c.scene.position.clone(),n=l.getSceneIntersectPoint(e.clientX,e.clientY),i=(t.distanceTo(n),new THREE.Vector3),o={x:THREE.Math.radToDeg(c.camera.rotation.x),y:THREE.Math.radToDeg(c.camera.rotation.y),z:THREE.Math.radToDeg(c.camera.rotation.z)};i.addVectors(t,n.normalize().multiplyScalar(500)),c.addPlane(l.createPlane(i,o))}},d=function(e){e.value?c.dragstartPlane(e.target.object.userData.plane):c.dragendPlane(e.target.object.userData.plane),c.control.enabled=!e.value},h=function(e){c.transformModeChanged(e.value)}},p=function(t){this.cfg=t,this.loaded=!1,this.texture=null,this.geometry=new THREE.PlaneGeometry(t.width,t.height),this.material=new THREE.ShaderMaterial({uniforms:{texture:{value:null},opacity:{value:t.opacity},billboard:{value:t.billboard}},vertexShader:["varying vec2 vUv;","uniform bool billboard;","void main() {","vUv = uv;","if(billboard) {","gl_Position = projectionMatrix * (modelViewMatrix * vec4(0.0, 0.0, 0.0, 1.0) + vec4(position.x, position.y, 0.0, 0.0));","} else {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D texture;","uniform vec3 color;","uniform float opacity;","void main() {","vec2 uv = vUv;","vec4 fragColor = texture2D(texture, uv);","fragColor.a *= opacity;","if (fragColor.a < 0.3 ) discard;","gl_FragColor = fragColor;","}"].join("\n"),side:THREE.DoubleSide,transparent:!0}),this.mesh=new THREE.Mesh(this.geometry,this.material),(this.mesh.userData.plane=this).mesh.userData.type="plane",this.mesh.visible=!0,this.mesh.position.set(t.pos.x,t.pos.y,t.pos.z),this.mesh.rotation.x=THREE.Math.degToRad(t.rotate.x),this.mesh.rotation.y=THREE.Math.degToRad(t.rotate.y),this.mesh.rotation.z=THREE.Math.degToRad(t.rotate.z);var n=this;this.load=function(e){(e=e||t.image)?"string"==typeof e?B.TextureLoader.load(e,i,o,a,!1):e instanceof HTMLImageElement&&i(new THREE.Texture(e)):console.warn("IPANORAMA.Plane: image source undefined")},this.setTexture=function(e){n.texture&&n.texture.dispose(),n.texture=e,n.material.uniforms.texture.value=n.texture,n.material.needsUpdate=!0},this.setOpacity=function(e){n.material.uniforms.opacity.value=e,n.material.needsUpdate=!0},this.setBillboard=function(e){n.material.uniforms.billboard.value=e,n.material.needsUpdate=!0},this.destroy=function(){n.geometry&&n.geometry.dispose(),n.material&&n.material.dispose(),n.texture&&n.texture.dispose()};var i=function(e){n.loaded=!0,n.setTexture(e)},o=function(e){},a=function(){console.warn("IPANORAMA.Plane: undefined error while loading")}},d=function(e,t){this.cfg=t,this.enabled=t.enabled,this.speedX=t.speedX,this.speedY=t.speedY,this.speedZ=t.speedZ,this.startDelay=t.startDelay,this.inactivityDelay=t.inactivityDelay;var n=this,i=!1,o=null,a=null;this.bind=function(){e.control.addEventListener("end",r),n.start()},this.unbind=function(){e.control.removeEventListener("end",r),n.stop()},this.start=function(){i&&o?n.enabled&&(e.control.autoRotate=!0,e.control.autoRotateSpeedX=n.speedX,e.control.autoRotateSpeedY=n.speedY,e.control.autoRotateSpeedZ=n.speedZ):(clearTimeout(o),o=setTimeout(c,n.startDelay))},this.stop=function(){clearTimeout(a),a=setTimeout(s,n.inactivityDelay),e.control.autoRotate=!1};var r=function(){n.stop()},s=function(){n.start()},c=function(){i=!0,n.start()}},f=function(e,t,n){var i=t.$canvas.get(0).clientWidth,o=t.$canvas.get(0).clientHeight,a={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat,stencilBuffer:!1};this.cfg=e,this.viewer=t,this.smartRequest=n,this.loaded=!1,this.afterRender=!0,this.raycaster=new THREE.Raycaster,this.fbo=new THREE.WebGLRenderTarget(i,o,a),this.camera=new THREE.PerspectiveCamera(e.cameraFov,i/o,1,1e5),this.camera.position.z=1,this.camera.updateProjectionMatrix(),this.sceneDfd=null,this.scene=null,this.mesh=null};Object.assign(f.prototype,{update:function(){},render:function(e,t){this.loaded&&(e.setClearColor(0),t?(e.setRenderTarget(this.fbo),e.clear()):e.setRenderTarget(null),e.render(this.scene,this.camera),this.afterRender&&(this.pointControl&&this.pointControl.update(),this.afterRender=!1))},load:function(){this.viewer.$listener.trigger("ipanorama:scene-before-load",{scene:this})},onLoad:function(){this.loaded=!0,this.afterRender=!0,this.viewer.$listener.trigger("ipanorama:scene-after-load",{scene:this}),this.onReady()},onReady:function(){this.sceneDfd&&this.sceneDfd.resolve()},onProgress:function(e){this.viewer.$listener.trigger("ipanorama:scene-progress",{scene:this,progress:e})},onError:function(){this.loaded=!1,this.sceneDfd&&this.sceneDfd.reject(),this.viewer.$listener.trigger("ipanorama:scene-error",{scene:this})},onShowStart:function(){this.viewer.$listener.trigger("ipanorama:scene-show-start",{scene:this})},onShowUpdate:function(e){},onShowComplete:function(){this.viewer.$listener.trigger("ipanorama:scene-show-complete",{scene:this})},onHideStart:function(){this.viewer.$listener.trigger("ipanorama:scene-hide-start",{scene:this})},onHideUpdate:function(e){},onHideComplete:function(){this.viewer.$listener.trigger("ipanorama:scene-hide-complete",{scene:this})},onWindowResize:function(e,t){this.camera instanceof THREE.PerspectiveCamera&&(this.camera.aspect=e/t,this.camera.updateProjectionMatrix()),this.fbo.setSize(e,t),this.pointControl&&this.pointControl.update()},get:function(){return this.sceneDfd&&this.sceneDfd.reject(),this.sceneDfd=new ee.Deferred,this.sceneDfd.promise()},destroy:function(){this.control&&this.control.destroy(),this.control=null},addPoint:function(e,t){return this.points&&e?(e.load(),this.points.push(e),this.scene.add(e.mesh),!t&&this.viewer.$listener.trigger("ipanorama:scene-point-add",{scene:this,point:e}),this.loaded&&this.pointControl.show(),e):null},removePoint:function(e,t){if(this.points&&e){for(var n=null,i=0;i<this.points.length;i++)Object.is(e,this.points[i])&&(n=i);null!=n&&(this.pointEditor&&this.pointEditor.detach(),e=this.points[n],this.scene.remove(e.mesh),e.destroy(),this.points.splice(n,1),!t&&this.viewer.$listener.trigger("ipanorama:scene-point-remove",{scene:this,point:e}))}},removePoints:function(e){if(this.points){this.pointEditor&&this.pointEditor.detach();for(var t=0;t<this.points.length;t++){var n=this.points[t];this.scene.remove(n.mesh),n.destroy(),!e&&this.viewer.$listener.trigger("ipanorama:scene-point-remove",{scene:this,point:n})}this.points=[]}},dragstartPoint:function(e){this.points&&e&&this.viewer.$listener.trigger("ipanorama:scene-point-dragstart",{scene:this,point:e})},dragendPoint:function(e){this.points&&e&&this.viewer.$listener.trigger("ipanorama:scene-point-dragend",{scene:this,point:e})},selectPoint:function(e){this.points&&e&&this.viewer.$listener.trigger("ipanorama:scene-point-select",{scene:this,point:e})},deselectPoint:function(e){this.points&&e&&this.viewer.$listener.trigger("ipanorama:scene-point-deselect",{scene:this,point:e})},findPointByMesh:function(e){for(var t=0;t<this.points.length;t++)if(Object.is(e,this.points[t].mesh))return this.points[t];return null},addPlane:function(e,t){return this.planes&&e?(e.load(),this.planes.push(e),this.scene.add(e.mesh),!t&&this.viewer.$listener.trigger("ipanorama:scene-plane-add",{scene:this,plane:e}),e):null},removePlane:function(e,t){if(this.planes&&e){for(var n=null,i=0;i<this.planes.length;i++)Object.is(e,this.planes[i])&&(n=i);null!=n&&(this.planeEditor&&this.planeEditor.detach(),e=this.planes[n],this.scene.remove(e.mesh),e.destroy(),this.planes.splice(n,1),!t&&this.viewer.$listener.trigger("ipanorama:scene-plane-remove",{scene:this,plane:e}))}},removePlanes:function(e){if(this.planes){this.planeEditor&&this.planeEditor.detach();for(var t=0;t<this.planes.length;t++){var n=this.planes[t];this.scene.remove(n.mesh),n.destroy(),!e&&this.viewer.$listener.trigger("ipanorama:scene-plane-remove",{scene:this,plane:n})}this.planes=[]}},dragstartPlane:function(e){this.planes&&e&&this.viewer.$listener.trigger("ipanorama:scene-plane-dragstart",{scene:this,plane:e})},dragendPlane:function(e){this.planes&&e&&this.viewer.$listener.trigger("ipanorama:scene-plane-dragend",{scene:this,plane:e})},selectPlane:function(e){this.planes&&e&&this.viewer.$listener.trigger("ipanorama:scene-plane-select",{scene:this,plane:e})},deselectPlane:function(e){this.planes&&e&&this.viewer.$listener.trigger("ipanorama:scene-plane-deselect",{scene:this,plane:e})},findPlaneByMesh:function(e){for(var t=0;t<this.planes.length;t++)if(Object.is(e,this.planes[t].mesh))return this.planes[t];return null},transformModeChanged:function(e){this.viewer.$listener.trigger("ipanorama:transform-mode-changed",{scene:this,mode:e})},lookAt:function(e,t,n){this.control&&this.control.lookAt(e,t,n)},setProperty:function(e,t){return!1}});var e=function(e,t,n){for(var i in f.call(this,e,t,n),this.image=null,this.texture=null,this.radius=5e3,this.geometry=new THREE.BoxGeometry(2*this.radius,2*this.radius,2*this.radius,32,32,32),this.geometry.vertices){var o=this.geometry.vertices[i];o.normalize().multiplyScalar(this.radius)}function a(e){var t=new THREE.ShaderMaterial({uniforms:{texture:{value:null},backgroundColor:{value:new THREE.Color(0)},haov:{value:360},vaov:{value:180},vOffset:{value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D texture;","uniform vec3 backgroundColor;","uniform float haov;","uniform float vaov;","uniform float vOffset;","const float PI = 3.14159265359;","const float PI2 = PI * 2.0;","const float PI_DIV_2 = PI / 2.0;","const int RIGHT  = 0;","const int LEFT   = 1;","const int UP     = 2;","const int DOWN   = 3;","const int FRONT  = 4;","const int BACK   = 5;","vec3 uvToXYZ(vec2 uv, int faceIndex) {","float a = 2.0 * uv.x;","float b = 2.0 * uv.y;","vec3 result;","if(faceIndex == RIGHT) {","result = vec3(a - 1.0, -1.0, 1.0 - b);","} else if(faceIndex == LEFT) {","result = vec3(1.0 - a, 1.0, 1.0 - b);","} else if(faceIndex == UP) {","result = vec3(1.0 - b, a - 1.0, -1.0);","} else if(faceIndex == DOWN) {","result = vec3(b - 1.0, a - 1.0, 1.0);","} else if(faceIndex == FRONT) {","result = vec3(1.0, a - 1.0, 1.0 - b);","} else if(faceIndex == BACK) {","result = vec3(-1.0, 1.0 - a, 1.0 - b);","}","return result;","}","void main() {","vec2 uv = vUv;","uv.x = 1.0 - uv.x;","vec3 xyz = uvToXYZ(uv, "+e+");","float x = xyz.x;","float y = xyz.y;","float z = xyz.z;","float theta = atan(y, x);","float r = pow(x * x + y * y, 0.5);","float phi = PI_DIV_2 - atan(z, r);","float yaw = theta * 180.0 / PI + 180.0;","float pitch = phi * 180.0 / PI - 90.0;","if(yaw > 180.0) {","yaw -= 360.0;","}","if(yaw > -(haov/2.0) && yaw < (haov/2.0) && (pitch > (-vaov/2.0 + vOffset) && pitch < (vaov/2.0 + vOffset))) {","float uf = (yaw + haov/2.0)/haov;","float vf = (pitch - vOffset + vaov/2.0)/vaov;","gl_FragColor = texture2D(texture, vec2(uf, vf));","} else {","gl_FragColor = vec4(backgroundColor, 0);","}","}"].join("\n"),side:THREE.DoubleSide});return t}this.materials=[a(0),a(1),a(2),a(3),a(4),a(5)],this.mesh=new THREE.Mesh(this.geometry,this.materials),this.scene=new THREE.Scene,this.scene.add(this.mesh),this.control=new s(this),this.autoRotateControl=new d(this,e.autoRotate),this.points=[],this.pointEditor=new c(this,e.pointEditor),this.pointControl=new l(this),this.planes=[],this.planeEditor=new u(this,e.planeEditor)};(e.prototype=Object.create(f.prototype)).constructor=e,Object.assign(e.prototype,{update:function(){this.control.update(),f.prototype.update.call(this)},load:function(e,t){if(f.prototype.load.call(this),!e)return console.warn("IPANORAMA.SceneSphere: image source undefined"),void this.onError();"string"==typeof e?(this.smartRequest&&this.smartRequest.abort(),B.TextureLoader.load(e,this.onLoad.bind(this),t?null:this.onProgress.bind(this),this.onError.bind(this),this.smartRequest)):e instanceof HTMLImageElement&&this.onLoad(new THREE.Texture(e),e)},onLoad:function(e,t){this.image=t,this.texture&&this.texture.dispose(),this.texture=e,this.texture.minFilter=THREE.LinearFilter,this.texture.needsUpdate=!0;for(var n=0;n<this.materials.length;n++)this.materials[n].uniforms.texture.value=this.texture;window.requestAnimationFrame(function(){window.requestAnimationFrame(function(){f.prototype.onLoad.call(this)}.bind(this))}.bind(this))},onShowStart:function(){this.bind(),this.pointControl.show(),f.prototype.onShowStart.call(this)},onHideStart:function(){this.unbind(),this.pointControl.hide(),f.prototype.onHideStart.call(this)},get:function(e){return e&&this.load(this.image),f.prototype.get.call(this)},destroy:function(){this.control.destroy(),this.scene.remove(this.mesh),this.geometry&&this.geometry.dispose(),this.material&&this.material.dispose(),this.texture&&this.texture.dispose(),this.mesh=void 0,f.prototype.destroy.call(this)},bind:function(){this.control.bind(),this.autoRotateControl.bind(),this.pointEditor.bind(),this.pointControl.bind(),this.planeEditor.bind()},unbind:function(){this.control.unbind(),this.autoRotateControl.unbind(),this.pointEditor.unbind(),this.pointControl.unbind(),this.planeEditor.unbind()}});var t=function(e,t,n){f.call(this,e,t,n),this.image=e.image,this.size=5e3,this.texture=null,this.geometry=new THREE.BoxGeometry(this.size,this.size,this.size),this.material=new THREE.ShaderMaterial({uniforms:{texture:{value:new THREE.Texture},flip:{value:-1}},vertexShader:["varying vec3 vWorldDirection;","void main() {","vWorldDirection = normalize((modelMatrix * vec4(position, 0.0)).xyz);","vec4 vPosition = modelViewMatrix * vec4( position, 1.0 );","gl_Position = projectionMatrix * vPosition;","}"].join("\n"),fragmentShader:["varying vec3 vWorldDirection;","uniform samplerCube texture;","uniform float flip;","void main() {","gl_FragColor = textureCube(texture, vec3( flip * vWorldDirection.x, vWorldDirection.yz ));","}"].join("\n"),side:THREE.DoubleSide}),this.mesh=new THREE.Mesh(this.geometry,this.material),this.scene=new THREE.Scene,this.scene.add(this.mesh),this.control=new s(this),this.autoRotateControl=new d(this,e.autoRotate),this.points=[],this.pointEditor=new c(this,e.pointEditor),this.pointControl=new l(this),this.planes=[],this.planeEditor=new u(this,e.planeEditor)};(t.prototype=Object.create(f.prototype)).constructor=t,Object.assign(t.prototype,{update:function(){this.control.update(),f.prototype.update.call(this)},load:function(e){if(f.prototype.load.call(this),this.image=e||this.image,!e)return console.warn("IPANORAMA.SceneCube: the image source is undefined"),void this.onError();if("string"==typeof e)this.smartRequest&&this.smartRequest.abort(),IPANORAMA.Utils.CubeOneTextureLoader.load(this.image,this.onLoad.bind(this),this.onProgress.bind(this),this.onError.bind(this),this.smartRequest);else if(ee.isArray(e)){if(6!=e.length)return console.warn("IPANORAMA.SceneCube: the image source should be an array of 6 images"),void this.onError();this.smartRequest&&this.smartRequest.abort(),IPANORAMA.Utils.CubeSixTextureLoader.load(this.image,this.onLoad.bind(this),this.onProgress.bind(this),this.onError.bind(this),this.smartRequest)}else{if(!(e.front&&e.back&&e.left&&e.right&&e.top&&e.bottom))return console.warn("IPANORAMA.SceneCube: the image source is unknown"),void this.onError();this.smartRequest&&this.smartRequest.abort(),IPANORAMA.Utils.CubeSixTextureLoader.load(this.image,this.onLoad.bind(this),this.onProgress.bind(this),this.onError.bind(this),this.smartRequest)}},onLoad:function(e){this.texture&&this.texture.dispose(),this.texture=e,this.texture.minFilter=this.texture.magFilter=THREE.LinearFilter,this.texture.needsUpdate=!0,this.material.uniforms.texture.value=this.texture,window.requestAnimationFrame(function(){window.requestAnimationFrame(function(){f.prototype.onLoad.call(this)}.bind(this))}.bind(this))},onShowStart:function(){this.bind(),this.pointControl.show(),f.prototype.onShowStart.call(this)},onHideStart:function(){this.unbind(),this.pointControl.hide(),f.prototype.onHideStart.call(this)},get:function(e){return e&&this.load(this.image),f.prototype.get.call(this)},destroy:function(){this.scene.remove(this.mesh),this.geometry&&this.geometry.dispose(),this.material&&this.material.dispose(),this.texture&&this.texture.dispose(),this.mesh=void 0,f.prototype.destroy.call(this)},bind:function(){this.control.bind(),this.autoRotateControl.bind(),this.pointEditor.bind(),this.pointControl.bind(),this.planeEditor.bind()},unbind:function(){this.control.unbind(),this.autoRotateControl.unbind(),this.pointEditor.unbind(),this.pointControl.unbind(),this.planeEditor.unbind()}});var n=function(e,t,n){f.call(this,e,t,n),this.panoId=e.panoId,this.location=e.location,this.zoom=2,this.gsvLoader=new r.PanoLoader,this.texture=null,this.geometry=new THREE.SphereGeometry(5e3,60,40),this.material=new THREE.ShaderMaterial({uniforms:{texture:{value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D texture;","void main() {","vec2 uv = vUv;","uv.x = 1.0 - uv.x;","gl_FragColor = texture2D(texture, uv);","}"].join("\n"),side:THREE.DoubleSide}),this.mesh=new THREE.Mesh(this.geometry,this.material),this.scene=new THREE.Scene,this.scene.add(this.mesh),this.control=new s(this),this.autoRotateControl=new d(this,e.autoRotate),this.points=[],this.pointEditor=new c(this,e.pointEditor),this.pointControl=new l(this),this.planes=[],this.planeEditor=new u(this,e.planeEditor)};(n.prototype=Object.create(f.prototype)).constructor=n,Object.assign(n.prototype,{update:function(){this.control.update()},load:function(e){f.prototype.load.call(this);var t=this;if(!e)return console.warn("IPANORAMA.SceneGoogleStreetView: location source undefined"),void this.onError();if("string"==typeof e)this.panoId=e,this.gsvLoader.onPanoramaLoad=this.onPanoramaLoad.bind(this),this.gsvLoader.onProgress=this.onProgress.bind(this),this.gsvLoader.onError=function(){console.warn("IPANORAMA.SceneGoogleStreetView: location source is wrong"),t.onError()},this.gsvLoader.setZoom(this.zoom),this.gsvLoader.loadById(this.panoId);else{if(!e.hasOwnProperty("lat")||!e.hasOwnProperty("lng"))return console.warn("IPANORAMA.SceneGoogleStreetView: location source should contain lat & lng parameters"),void this.onError();this.location=e,this.gsvLoader.onPanoramaLoad=this.onPanoramaLoad.bind(this),this.gsvLoader.onProgress=this.onProgress.bind(this),this.gsvLoader.onError=function(){console.warn("IPANORAMA.SceneGoogleStreetView: location source is wrong"),t.onError()},this.gsvLoader.setZoom(this.zoom),this.gsvLoader.loadByLocation(new google.maps.LatLng(this.location.lat,this.location.lng))}},onPanoramaLoad:function(e){this.onLoad(new THREE.Texture(e))},onLoad:function(e){this.texture&&this.texture.dispose(),this.texture=e,this.texture.minFilter=this.texture.magFilter=THREE.LinearFilter,this.texture.needsUpdate=!0,this.material.uniforms.texture.value=this.texture,window.requestAnimationFrame(function(){window.requestAnimationFrame(function(){f.prototype.onLoad.call(this)}.bind(this))}.bind(this))},onShowStart:function(){this.bind(),this.pointControl.show(),f.prototype.onShowStart.call(this)},onHideStart:function(){this.unbind(),this.pointControl.hide(),f.prototype.onHideStart.call(this)},get:function(e){return e&&this.load(this.panoId||this.location),f.prototype.get.call(this)},destroy:function(){this.scene.remove(this.mesh),this.geometry&&this.geometry.dispose(),this.material&&this.material.dispose(),this.texture&&this.texture.dispose(),this.mesh=void 0,f.prototype.destroy.call(this)},bind:function(){this.control.bind(),this.autoRotateControl.bind(),this.pointEditor.bind(),this.pointControl.bind(),this.planeEditor.bind()},unbind:function(){this.control.unbind(),this.autoRotateControl.unbind(),this.pointEditor.unbind(),this.pointControl.unbind(),this.planeEditor.unbind()}});var v=function(e,t,n){this.canvas=e,this.material=t,this.scene=n,(this.scene.control=this).enabled=!0,this.noZoom=!1,this.zoomSpeed=1,this.minZoom=0,this.maxZoom=1/0,this.noRotate=!1,this.rotateSpeedX=.3,this.rotateSpeedY=.3,this.autoRotate=!1,this.autoRotateSpeedX=.3,this.autoRotateSpeedY=0,this.autoRotateSpeedZ=0,this.noKeys=!1,this.keySpeed=.3,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};var l=this,u=!1,d=new THREE.Vector2,o=new THREE.Vector3(1,0,0),a=new THREE.Vector3(0,1,0),r=new THREE.Vector3(0,0,1),s={yaw:0,pitch:0,roll:0},c=new THREE.Quaternion,h=new THREE.Quaternion,m=new THREE.Quaternion;c.setFromAxisAngle(a,-90*ne),h.setFromAxisAngle(r,90*ne),m.multiply(c).multiply(h);var i,p,f,v,g={type:"change"},w={type:"start"},E={type:"end"};function y(e,t){s.yaw=e,s.pitch=t;var n=s.yaw*ne,i=s.pitch*ne;c=new THREE.Quaternion,h=new THREE.Quaternion,m=new THREE.Quaternion,c.setFromAxisAngle(a,-90*ne),h.setFromAxisAngle(r,90*ne),m.multiply(c).multiply(h),c.setFromAxisAngle(a,-n),h.setFromAxisAngle(o,-i),m.multiply(c).multiply(h),l.update()}function b(e){l.material.uniforms.zoom.value-=e*l.zoomSpeed,l.material.uniforms.zoom.value=Math.max(l.minZoom,Math.min(l.maxZoom,l.material.uniforms.zoom.value))}function _(e){if(!1!==l.enabled){l.tweenAnimation&&l.tweenAnimation.stop();var t=0<=e.clientX?e.clientX:e.touches[0].clientX,n=0<=e.clientY?e.clientY:e.touches[0].clientY,i=e.touches&&e.touches.length||1;switch(i){case 1:u=!0,d.set(t,n);break;case 2:var o=e.touches[0].pageX-e.touches[1].pageX,a=e.touches[0].pageY-e.touches[1].pageY,r=Math.sqrt(o*o+a*a);d.pinchDistance=r}l.dispatchEvent(w),l.update()}}function T(e){if(!1!==l.enabled&&u){var t=0<=e.clientX?e.clientX:e.touches[0].clientX,n=0<=e.clientY?e.clientY:e.touches[0].clientY,i=e.touches&&e.touches.length||1;switch(i){case 1:if(!0===l.noRotate)return;var o=-THREE.Math.degToRad((t-d.x)*l.rotateSpeedX),a=THREE.Math.degToRad((n-d.y)*l.rotateSpeedY);u&&(l.rotate(o,a,0),d.set(t,n),l.update(),l.dispatchEvent(g));break;case 2:var r=e.touches[0].pageX-e.touches[1].pageX,s=e.touches[0].pageY-e.touches[1].pageY,c=Math.sqrt(r*r+s*s);b(d.pinchDistance-c),l.update(),l.dispatchEvent(g)}}}function x(e){u=!1,l.dispatchEvent(E)}function R(e){if(!1!==l.enabled&&!0!==l.noZoom){e.preventDefault(),e.stopPropagation();var t=0;void 0!==e.wheelDelta?t=e.wheelDelta:void 0!==e.detail&&(t=-e.detail),b(t),l.update()}}function M(e){switch(e.keyCode){case l.keys.UP:i=!1;break;case l.keys.BOTTOM:p=!1;break;case l.keys.LEFT:f=!1;break;case l.keys.RIGHT:v=!1}}function P(e){if(!1!==l.enabled&&!0!==l.noKeys){switch(e.keyCode){case l.keys.UP:i=!0;break;case l.keys.BOTTOM:p=!0;break;case l.keys.LEFT:f=!0;break;case l.keys.RIGHT:v=!0}(i||p||f||v)&&(l.tweenAnimation&&l.tweenAnimation.stop(),i&&l.rotate(0,l.keySpeed,0),p&&l.rotate(0,-l.keySpeed,0),f&&l.rotate(l.keySpeed,0,0),v&&l.rotate(-l.keySpeed,0,0))}}this.rotateLeft=function(e){e&&l.rotate(e,0,0)},this.rotateUp=function(e){e&&l.rotate(0,e,0)},this.update=function(){if(l.autoRotate&&!u){var e=!1;if(l.autoRotateSpeedX||l.autoRotateSpeedY||l.autoRotateSpeedZ){var t=THREE.Math.degToRad(-l.autoRotateSpeedX/10),n=THREE.Math.degToRad(l.autoRotateSpeedY/10),i=THREE.Math.degToRad(-l.autoRotateSpeedZ/10);l.rotate(t,n,i),e=!0}e&&(l.material.uniforms.transform.value.makeRotationFromQuaternion(m),l.dispatchEvent(g))}else l.material.uniforms.transform.value.makeRotationFromQuaternion(m)},this.bind=function(){l.canvas.addEventListener("mousedown",_,!1),l.canvas.addEventListener("mousemove",T,!1),l.canvas.addEventListener("mouseup",x,!1),l.canvas.addEventListener("touchstart",_,!1),l.canvas.addEventListener("touchmove",T,!1),l.canvas.addEventListener("touchend",x,!1),l.canvas.addEventListener("keydown",P,!1),l.canvas.addEventListener("keyup",M,!1),l.canvas.addEventListener("mousewheel",R,!1),l.canvas.addEventListener("DOMMouseScroll",R,!1)},this.unbind=function(){u=!1,l.canvas.removeEventListener("mousedown",_,!1),l.canvas.removeEventListener("mousemove",T,!1),l.canvas.removeEventListener("mouseup",x,!1),l.canvas.removeEventListener("touchstart",_,!1),l.canvas.removeEventListener("touchmove",T,!1),l.canvas.removeEventListener("touchend",x,!1),l.canvas.removeEventListener("keydown",P,!1),l.canvas.removeEventListener("keyup",M,!1),l.canvas.removeEventListener("mousewheel",R,!1),l.canvas.removeEventListener("DOMMouseScroll",R,!1)},this.yawPitchToCoord=function(e,t,n){var i=(180-e)*ne,o=t*ne;return{x:(n=0<n?n:1)*Math.cos(o)*Math.sin(i),y:n*Math.sin(o),z:n*Math.cos(o)*Math.cos(i)}},this.coordToYawPitch=function(e){var t=Math.atan2(e.x,-e.z),n=Math.sqrt(e.x*e.x+e.z*e.z),i=Math.atan2(e.y,n),o=Math.sqrt(n*n+e.y*e.y),a=t*ie,r=i*ie;return{yaw:a=(a%=360)<0?a+360:a,pitch:r,radius:o}},this.setYawPitch=function(e,t){l.tweenAnimation&&l.tweenAnimation.stop(),e+=180,y(e=(e%=360)<0?e+360:e,t=0==t?t:-t)},this.getYawPitch=function(){var e=s.yaw;s.pitch;return e=(e%=360)<0?e+360:e,{yaw:s.yaw,pitch:s.pitch}},this.lookAt=function(e,t,n){var i=new ee.Deferred;if(e.hasOwnProperty("yaw")&&e.hasOwnProperty("pitch")||(e=l.coordToYawPitch(e)),t){n=n||oe.Easing.Exponential.Out;var o=s,a={yaw:e.yaw,pitch:e.pitch};l.tweenAnimation&&l.tweenAnimation.stop(),l.tweenAnimation=new oe.Tween(o).to(a,t).easing(n).onStart(function(){}).onUpdate(function(e){y(o.yaw,o.pitch)}).onComplete(function(){i.resolve(),l.tweenAnimation.stop()}).onStop(function(){i.reject()}).start()}else y(e.yaw,e.pitch),i.resolve();return i.promise()},this.getLookAt=function(){var e=s.yaw,t=s.pitch;return{yaw:e=(e%=360)<0?e+360:e,pitch:t}},this.getZoom=function(){return l.material.uniforms.zoom.value},this.setZoom=function(e){e&&(e=Math.max(l.minZoom,Math.min(l.maxZoom,e)),l.material.uniforms.zoom.value=e,l.update())},this.rotate=function(e,t,n){s.yaw+=e*ie,s.pitch+=t*ie,s.roll+=n*ie;var e=s.yaw*ne,t=s.pitch*ne,n=s.roll*ne;c=new THREE.Quaternion,h=new THREE.Quaternion,m=new THREE.Quaternion,c.setFromAxisAngle(a,-90*ne),h.setFromAxisAngle(r,90*ne),m.multiply(c).multiply(h),c.setFromAxisAngle(a,-e),h.setFromAxisAngle(o,-t),m.multiply(c).multiply(h),c.setFromAxisAngle(r,n),h.setFromAxisAngle(r,n),m.multiply(c).multiply(h)},this.destroy=function(){this.unbind()}};(v.prototype=Object.create(THREE.EventDispatcher.prototype)).constructor=v;var g=function(e,t,n){f.call(this,e,t,n),this.image=e.image,this.size=1e4,this.ratio=.5,this.texture=null,this.geometry=new THREE.PlaneGeometry(this.size,this.size*this.ratio),this.material=new THREE.ShaderMaterial({uniforms:{texture:{value:new THREE.Texture},resolution:{value:1},transform:{value:new THREE.Matrix4},zoom:{value:this.size}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["varying vec2 vUv;","const float PI = 3.141592653589793;","uniform sampler2D texture;","uniform float resolution;","uniform mat4 transform;","uniform float zoom;","void main() {","vec2 uv = vUv;","uv.y = 1.0 - uv.y;","vec2 position = -1.0 +  2.0 * uv;","position *= vec2(zoom * resolution, zoom * 0.5);","float x2y2 = position.x * position.x + position.y * position.y;","vec3 sphere_pnt = vec3(2.0 * position, x2y2 - 1.0) / (x2y2 + 1.0);","sphere_pnt = vec3(transform * vec4(sphere_pnt, 1.0));","vec2 sampleUV = vec2(","(atan(sphere_pnt.y, sphere_pnt.x) / PI + 1.0) * 0.5,","(asin(sphere_pnt.z) / PI + 0.5)",");","gl_FragColor = texture2D(texture, sampleUV);","}"].join("\n"),side:THREE.DoubleSide}),this.material.uniforms.resolution.value=this.viewer.$canvas.get(0).clientWidth/this.viewer.$canvas.get(0).clientHeight,this.mesh=new THREE.Mesh(this.geometry,this.material),this.scene=new THREE.Scene,this.scene.add(this.mesh),this.control=new v(this.viewer.$canvas.get(0),this.material,this),this.autoRotateControl=new d(this,e.autoRotate)};(g.prototype=Object.create(f.prototype)).constructor=g,Object.assign(g.prototype,{update:function(){this.control.update(),f.prototype.update.call(this)},load:function(e){if(f.prototype.load.call(this),this.image=e||this.image,!e)return console.warn("IPANORAMA.SceneLittlePlanet: image source undefined"),void this.onError;"string"==typeof e?(this.smartRequest&&this.smartRequest.abort(),B.TextureLoader.load(e,this.onLoad.bind(this),this.onProgress.bind(this),this.onError.bind(this),this.smartRequest)):e instanceof HTMLImageElement&&this.onLoad(new THREE.Texture(e))},onLoad:function(e){this.texture&&this.texture.dispose(),this.texture=e,this.texture.minFilter=this.texture.magFilter=THREE.LinearFilter,this.texture.needsUpdate=!0,this.material.uniforms.texture.value=this.texture,window.requestAnimationFrame(function(){window.requestAnimationFrame(function(){f.prototype.onLoad.call(this)}.bind(this))}.bind(this))},onShowStart:function(){this.bind(),f.prototype.onShowStart.call(this)},onHideStart:function(){this.unbind(),f.prototype.onHideStart.call(this)},onWindowResize:function(e,t){this.material.uniforms.resolution.value=e/t,f.prototype.onWindowResize.call(this,e,t)},get:function(e){return e&&this.load(this.image),f.prototype.get.call(this)},destroy:function(){this.control.destroy(),this.scene.remove(this.mesh),this.geometry&&this.geometry.dispose(),this.material&&this.material.dispose(),this.texture&&this.texture.dispose(),this.mesh=void 0,f.prototype.destroy.call(this)},bind:function(){this.control.bind(),this.autoRotateControl.bind()},unbind:function(){this.control.unbind(),this.autoRotateControl.unbind()}});var w=function(e,t,n){this.canvas=e,this.camera=t,this.scene=n,(this.scene.control=this).imageSize={width:0,height:0},this.enabled=!0,this.momentumThreshold=2,this.momentumDampingFactor=.5,this.noZoom=!1,this.noRotate=!1,this.autoRotate=!1,this.autoRotateSpeedX=.5,this.noKeys=!1,this.keyPanSpeed=7,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};var i,o,a,r,h=this,s=ee(e),c=new THREE.Vector2,l=new THREE.Vector2,u=new THREE.Vector2,m=new B.Matrix,d={yaw:0,pitch:0},p=null,f=!1,v=Date.now(),g=0,w=0,E=0,y=0,b=0,_=0,T=null,x={NONE:-1,PAN:2,TOUCH_PAN:3,ZOOM:4,TOUCH_ZOOM:5},R=x.NONE,M={type:"change"},P={type:"start"},H={type:"end"};this.rotateLeft=function(e){e&&this.setDeltaPosition(e,0)},this.rotateUp=function(e){e&&this.setDeltaPosition(0,-e)},this.update=function(){h.autoRotate&&R===x.NONE&&h.setDeltaPosition(h.autoRotateSpeedX,0),A()},this.bind=function(){s.on("mousedown",C),s.on("touchstart",D),s.on("touchmove",F),s.on("touchend",z),s.on("mousewheel",$),s.on("DOMMouseScroll",$),s.on("keydown",O),s.on("keyup",I)},this.unbind=function(){s.off("mousedown",C),s.off("touchstart",D),s.off("touchmove",F),s.off("touchend",z),s.off("mousewheel",$),s.off("DOMMouseScroll",$),ee(document).off("mousemove",L),ee(document).off("mouseup",k)},this.setYawPitch=function(e,t){h.tweenAnimation&&h.tweenAnimation.stop(),d.yaw=-e,d.pitch=-t,h.setPosition(-e,-t)},this.getYawPitch=function(){var e=h.getPosition();return{yaw:0==e.x?0:-e.x,pitch:0==e.y?0:-e.y}},this.lookAt=function(e,t,n){var i=new ee.Deferred;if(e.hasOwnProperty("yaw")&&e.hasOwnProperty("pitch")&&(e={x:-e.yaw,y:-e.pitch}),t){n=n||oe.Easing.Exponential.Out;var o=h.getPosition(),a=e,r=h.getZoom();a.x=a.x*r,a.y=a.y*r,h.tweenAnimation&&h.tweenAnimation.stop(),h.tweenAnimation=new oe.Tween(o).to(a,t).easing(n).onStart(function(){}).onUpdate(function(e){h.setPosition(o.x,o.y)}).onComplete(function(){i.resolve(),h.tweenAnimation.stop()}).onStop(function(){i.reject()}).start()}else h.setPosition(e.x,e.y),i.resolve();return i.promise()},this.getLookAt=function(){var e=h.getZoom(),t=h.getYawPitch();return t.yaw=t.yaw/e,t.pitch=t.pitch/e,t},this.getPosition=function(){return{x:m.m[4],y:m.m[5]}},this.setPosition=function(e,t){m.m[4]=e,m.m[5]=t,S()},this.setDeltaPosition=function(e,t){var n=m.inverse().transformPoint(e,t),i=m.inverse().transformPoint(0,0),o=n[0]-i[0],a=n[1]-i[1];m.translate(o,a),S()},this.getMinZoom=function(){var e=h.canvas.clientWidth/h.imageSize.width,t=h.canvas.clientHeight/h.imageSize.height;return e<t?t:e},this.getZoom=function(){return m.m[0]},this.setZoom=function(e){e&&(p=e),e=e||1e-6;var t=h.getPosition();m.reset().translate(t.x,t.y).scale(e,e),S()},this.setDeltaZoom=function(e,t){var t=t||{x:m.m[4],y:m.m[5]},n=m.inverse().transformPoint(t.x,t.y),i=n[0],o=n[1];m.translate(i,o).scale(e,e).translate(-i,-o),S()},this.getFocalPoint=function(e,t){var n=h.canvas.getBoundingClientRect(),i=new THREE.Vector2;return i.x=e-n.left-n.width/2,i.y=-(t-n.top-n.height/2),i},this.resize=function(){h.setZoom(h.getZoom())},this.reinit=function(){h.setZoom(p),(d.yaw||d.pitch)&&h.setPosition(d.yaw,d.pitch)},this.save=function(){p=m.m[0],d.yaw=m.m[4],d.pitch=m.m[5]};var S=function(){var e=h.getPosition(),t=h.getZoom(),n=h.canvas.clientWidth,i=h.canvas.clientHeight,o=h.imageSize.width,a=h.imageSize.height,r=o*t,s=a*t;if(r<n||s<i){var c=n/o,l=i/a;t=c<l?l:c,m.reset().translate(e.x,e.y).scale(t,t),r=o*t,s=a*t}var u=r,d=(s-i)/2;(e.x<-u||e.x>u)&&(e.x=0),e.y<-d?e.y=-d:e.y>d&&(e.y=d),e.x=isNaN(e.x)?0:e.x,e.y=isNaN(e.y)?0:e.y,m.m[4]=e.x,m.m[5]=e.y,h.camera.zoom=t,h.camera.position.set(-e.x/t,-e.y/t,1e-9),h.camera.updateProjectionMatrix(),h.dispatchEvent(M),h.scene&&h.scene.viewer.$listener.trigger("ipanorama:scene-camera-change",{scene:h.scene})},A=function(){if(f){if(Math.abs(g)<1e-4&&Math.abs(w)<1e-4)return f=!1,void(n.afterRender=!0);var e=Date.now()-v;v=Date.now(),E*=h.momentumDampingFactor,y*=h.momentumDampingFactor,g=E*e,w=y*e,u.x+=g,u.y+=w,h.setDeltaPosition(u.x,-u.y)}},C=function(e){!1!==h.enabled&&(h.tweenAnimation&&h.tweenAnimation.stop(),f=!1,g=w=0,v=Date.now(),R=x.PAN,c.set(e.clientX,e.clientY),h.dispatchEvent(P),h.scene&&h.scene.viewer.$listener.trigger("ipanorama:scene-camera-start",{scene:h.scene}),ee(document).on("mousemove",L),ee(document).on("mouseup",k))},L=function(e){if(!1!==h.enabled&&!0!==h.noRotate){if(e.preventDefault(),T){g=e.clientX-T.clientX,w=e.clientY-T.clientY;var t=Date.now()-v;E=g/t,y=w/t,v=Date.now()}T=e,l.set(e.clientX,e.clientY),u.subVectors(l,c),h.setDeltaPosition(u.x,-u.y),c.copy(l)}},k=function(e){!1!==h.enabled&&(f=!(Math.abs(g)<h.momentumThreshold&&Math.abs(w)<h.momentumThreshold),T=null,ee(document).off("mousemove",L),ee(document).off("mouseup",k),h.dispatchEvent(H),h.scene&&h.scene.viewer.$listener.trigger("ipanorama:scene-camera-end",{scene:h.scene}),R=x.NONE,n.afterRender=!0)},$=function(e){if(!1!==h.enabled&&!0!==h.noZoom&&R===x.NONE){e.preventDefault(),e.stopPropagation();var t=0,n=1,i=h.getMinZoom(),o=h.getFocalPoint(e.clientX,e.clientY);void 0!==e.wheelDelta?t=e.wheelDelta:void 0!==e.detail&&(t=-e.detail),t=Math.max(-1,Math.min(1,t)),n=1+.05*t,h.getZoom()*n<i&&(n=i/h.getZoom()),h.setDeltaZoom(n,o),clearTimeout(h.updateTimerId),h.updateTimerId=setTimeout(function(){S()},1)}},O=function(e){if(!1!==h.enabled&&!0!==h.noKeys){switch(e.keyCode){case h.keys.UP:i=!0;break;case h.keys.BOTTOM:o=!0;break;case h.keys.LEFT:a=!0;break;case h.keys.RIGHT:r=!0}(i||o||a||r)&&(h.tweenAnimation&&h.tweenAnimation.stop(),i&&h.setDeltaPosition(0,-h.keyPanSpeed),o&&h.setDeltaPosition(0,h.keyPanSpeed),a&&h.setDeltaPosition(h.keyPanSpeed,0),r&&h.setDeltaPosition(-h.keyPanSpeed,0))}},I=function(e){switch(e.keyCode){case h.keys.UP:i=!1;break;case h.keys.BOTTOM:o=!1;break;case h.keys.LEFT:a=!1;break;case h.keys.RIGHT:r=!1}},D=function(e){if(f=!1,g=w=0,v=Date.now(),h.tweenAnimation&&h.tweenAnimation.stop(),!1!==h.enabled){switch(e.touches.length){case 1:if(!0===h.noRotate)return;R=x.TOUCH_PAN,c.set(e.touches[0].pageX,e.touches[0].pageY);break;case 2:if(!0===h.noZoom)return;R=x.TOUCH_ZOOM;var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,i=Math.sqrt(t*t+n*n);b=i,_=h.getZoom();break;default:R=x.NONE}R!==x.NONE&&(h.dispatchEvent(P),h.scene&&h.scene.viewer.$listener.trigger("ipanorama:scene-camera-start",{scene:h.scene}))}},F=function(e){if(!1!==h.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:if(!0===h.noRotate)return;if(R!==x.TOUCH_PAN)return;if(T){g=e.touches[0].pageX-T.pageX,w=e.touches[0].pageY-T.pageY;var t=Date.now()-v;E=g/t,y=w/t,v=Date.now()}T={pageX:e.touches[0].pageX,pageY:e.touches[0].pageY},l.set(e.touches[0].pageX,e.touches[0].pageY),u.subVectors(l,c),h.setDeltaPosition(u.x,-u.y),c.copy(l);break;case 2:if(!0===h.noZoom)return;if(R!==x.TOUCH_ZOOM)return;var n=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY,o=Math.sqrt(n*n+i*i),a=(o-b)/b,r=Math.max(h.getMinZoom(),_+a);h.setZoom(r),h.setDeltaPosition(0,0)}},z=function(e){!1!==h.enabled&&(f=!(Math.abs(g)<h.momentumThreshold&&Math.abs(w)<h.momentumThreshold),T=void 0,h.dispatchEvent(H),h.scene&&h.scene.viewer.$listener.trigger("ipanorama:scene-camera-end",{scene:h.scene}),R=x.NONE)};this.update()};(w.prototype=Object.create(THREE.EventDispatcher.prototype)).constructor=w;var E=function(s,e){this.cfg=e,this.enabled=e.enabled,this.defaultPoint={image:e.image,width:e.width,height:e.height,opacity:e.opacity},this.transformControl=new m(s.viewer.$canvas.get(0),s.camera),s.scene.add(this.transformControl);var r=this,n={ESCAPE:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46},c=new THREE.Raycaster,i=this.transformControl;this.bind=function(){s.viewer.$canvas.on("keydown",t),s.viewer.$canvas.on("keyup",o),s.viewer.$canvas.on("click",a),s.viewer.$canvas.on("dblclick",l),i.addEventListener("dragging-changed",u)},this.unbind=function(){s.viewer.$canvas.off("keydown",t),s.viewer.$canvas.off("keyup",o),s.viewer.$canvas.off("click",a),s.viewer.$canvas.off("dblclick",l),i.removeEventListener("dragging-changed",u)},this.detach=function(){i.detach()},this.attach=function(e){e&&i.attach(e.mesh)},this.getSceneIntersectPoint=function(e,t){var n=s.viewer.$canvas.get(0).getBoundingClientRect(),i=new THREE.Vector2;i.x=(e-n.left)/n.width*2-1,i.y=-(t-n.top)/n.height*2+1,c.setFromCamera(i,s.camera);var o=c.intersectObjects([s.mesh],!1);if(o.length){var a=o[0].point,r=new THREE.Vector3;return a.x<-s.imageSize.width/2?a.x+=s.imageSize.width:a.x>s.imageSize.width/2&&(a.x-=s.imageSize.width),a.z=0,s.mesh.getWorldPosition(r),new THREE.Vector3(parseFloat((a.x-r.x).toFixed(2)),parseFloat((a.y-r.y).toFixed(2)),parseFloat((a.z-r.z).toFixed(2)))}return null},this.addPointToCenter=function(e){var t={x:0,y:0,z:0},n=s.viewer.$canvas.get(0).getBoundingClientRect(),i=n.left+n.width/2,o=n.top+n.height/2,a=r.getSceneIntersectPoint(i,o);return a&&(t.x=a.x,t.y=a.y),s.addPoint(r.createPoint(t),e)},this.createPoint=function(e){var t=new h({pos:e,image:r.defaultPoint.image,width:r.defaultPoint.width,height:r.defaultPoint.height,opacity:r.defaultPoint.opacity});return t};var t=function(e){r.enabled},o=function(e){if(!1!==r.enabled&&i.object)switch(e.keyCode){case n.DELETE:if("point"==i.object.userData.type){var t=s.findPointByMesh(i.object);i.detach(),s.removePoint(t)}break;case n.ESCAPE:i.detach()}},a=function(e){if(!1!==r.enabled){var t=r.getSceneIntersectPoint(e.clientX,e.clientY);c.set(t,new THREE.Vector3(0,0,1));var n=c.intersectObjects(s.scene.children);if(1<n.length&&"point"===n[1].object.userData.type)return i.attach(n[1].object),void s.selectPoint(i.object.userData.point);i.object&&s.deselectPoint(i.object.userData.point),i.detach()}},l=function(e){if(!1!==r.enabled){var t=r.getSceneIntersectPoint(e.clientX,e.clientY);s.addPoint(r.createPoint(t))}},u=function(e){e.value?s.dragstartPoint(e.target.object.userData.point):s.dragendPoint(e.target.object.userData.point),s.control.enabled=!e.value,s.updatePointPos()}},y=function(a){var r=this,o=new THREE.Frustum,s=null;this.bind=function(){a.control.addEventListener("change",e),a.control.addEventListener("start",t),a.control.addEventListener("end",i)},this.unbind=function(){a.control.removeEventListener("change",e),a.control.removeEventListener("start",t),a.control.removeEventListener("end",i)},this.update=function(){o.setFromMatrix((new THREE.Matrix4).multiplyMatrices(a.camera.projectionMatrix,a.camera.matrixWorldInverse));for(var e=null,t=0;t<a.points.length;t++){var n=[0,0,0];e=a.pointsLeft[t],n[0]=c(o,e,!0),e=a.pointsRight[t],n[1]=c(o,e,!0),e=a.points[t],n[2]=c(o,e,!0);var i=n[0]+n[1]+n[2];1==i?(e=1==n[0]?a.pointsLeft[t]:1==n[1]?a.pointsRight[t]:e,a.viewer.$listener.trigger("ipanorama:scene-point-show",{scene:a,point:e})):2==i&&(e=1==n[0]?a.pointsLeft[t]:1==n[1]?a.pointsRight[t]:e,a.viewer.$listener.trigger("ipanorama:scene-point-hide",{scene:a,point:e}))}},this.show=function(){o.setFromMatrix((new THREE.Matrix4).multiplyMatrices(a.camera.projectionMatrix,a.camera.matrixWorldInverse));for(var e=null,t=0;t<a.points.length;t++){var n=[0,0,0];(e=a.pointsLeft[t]).mesh.visible=!0,n[0]=c(o,e,!1),(e=a.pointsRight[t]).mesh.visible=!0,n[1]=c(o,e,!1),(e=a.points[t]).mesh.visible=!0,n[2]=c(o,e,!1);var i=n[0]+n[1]+n[2];1==i?(e=1==n[0]?a.pointsLeft[t]:1==n[1]?a.pointsRight[t]:e,a.viewer.$listener.trigger("ipanorama:scene-point-show",{scene:a,point:e})):2==i&&(e=1==n[0]?a.pointsLeft[t]:1==n[1]?a.pointsRight[t]:e,a.viewer.$listener.trigger("ipanorama:scene-point-hide",{scene:a,point:e}))}},this.hide=function(){for(var e=0;e<a.points.length;e++){var t=a.points[e];n(t),t=a.pointsLeft[e],n(t),t=a.pointsRight[e],n(t)}},this.getScreenCoord=function(e){return e.project(a.camera),e.x=Math.round((.5+e.x/2)*(a.viewer.$canvas.get(0).width/window.devicePixelRatio)),e.y=Math.round((.5-e.y/2)*(a.viewer.$canvas.get(0).height/window.devicePixelRatio)),{x:e.x,y:e.y}};var n=function(e){e.mesh.visible=!1,e.visible&&(e.visible=!1,a.viewer.$listener.trigger("ipanorama:scene-point-hide",{scene:a,point:e}))},c=function(e,t,n){var i=0;return e.containsPoint(t.mesh.position)?(l(t),t.visible||(t.visible=!0,i=1),n&&a.viewer.$listener.trigger("ipanorama:scene-point-change",{scene:a,point:t})):t.visible&&(t.visible=!1,i=2),i},l=function(e){e.mesh.quaternion.copy(a.camera.quaternion);var t=e.mesh.position.clone();if(e.screenPos=r.getScreenCoord(t),s!=a.camera.zoom){e.mesh.updateMatrixWorld();var n=e.mesh.geometry.vertices[0].clone(),i=e.mesh.geometry.vertices[1].clone(),o=e.mesh.geometry.vertices[2].clone();n.applyMatrix4(e.mesh.matrixWorld),i.applyMatrix4(e.mesh.matrixWorld),o.applyMatrix4(e.mesh.matrixWorld),n=r.getScreenCoord(n),i=r.getScreenCoord(i),o=r.getScreenCoord(o),e.screenWidth=i.x-n.x,e.screenHeight=o.y-n.y,s=a.camera.zoom}},e=function(){r.update()},t=function(){},i=function(){}},b=function(e,t,n){f.call(this,e,t,n),this.image=e.image,this.imageSize={width:0,height:0},this.texture=null,this.geometry=new THREE.PlaneBufferGeometry(1,1,3,1),this.material=new THREE.ShaderMaterial({uniforms:{texture:{value:null},imageSize:{value:new THREE.Vector2},imageOriginalSize:{value:new THREE.Vector2}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D texture;","uniform vec2 imageSize;","uniform vec2 imageOriginalSize;","void main() {","vec2 uv = vUv;","float ratio_x = imageOriginalSize.x / imageSize.x;","float ratio_y = imageOriginalSize.y / imageSize.y;","float blocks = 3.0;","if(uv.x >= (2.0/blocks)) {","uv = vec2((uv.x - 2.0/blocks) * ratio_x * blocks, 1.0 - (1.0 - uv.y) * ratio_y);","} else if(uv.x >= (1.0/blocks)) {","uv = vec2((uv.x - 1.0/blocks) * ratio_x * blocks, 1.0 - (1.0 - uv.y) * ratio_y);","} else if(uv.x >= (0.0/blocks)) {","uv = vec2((uv.x - 0.0/blocks) * ratio_x * blocks, 1.0 - (1.0 - uv.y) * ratio_y);","}","gl_FragColor = texture2D(texture, uv);","}"].join("\n"),side:THREE.DoubleSide,transparent:!0}),this.mesh=new THREE.Mesh(this.geometry,this.material),this.scene=new THREE.Scene,this.scene.add(this.mesh);var i=this.viewer.$canvas.get(0).clientWidth/2,o=this.viewer.$canvas.get(0).clientHeight/2;this.camera=new THREE.OrthographicCamera(-i,i,o,-o,-1e4,1e4),this.control=new w(this.viewer.$canvas.get(0),this.camera,this),this.autoRotateControl=new d(this,e.autoRotate),this.points=[],this.pointsLeft=[],this.pointsRight=[],this.pointEditor=new E(this,e.pointEditor),this.pointControl=new y(this)};(b.prototype=Object.create(f.prototype)).constructor=b,Object.assign(b.prototype,{update:function(){this.control.update(),f.prototype.update.call(this)},load:function(e){if(f.prototype.load.call(this),this.image=e||this.image,!e)return console.warn("IPANORAMA.SceneFlat: image source undefined"),void this.onError();"string"==typeof e?(this.smartRequest&&this.smartRequest.abort(),B.TextureLoader.load(e,this.onLoad.bind(this),this.onProgress.bind(this),this.onError.bind(this),this.smartRequest,!0)):e instanceof HTMLImageElement&&this.onLoad(new THREE.Texture(e))},onLoad:function(e){this.texture&&this.texture.dispose(),this.texture=e,this.texture.minFilter=this.texture.magFilter=THREE.LinearFilter,this.texture.wrapS=this.texture.wrapT=THREE.RepeatWrapping,this.texture.needsUpdate=!0,this.material.uniforms.texture.value=this.texture,this.material.uniforms.imageSize.value.width=this.texture.image.width,this.material.uniforms.imageSize.value.height=this.texture.image.height,this.material.uniforms.imageOriginalSize.value.width=this.texture.imageOriginalSize.width,this.material.uniforms.imageOriginalSize.value.height=this.texture.imageOriginalSize.height,this.mesh.scale.set(3*this.texture.imageOriginalSize.width,this.texture.imageOriginalSize.height,1),this.control.imageSize.width=this.imageSize.width=this.texture.imageOriginalSize.width,this.control.imageSize.height=this.imageSize.height=this.texture.imageOriginalSize.height,this.control.reinit(),this.updatePointPos(),this.pointControl.show(),window.requestAnimationFrame(function(){window.requestAnimationFrame(function(){f.prototype.onLoad.call(this)}.bind(this))}.bind(this))},onShowStart:function(){this.bind(),this.pointControl.show(),f.prototype.onShowStart.call(this)},onHideStart:function(){this.unbind(),this.pointControl.hide(),this.control.save(),f.prototype.onHideStart.call(this)},onWindowResize:function(e,t){this.camera.left=-e/2,this.camera.right=e/2,this.camera.top=t/2,this.camera.bottom=-t/2,this.camera.updateProjectionMatrix(),this.control.resize(),f.prototype.onWindowResize.call(this,e,t)},get:function(e){return e&&this.load(this.image),f.prototype.get.call(this)},destroy:function(){this.scene.remove(this.mesh),this.geometry&&this.geometry.dispose(),this.material&&this.material.dispose(),this.texture&&this.texture.dispose(),this.mesh=void 0,f.prototype.destroy.call(this)},updatePointPos:function(){for(var e=null,t=null,n=0;n<this.points.length;n++)(e=this.points[n]).hasOwnProperty("yaw")&&e.hasOwnProperty("pitch")&&(t={x:e.yaw,y:e.pitch,z:0},e.mesh.position.set(t.x,t.y,t.z)),t=e.mesh.position,(e=this.pointsLeft[n]).mesh.position.set(t.x-this.imageSize.width,t.y,t.z),(e=this.pointsRight[n]).mesh.position.set(t.x+this.imageSize.width,t.y,t.z)},addPoint:function(e,t){if(!e)return null;var n=new IPANORAMA.Point(e.cfg),i=new IPANORAMA.Point(e.cfg);return e.mesh.userData.type="point",n.mesh.userData.type="pointLeft",i.mesh.userData.type="pointRight",e.ext&&(n.ext=e.ext,i.ext=e.ext),n.load(),this.pointsLeft.push(n),this.scene.add(n.mesh),i.load(),this.pointsRight.push(i),this.scene.add(i.mesh),e.load(),this.points.push(e),this.scene.add(e.mesh),!t&&this.viewer.$listener.trigger("ipanorama:scene-point-add",{scene:this,point:e}),this.loaded&&(this.updatePointPos(),this.pointControl.show()),e},removePoint:function(e,t){if(e){for(var n=null,i=0;i<this.points.length;i++)Object.is(e,this.points[i])&&(n=i);null!=n&&(this.pointEditor&&this.pointEditor.detach(),e=this.pointsLeft[n],this.scene.remove(e.mesh),e.destroy(),e=this.pointsRight[n],this.scene.remove(e.mesh),e.destroy(),e=this.points[n],this.scene.remove(e.mesh),e.destroy(),this.pointsLeft.splice(n,1),this.pointsRight.splice(n,1),this.points.splice(n,1),!t&&this.viewer.$listener.trigger("ipanorama:scene-point-remove",{scene:this,point:e}))}},removePoints:function(e){this.pointEditor&&this.pointEditor.detach();for(var t=null,n=0;n<this.points.length;n++)t=this.pointsLeft[n],this.scene.remove(t.mesh),t.destroy(),t=this.pointsRight[n],this.scene.remove(t.mesh),t.destroy(),t=this.points[n],this.scene.remove(t.mesh),t.destroy(),!e&&this.viewer.$listener.trigger("ipanorama:scene-point-remove",{scene:this,point:t});this.pointsLeft=[],this.pointsRight=[],this.points=[]},bind:function(){this.control.bind(),this.autoRotateControl.bind(),this.pointEditor.bind(),this.pointControl.bind()},unbind:function(){this.control.unbind(),this.autoRotateControl.unbind(),this.pointEditor.unbind(),this.pointControl.unbind()}});var _={name:"default",effect:function(e,t){this.viewer=t,this.shader={uniforms:{texture1:{value:null},texture2:{value:null},progress:{value:0},time:{value:0},timeDelta:{value:0},resolution:{value:new THREE.Vector2}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D texture1;","uniform sampler2D texture2;","uniform float progress;","uniform float time;","uniform float timeDelta;","uniform vec2 resolution;","void main() {","vec2 uv = vUv;","vec4 texel1 = texture2D( texture1, uv );","vec4 texel2 = texture2D( texture2, uv );","gl_FragColor = mix(texel1, texel2, progress);","}"].join("\n"),side:THREE.DoubleSide},this.material=new THREE.ShaderMaterial(this.shader),this.init(e)}};_.effect.prototype={init:function(e){},getMaterial:function(){return this.material},destroy:function(){this.material.dispose()},onStart:function(e,t,n){},onUpdate:function(e,t,n){},onComplete:function(e,t){}};var T={name:"none",effect:function(e,t){this.viewer=t,this.shader={uniforms:{texture1:{value:null},texture2:{value:null},progress:{value:0},time:{value:0},timeDelta:{value:0},resolution:{value:new THREE.Vector2}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D texture1;","uniform sampler2D texture2;","uniform float progress;","uniform float time;","uniform float timeDelta;","uniform vec2 resolution;","void main() {","vec2 uv = vUv;","vec4 texel1 = texture2D( texture1, uv );","vec4 texel2 = texture2D( texture2, uv );","gl_FragColor = texel2;","}"].join("\n"),side:THREE.DoubleSide},this.material=new THREE.ShaderMaterial(this.shader),this.init(e)}};T.effect.prototype={init:function(e){},getMaterial:function(){return this.material},destroy:function(){this.material.dispose()},onStart:function(e,t,n){},onUpdate:function(e,t,n){},onComplete:function(e,t){}};var x={NORMAL:1,STEREO:2},R=function(e,t){console.log("IPANORAMA",o),THREE.Cache.enabled=!0,this.cfg=e,this.smartRequest=t,this.$canvas=e.$canvas,this.$listener=e.$listener?e.$listener:e.$canvas,this.visible=null!=this.$canvas.get(0).offsetParent,this.enabled=!0;var n=this.$canvas.get(0).clientWidth,i=this.$canvas.get(0).clientHeight;this.updateCallbacks=[],this.requestAnimationId=null,this.mode=x.NORMAL,this.clock=new THREE.Clock,this.scene=new THREE.Scene,this.sceneDfd=null,this.sceneToLoad=null,this.sceneActive=null,this.sceneTransition=null,this.sceneTransitionDuration=1500,this.sceneTransitionEffect=null,this.camera=new THREE.OrthographicCamera(n/-2,n/2,i/2,i/-2,-10,10),this.quadGeometry=new THREE.PlaneBufferGeometry(1,1),this.quadMaterial=new THREE.MeshBasicMaterial({color:0,side:THREE.DoubleSide,opacity:.5}),this.quad=new THREE.Mesh(this.quadGeometry,this.quadMaterial),this.quad.scale.set(n,i,1),this.scene.add(this.quad),this.renderer=new THREE.WebGLRenderer({canvas:this.$canvas.get(0),alpha:!1,antialias:!1,preserveDrawingBuffer:!1}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(n,i,!1),this.renderer.setClearColor(0,1),this.renderer.sortObjects=!1,this.initSceneTransition(),this.setSceneTransitionEffect("default"),this.animate()};R.prototype={initSceneTransition:function(){this.sceneTransition=new oe.Tween(this).easing(oe.Easing.Linear.None).onStart(this.onSceneShowStart.bind(this)).onUpdate(this.onSceneShowUpdate.bind(this)).onComplete(this.onSceneShowComplete.bind(this))},animate:function(){this.requestAnimationId=window.requestAnimationFrame(this.animate.bind(this)),this.enabled&&this.onChange()},update:function(){oe.update(void 0,!0),this.sceneActive&&this.sceneActive.update(),this.sceneToLoad&&this.sceneToLoad.update(),this.updateCallbacks.forEach(function(e){e()})},render:function(){var e=null!=this.$canvas.get(0).offsetParent;if(e){if(e!=this.visible&&(this.visible=e,window.dispatchEvent(new Event("resize"))),this.sceneActive||this.sceneToLoad)switch(this.sceneActive&&this.sceneActive.render(this.renderer,!0),this.sceneToLoad&&this.sceneToLoad.render(this.renderer,!0),this.mode){case x.NORMAL:this.renderer.setRenderTarget(null),this.renderer.clear(),this.renderer.render(this.scene,this.camera);break;case x.STEREO:var t=new THREE.Vector2;this.renderer.getSize(t),this.renderer.setRenderTarget(null),this.renderer.clear(),this.renderer.setScissorTest(!0),this.renderer.setScissor(0,0,t.width/2,t.height),this.renderer.setViewport(0,0,t.width/2,t.height),this.renderer.render(this.scene,this.camera),this.renderer.setScissor(t.width/2,0,t.width/2,t.height),this.renderer.setViewport(t.width/2,0,t.width/2,t.height),this.renderer.render(this.scene,this.camera),this.renderer.setScissorTest(!1)}}else this.visible=e},onChange:function(){this.update(),this.render()},onWindowResize:function(e,t){this.renderer.setSize(e,t,!1),this.quad.scale.set(e,t,1),this.camera.left=-e/2,this.camera.right=e/2,this.camera.top=t/2,this.camera.bottom=-t/2,this.camera.updateProjectionMatrix(),this.quadMaterial.uniforms&&(this.quadMaterial.uniforms.resolution.value.x=e,this.quadMaterial.uniforms.resolution.value.y=t)},onSceneReadyToShow:function(e){this.sceneToLoad=e,this.sceneTransition.to({},this.sceneTransitionDuration).stop().start()},onSceneError:function(e){},onSceneShowStart:function(){var e=this.sceneActive,t=this.sceneToLoad;this.sceneActive=t,this.sceneToLoad=e,this.quadMaterial.uniforms&&(this.quadMaterial.uniforms.texture1.value=e?e.fbo.texture:null,this.quadMaterial.uniforms.texture2.value=t?t.fbo.texture:null),this.sceneTransitionEffect.onStart(e,t,this.sceneTransitionDuration),e&&e.onHideStart(),t&&t.onShowStart()},onSceneShowUpdate:function(e){var t=this.sceneToLoad,n=this.sceneActive;this.quadMaterial.uniforms&&(this.quadMaterial.uniforms.progress.value=e,this.quadMaterial.uniforms.time.value=this.clock.getElapsedTime(),this.quadMaterial.uniforms.timeDelta.value=this.clock.getDelta()),this.sceneTransitionEffect.onUpdate(t,n,e),t&&t.onHideUpdate(e),n&&n.onShowUpdate(e)},onSceneShowComplete:function(){var e=this.sceneToLoad,t=this.sceneActive;this.sceneToLoad=null,this.sceneTransition.stop(),this.sceneTransitionEffect.onComplete(e,t),e&&e.onHideComplete(),t&&t.onShowComplete()},setMode:function(e){switch(e){case"normal":e=x.NORMAL;break;case"stereo":e=x.STEREO;break;default:e=x.NORMAL}this.mode=e},setScene:function(e,t){t=void 0===t||t,this.sceneDfd&&this.sceneDfd.reject(),this.sceneDfd=null,e?(e.get(t).then(this.onSceneReadyToShow.bind(this,e)).fail(this.onSceneError.bind(this,e)),this.sceneDfd=e.sceneDfd):this.clearScene()},clearScene:function(){this.smartRequest&&this.smartRequest.abort(),this.sceneActive&&this.sceneActive.onHideStart()&&this.sceneActive.onHideComplete(),this.sceneActive=null,this.sceneToLoad=null,this.sceneDfd=null,this.renderer.setRenderTarget(null),this.renderer.clear(0,0),this.$listener.trigger("ipanorama:scene-clear")},setSceneTransitionDuration:function(e){this.sceneTransitionDuration=void 0===e?0:e},setSceneTransitionEffect:function(e,t){var n=null;if(e){for(var i in F.SceneTransitionEffect)if(F.SceneTransitionEffect.hasOwnProperty(i)){var o=F.SceneTransitionEffect[i];if(o.name.toLowerCase()==e.toLowerCase()){n=o;break}}}else n=T;if(null!=n){var a=this.$canvas.get(0).clientWidth,r=this.$canvas.get(0).clientHeight;this.scene.remove(this.quad),this.sceneTransitionEffect&&this.sceneTransitionEffect.destroy(),this.sceneTransitionEffect=new n.effect(t,this),this.quadMaterial&&this.quadMaterial.dispose(),this.quadMaterial=this.sceneTransitionEffect.getMaterial(),this.quad=void 0,this.quad=new THREE.Mesh(this.quadGeometry,this.quadMaterial),this.quad.scale.set(a,r,1),this.scene.add(this.quad)}else console.warn("IPANORAMA.Viewer: can't find the scene transition effect \""+e+'"')},addUpdateCallback:function(e){e&&this.updateCallbacks.push(e)},removeUpdateCallback:function(e){var t=this.updateCallbacks.indexOf(e);e&&0<=t&&this.updateCallbacks.splice(t,1)},destroy:function(){this.scene.remove(this.quad),this.sceneTransitionEffect&&this.sceneTransitionEffect.destroy(),this.sceneTransitionEffect=null,this.quadGeometry&&this.quadGeometry.dispose(),this.quadMaterial&&this.quadMaterial.dispose(),this.quad=void 0,THREE.Cache&&THREE.Cache.enabled&&THREE.Cache.clear(),this.render(),window.cancelAnimationFrame(this.requestAnimationId)}};var z={name:"default",defaultConfig:{titleControl:!0,audioControl:!0,prevSceneControl:!0,nextSceneControl:!0,fullscreenControl:!0,thumbnailControl:!1,viewerModeControl:!1,moveToNextScene:!0},widget:function(i,o){o=F.Utils.extend(z.defaultConfig,o),this.audioPlayer=new F.AudioPlayer(i.config.audio);var a=this,n=i.$container,r=ee("<div>").addClass("ipnrm-placeholder").css({display:"none"}),s={},c=null,l=null,u=null,d=[],h=null,m=!1,p=null;this.init=function(){e(),t()},this.setAudio=function(e){if(s.$audioPlayer.toggleClass("ipnrm-active",0<i.config.audio.tracks.length&&i.config.audio.enabled),i.config.audio.enabled)for(var t=0;t<i.config.audio.tracks.length;t++){var n=i.config.audio.tracks[t];if(n.sceneId==e.cfg.id){a.audioPlayer.setTrack(n.id),n.autoplay&&a.audioPlayer.play(),a.audioPlayer.loop(n.loop);break}}},this.destroy=function(){f(),s.$widget.remove(),s={},n.removeClass("ipnrm-widget-default"),a.audioPlayer.destroy()};var e=function(){n.addClass("ipnrm-widget-default"),s.$widget=ee("<div>").addClass("ipnrm-widget"),s.$firstLoad=ee("<div>").addClass("ipnrm-first-load"),s.$ts=ee("<div>").addClass("ipnrm-ts"),s.$bs=ee("<div>").addClass("ipnrm-bs"),s.$tlBar=ee("<div>").addClass("ipnrm-tl-bar"),s.$trBar=ee("<div>").addClass("ipnrm-tr-bar"),s.$brBar=ee("<div>").addClass("ipnrm-br-bar"),s.$blBar=ee("<div>").addClass("ipnrm-bl-bar"),s.$progress=ee("<div>").addClass("ipnrm-progress"),s.$progressBar=ee("<div>").addClass("ipnrm-progress-bar").appendTo(s.$progress),s.$audioPlayer=a.audioPlayer.getWidget(),s.$prevScene=ee("<div>").addClass("ipnrm-btn ipnrm-prev-scene"),s.$nextScene=ee("<div>").addClass("ipnrm-btn ipnrm-next-scene"),s.$stereoMode=ee("<div>").addClass("ipnrm-btn ipnrm-stereo-mode"),s.$thumbs=ee("<div>").addClass("ipnrm-btn ipnrm-thumbs"),s.$fullscreen=ee("<div>").addClass("ipnrm-btn ipnrm-fullscreen"),s.$title=ee("<div>").addClass("ipnrm-title"),s.$ts.append(s.$tlBar,s.$trBar),s.$bs.append(s.$blBar,s.$brBar),s.$tlBar.append(s.$audioPlayer),s.$trBar.append(s.$prevScene,s.$nextScene),s.$brBar.append(s.$stereoMode,s.$thumbs,s.$fullscreen),s.$blBar.append(s.$title),s.$thumbsWrap=ee("<div>").addClass("ipnrm-thumbs-wrap"),s.$thumbsList=ee("<div>").addClass("ipnrm-thumbs-list"),s.$thumbsClose=ee("<div>").addClass("ipnrm-thumbs-close"),s.$thumbsWrap.append(s.$thumbsList,s.$thumbsClose),s.$widget.append(s.$progress,s.$firstLoad,s.$ts,s.$bs,s.$thumbsWrap),n.append(s.$widget),v(),n.on("ipanorama:config",R).trigger("ipanorama:config")},t=function(){n.on("ipanorama:ready",I),n.on("fullscreenchange mozfullscreenchange webkitfullscreenchange msfullscreenchange",D),n.on("ipanorama:scene-before-load",H),n.on("ipanorama:scene-after-load",S),n.on("ipanorama:scene-progress",P),n.on("ipanorama:scene-error",A),n.on("ipanorama:scene-hide-start",C),n.on("ipanorama:scene-hide-complete",L),n.on("ipanorama:scene-show-start",k),n.on("ipanorama:scene-show-complete",$),n.on("ipanorama:scene-index",O),n.on("ipanorama:mode",M),s.$prevScene.on("click",g),s.$nextScene.on("click",w),s.$stereoMode.on("click",E),s.$fullscreen.on("click",T),s.$thumbs.on("click",y),s.$thumbsList.on("click",".ipnrm-thumb",b),s.$thumbsClose.on("click",_),s.$firstLoad.on("click",x)},f=function(){n.off("ipanorama:ready",I),n.off("fullscreenchange mozfullscreenchange webkitfullscreenchange msfullscreenchange",D),n.off("ipanorama:scene-before-load",H),n.off("ipanorama:scene-after-load",S),n.off("ipanorama:scene-progress",P),n.off("ipanorama:scene-error",A),n.off("ipanorama:scene-hide-start",C),n.off("ipanorama:scene-hide-complete",L),n.off("ipanorama:scene-show-start",k),n.off("ipanorama:scene-show-complete",$),n.off("ipanorama:scene-index",O),n.off("ipanorama:mode",M),s.$prevScene.off("click",g),s.$nextScene.off("click",w),s.$stereoMode.off("click",E),s.$fullscreen.off("click",T),s.$thumbs.off("click",y),s.$thumbsList.off("click",".ipnrm-thumb",b),s.$thumbsClose.off("click",_),s.$firstLoad.on("click",x)},v=function(){s.$firstLoad.addClass("ipnrm-hide"),s.$title.addClass("ipnrm-hide"),s.$audioPlayer.addClass("ipnrm-hide"),s.$prevScene.addClass("ipnrm-hide"),s.$nextScene.addClass("ipnrm-hide"),s.$fullscreen.addClass("ipnrm-hide"),s.$thumbs.addClass("ipnrm-hide"),s.$stereoMode.addClass("ipnrm-hide"),s.$thumbsWrap.addClass("ipnrm-hide")},g=function(e){(h-=1)<0?h=null:n.trigger("ipanorama:set-scene",{id:d[h]})},w=function(e){(h+=1)>=d.length?(h=d.length-1,n.trigger("ipanorama:next-scene")):n.trigger("ipanorama:set-scene",{id:d[h]})},E=function(e){var t=c;switch(t){case"normal":t="stereo";break;case"stereo":t="normal"}n.trigger("ipanorama:mode",{mode:t})},y=function(e){var t=s.$thumbsList.find(".ipnrm-thumb.ipnrm-active");t.removeClass("ipnrm-active"),(t=s.$thumbsList.find('[data-scene-id="'+l+'"]')).addClass("ipnrm-active"),s.$thumbsWrap.addClass("ipnrm-active")},b=function(e){n.trigger("ipanorama:set-scene",{id:ee(this).data("scene-id")}),s.$thumbsWrap.removeClass("ipnrm-active")},_=function(e){s.$thumbsWrap.removeClass("ipnrm-active")},T=function(e){if(document.fullscreenEnabled||document.webkitFullscreenEnabled)if(s.$fullscreen.hasClass("ipnrm-active"))try{document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen()}catch(e){}else try{var t=n.get(0);t.requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.msRequestFullscreen&&t.msRequestFullscreen()}catch(e){}else n.toggleClass("ipnrm-fullscreen-mode"),n.hasClass("ipnrm-fullscreen-mode")?(s.$fullscreen.addClass("ipnrm-active"),r.insertBefore(n),n.detach(),ee("body").append(n)):(s.$fullscreen.removeClass("ipnrm-active"),n.detach(),n.insertAfter(r),r.remove()),p._onWindowResize()},x=function(e){u&&(s.$firstLoad.addClass("ipnrm-hide"),n.trigger("ipanorama:set-scene",{id:u}))},R=function(e,t){t&&t.config&&(n.off("ipanorama:config",R),!t.config.autoLoad&&0<t.config.scenes.length&&(s.$firstLoad.removeClass("ipnrm-hide"),u=t.config.scenes[0].id),function(e){for(var t=0;t<e.scenes.length;t++){var n=e.scenes[t];if(n.imageThumb){var i=ee("<div>").addClass("ipnrm-thumb").attr({"data-scene-id":n.id}),o=ee("<img>").attr({src:n.imageThumb});s.$thumbsList.append(i.append(o))}}}(t.config))},M=function(e,t){if(t&&t.master)switch(c=t.mode){case"normal":s.$stereoMode.removeClass("ipnrm-active");break;case"stereo":s.$stereoMode.addClass("ipnrm-active")}},P=function(e,t){t.progress.loaded<t.progress.total?(m||(s.$progress.addClass("ipnrm-active"),m=!0),s.$progressBar.css({width:t.progress.loaded/t.progress.total*100+"%"})):(m&&(s.$progress.removeClass("ipnrm-active"),m=!1),s.$progressBar.css({width:0}))},H=function(e,t){},S=function(e,t){s.$progress.removeClass("ipnrm-active"),m=!1,s.$firstLoad.addClass("ipnrm-hide"),o.titleControl&&s.$title.removeClass("ipnrm-hide"),o.audioControl&&s.$audioPlayer.removeClass("ipnrm-hide"),o.prevSceneControl&&s.$prevScene.removeClass("ipnrm-hide"),o.nextSceneControl&&s.$nextScene.removeClass("ipnrm-hide"),o.fullscreenControl&&s.$fullscreen.removeClass("ipnrm-hide"),o.thumbnailControl&&s.$thumbs.removeClass("ipnrm-hide"),o.viewerModeControl&&s.$stereoMode.removeClass("ipnrm-hide"),s.$thumbsWrap.removeClass("ipnrm-hide")},A=function(e,t){s.$progress.removeClass("ipnrm-active"),m=!1,v()},C=function(e,t){},L=function(e,t){},k=function(e,t){a.setAudio(t.scene),t.scene.cfg.title?(s.$title.get(0).innerHTML=t.scene.cfg.title,s.$title.addClass("ipnrm-active")):(s.$title.get(0).innerHTML=null,s.$title.removeClass("ipnrm-active"))},$=function(e,t){},O=function(e,t){if(t)if(l=t.scene.cfg.id,null==h?(d.push(l),h=0):d[h]!=l&&(h+=1,(d=d.slice(0,h)).push(l)),0<h?s.$prevScene.addClass("ipnrm-active"):s.$prevScene.removeClass("ipnrm-active"),h<d.length-1)s.$nextScene.addClass("ipnrm-active");else if(s.$nextScene.removeClass("ipnrm-active"),o.moveToNextScene){for(var n=0;n<t.config.scenes.length;n++){var i=t.config.scenes[n];if(i.id==l)break}n<t.config.scenes.length-1&&s.$nextScene.addClass("ipnrm-active")}},I=function(e,t){p=t.instance},D=function(e){document.fullscreen||document.mozFullScreen||document.webkitIsFullScreen||document.msFullscreenElement?s.$fullscreen.addClass("ipnrm-active"):s.$fullscreen.removeClass("ipnrm-active"),setTimeout(function(){p._onWindowResize()},100)}}},M={name:"simple",defaultConfig:{},widget:function(e,t){t=F.Utils.extend(M.defaultConfig,t);var n=e.$container,i={},o=!1;this.init=function(){a(),r()},this.destroy=function(){s(),i.$widget.remove(),i={},n.removeClass("ipnrm-widget-simple")};var a=function(){n.addClass("ipnrm-widget-simple"),i.$widget=ee("<div>").addClass("ipnrm-widget-simple"),i.$progress=ee("<div>").addClass("ipnrm-progress"),i.$progressBar=ee("<div>").addClass("ipnrm-progress-bar").appendTo(i.$progress),i.$widget.append(i.$progress),n.append(i.$widget)},r=function(){n.on("ipanorama:scene-before-load",c),n.on("ipanorama:scene-after-load",l),n.on("ipanorama:scene-progress",u),n.on("ipanorama:scene-clear",d),n.on("ipanorama:scene-hide-start",h),n.on("ipanorama:scene-hide-complete",m),n.on("ipanorama:scene-show-start",p),n.on("ipanorama:scene-show-complete",f)},s=function(){n.off("ipanorama:scene-before-load",c),n.off("ipanorama:scene-after-load",l),n.off("ipanorama:scene-progress",u),n.off("ipanorama:scene-clear",d),n.off("ipanorama:scene-hide-start",h),n.off("ipanorama:scene-hide-complete",m),n.off("ipanorama:scene-show-start",p),n.off("ipanorama:scene-show-complete",f)},c=function(e,t){},l=function(e,t){i.$progress.removeClass("ipnrm-active"),o=!1},u=function(e,t){t.progress.loaded<t.progress.total?(o||(i.$progress.addClass("ipnrm-active"),o=!0),i.$progressBar.css({width:t.progress.loaded/t.progress.total*100+"%"})):(o&&(i.$progress.removeClass("ipnrm-active"),o=!1),i.$progressBar.css({width:0}))},d=function(e,t){i.$progress.removeClass("ipnrm-active"),o=!1},h=function(e,t){},m=function(e,t){},p=function(e,t){},f=function(e,t){}}};F.VERSION=o,F.TWEEN=oe,F.HOWLER=N,F.GSVPANO=r,F.SmartRequest=function(){this.requests=[];var t=this;this.push=function(e){t.requests.push(e)},this.abort=function(){for(var e=0;e<t.requests.length;e++)t.requests[e].abort();t.requests=[]}},F.Utils=B,F.OrbitControls=s,F.TransformControls=m,F.Scene=F.Scene||{},F.Scene.Base=f,F.Scene.Sphere=e,F.Scene.Cube=t,F.Scene.GoogleStreetView=n,F.Scene.LittlePlanet=g,F.Scene.Flat=b,F.SceneTransitionEffect=F.SceneTransitionEffect||{},F.SceneTransitionEffect.None=T,F.SceneTransitionEffect.Default=_,F.Point=h,F.Plane=p,F.Viewer=R,F.AudioPlayer=function(e){var t=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","pointerup","touchend","keydown","keyup"];this.controls={};var o=this,n=[];if(e&&Array.isArray(e.tracks))for(var i=0;i<e.tracks.length;i++)n.push({id:e.tracks[i].id?e.tracks[i].id:THREE.Math.generateUUID(),src:e.tracks[i].src});var a={track:null,mute:!(!e||"boolean"!=typeof e.mute)&&e.mute,loop:!(!e||"boolean"!=typeof e.loop)&&e.loop,html5:!e||"boolean"!=typeof e.html5||e.html5,autoplay:!e||"boolean"!=typeof e.autoplay||e.autoplay,volume:e&&"number"==typeof e.volume?e.volume:.5},r=null,s=!1,c=!1,l={clientX:0,clientY:0},u=a.volume,d=!1,h=null;this.init=function(){m(),p(),n.length&&o.setTrack(n[0].id),y(),b()},this.getWidget=function(){return o.controls.$widget},this.addTrack=function(e){var e={id:e.id?e.id:THREE.Math.generateUUID(),src:e.src};return n.push(e),e.id},this.setTrack=function(e){var t=o.getTrack(e);return!(!t||a.track&&a.track.id==t.id)&&(a.track=t,u=a.volume,r&&r.unload(),r=new N.Howl({src:[a.track.src],onload:z,onplay:B,onpause:j,onend:Y,onstop:X,onseek:V,loaderror:q,playerror:U,html5:a.html5,loop:a.loop,preload:"metadata",autoplay:!1}),!0)},this.getTrack=function(e){for(var t=0;t<n.length;t++)if(n[t].id==e)return n[t];return null},this.deleteTrack=function(e){for(var t=0;t<n.length;t++)if(n[t].id==e)return n.slice(t,1),!0;return!1},this.isPlaying=function(){return!(s||!r)&&r.playing()},this.skip=function(e){if(a.track&&n.length){for(var t=0;t<n.length&&a.track.id!=n[t].id;t++);switch(e){case"prev":t=t-1<0?n.length-1:t-1;break;case"next":t=t+1<n.length?t+1:0}o.setTrack(n[t].id),o.play()}},this.play=function(){c=!0,s||!r||r.playing()||r.play()},this.pause=function(){!s&&r&&r.playing()&&r.pause()},this.stop=function(){!s&&r&&r.stop()},this.loop=function(e){if(0==arguments.length)return a.loop;a.loop=e,r&&r.loop(e),y()},this.volume=function(e){if(0==arguments.length)return a.volume;a.mute&&0<e&&(a.mute=!1),a.volume=e,N.Howler.volume(e),y()},this.mute=function(e){if(0==arguments.length)return a.mute;(a.mute=e)?(u=a.volume,o.volume(0)):o.volume(u)},this.autoplay=function(e){if(0==arguments.length)return a.autoplay;a.autoplay=e},this.seek=function(e){r&&r.seek(r.duration()*e)},this.destroy=function(){r&&r.unload(),r=null,f(),this.controls={}};var m=function(){o.controls.$widget=ee("<div>").addClass("ipnrm-audio-player"),o.controls.$container=ee("<div>").addClass("ipnrm-container"),o.controls.$toolbar=ee("<div>").addClass("ipnrm-toolbar"),o.controls.$btnPlay=ee("<div>").addClass("ipnrm-btn-play"),o.controls.$btnPrev=ee("<div>").addClass("ipnrm-btn-prev"),o.controls.$btnNext=ee("<div>").addClass("ipnrm-btn-next"),o.controls.$btnLoop=ee("<div>").addClass("ipnrm-btn-loop"),o.controls.$btnVolume=ee("<div>").addClass("ipnrm-btn-volume"),o.controls.$volume=ee("<div>").addClass("ipnrm-volume"),o.controls.$volumeBar=ee("<div>").addClass("ipnrm-volume-bar"),o.controls.$volumeProgress=ee("<div>").addClass("ipnrm-volume-progress"),o.controls.$meta=ee("<div>").addClass("ipnrm-meta"),o.controls.$timeline=ee("<div>").addClass("ipnrm-timeline"),o.controls.$timelineBar=ee("<div>").addClass("ipnrm-timeline-bar"),o.controls.$timelineLoaded=ee("<div>").addClass("ipnrm-timeline-loaded"),o.controls.$timelineProgress=ee("<div>").addClass("ipnrm-timeline-progress"),o.controls.$toolbar.append(o.controls.$btnPlay,o.controls.$btnPrev,o.controls.$btnNext,o.controls.$btnLoop,o.controls.$btnVolume),o.controls.$timeline.append(o.controls.$timelineBar.append(o.controls.$timelineLoaded,o.controls.$timelineProgress)),o.controls.$volume.append(o.controls.$volumeBar.append(o.controls.$volumeProgress)),o.controls.$container.append(o.controls.$toolbar,o.controls.$meta,o.controls.$timeline,o.controls.$volume),o.controls.$widget.append(o.controls.$container)},p=function(){o.controls.$btnPlay.on("click",_),o.controls.$btnPrev.on("click",T),o.controls.$btnNext.on("click",x),o.controls.$btnLoop.on("click",R),o.controls.$btnVolume.on("click",M),o.controls.$btnVolume.on("mouseenter",P),o.controls.$volumeBar.on("click",A),o.controls.$volumeBar.on("mousedown",C),o.controls.$timelineBar.on("mousedown",$),(s=E())&&t.forEach(function(e){document.addEventListener(e,Z)})},f=function(){o.controls.$btnPlay.off("click",_),o.controls.$btnPrev.off("click",T),o.controls.$btnNext.off("click",x),o.controls.$btnLoop.off("click",R),o.controls.$btnVolume.off("click",M),o.controls.$btnVolume.off("mouseenter",P),o.controls.$volumeBar.off("click",A),o.controls.$volumeBar.off("mousedown",C),o.controls.$timelineBar.off("mousedown",$),window.removeEventListener("mousemove",H,!0)},v=function(e,t){var n=t.getBoundingClientRect(),i=1-(e.clientY-n.top)/n.height;return i=i<0?0:1<i?1:i},g=function(e,t){var n=t.getBoundingClientRect(),i=(e.clientX-n.left)/n.width;return i=i<0?0:1<i?1:i},w=function(e,t){var n=e.getBoundingClientRect();return!(t.clientX<n.left||t.clientX>n.right||t.clientY<n.top||t.clientY>n.bottom)},E=function(){try{var e=new(window.AudioContext||window.webkitAudioContext);return"suspended"===e.state}catch(e){var t=new Audio;try{return t.play(),!1}catch(e){return!0}}},y=function(){o.controls.$btnPlay.toggleClass("ipnrm-play",!o.isPlaying()),o.controls.$btnPlay.toggleClass("ipnrm-pause",o.isPlaying()),o.controls.$btnLoop.toggleClass("ipnrm-on",a.loop),o.controls.$btnLoop.toggleClass("ipnrm-off",!a.loop),o.controls.$btnPrev.toggleClass("ipnrm-off",n.length<=1),o.controls.$btnNext.toggleClass("ipnrm-off",n.length<=1),o.controls.$btnVolume.toggleClass("ipnrm-mute",a.mute),o.controls.$btnVolume.toggleClass("ipnrm-off",!a.mute&&0==a.volume),o.controls.$btnVolume.toggleClass("ipnrm-min",!a.mute&&0<a.volume&&a.volume<.5),o.controls.$btnVolume.toggleClass("ipnrm-max",!a.mute&&.5<=a.volume),o.controls.$volume.toggleClass("ipnrm-mute",a.mute),o.controls.$volumeProgress.css({height:100*a.volume+"%"})},b=function(){if(r&&r._html5){var e=r._sounds.length&&r._sounds[0]._node.buffered.length?r._sounds[0]._node.buffered.end(0):0;o.controls.$timelineLoaded.css({width:(e/r.duration()*100||0)+"%"})}try{var t=r.seek()||0;o.controls.$timelineProgress.css({width:(t/r.duration()*100||0)+"%"})}catch(e){o.controls.$timelineProgress.css({width:"0%"})}},_=function(e){o.isPlaying()?o.pause():o.play()},T=function(e){o.skip("prev")},x=function(e){o.skip("next")},R=function(e){o.loop(!o.loop())},M=function(e){o.mute(!o.mute())},P=function(e){o.controls.$volume.addClass("ipnrm-active"),window.addEventListener("mousemove",H,!0),setTimeout(S,500)},H=function(e){l.clientX=e.clientX,l.clientY=e.clientY},S=function(){w(o.controls.$volume.get(0),l)||w(o.controls.$btnVolume.get(0),l)?setTimeout(S,500):(o.controls.$volume.removeClass("ipnrm-active"),window.removeEventListener("mousemove",H,!0))},A=function(e){var t=v(e,o.controls.$volumeBar.get(0));o.volume(t)},C=function(e){e.preventDefault(),window.addEventListener("mousemove",L),window.addEventListener("mouseup",k);var t=v(e,o.controls.$volumeBar.get(0));o.volume(t)},L=function(e){var t=v(e,o.controls.$volumeBar.get(0));o.volume(t)},k=function(e){window.removeEventListener("mousemove",L),window.removeEventListener("mouseup",k);var t=v(e,o.controls.$volumeBar.get(0));o.volume(t)},$=function(e){if(!s&&r){e.preventDefault(),window.addEventListener("mousemove",O),window.addEventListener("mouseup",I),cancelAnimationFrame(h),(d=o.isPlaying())&&r.pause();var t=g(e,o.controls.$timelineBar.get(0));setTimeout(function(){o.controls.$timelineProgress.css({width:100*t+"%"})},100)}},O=function(e){var t=g(e,o.controls.$timelineBar.get(0));o.controls.$timelineProgress.css({width:100*t+"%"})},I=function(e){window.removeEventListener("mousemove",O),window.removeEventListener("mouseup",I);var t=g(e,o.controls.$timelineBar.get(0));if(r._html5){var n=r._sounds.length&&r._sounds[0]._node.buffered.length?r._sounds[0]._node.buffered.end(0):0,i=n/r.duration();t=t<i?t:i}o.controls.$timelineProgress.css({width:100*t+"%"}),o.seek(t),d&&o.play()},D=function(e){b(),r.playing()&&(h=requestAnimationFrame(D))},F=function(){b()},z=function(){var e=a.mute;o.volume(a.volume),o.mute(e),o.loop(a.loop),a.autoplay&&o.play(),r._html5&&r._sounds.length&&r._sounds[0]._node.addEventListener("progress",F)},B=function(){y(),h=requestAnimationFrame(D)},j=function(){y()},Y=function(){a.loop||(a.autoplay?o.skip("next"):o.stop())},X=function(){y()},V=function(){h=requestAnimationFrame(D)},q=function(){y()},U=function(){y()},Z=function(){s=!1,c&&o.play(),t.forEach(function(e){document.removeEventListener(e,Z)})};o.init()},F.Widget=F.Widget||{},F.Widget.Default=z,F.Widget.Simple=M})((e=e||self).IPANORAMA=e.IPANORAMA||{})}(this);